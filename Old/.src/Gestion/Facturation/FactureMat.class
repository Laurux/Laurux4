' Gambas class file

'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à  " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA

'################################################
'# Nom du fichier           : FactureMat.class
'# Auteur                   : Jacky Tripoteau
'# Date de création         : 01/02/2009
'# Gestion de la facturation pour le matériel
'################################################
'
hForm As FCalc
Factbl[10] As String
Motable[4] As String
n As Integer
Nv As Integer
Nbl As Integer
T As Integer ' Flag qui determine le message a afficher en cas de modif de prix
Tp As String
Tri As String
Tribl As String
tabmo As String
tab As String
Tab2 As String
Tab3 As String
Tab4 As String
Tab5 As String
Tab6 As String
sel As String
arr As String
Atype As String
typeL As String
Cdivers As String
Nlgn As String
Nbd As String
Nbdec As String
Totalmo As String
Totalart As String
Totalrem As String
Totalmottc As String
Totalartttc As String
Totalremttc As String
Totalht As String
Totalttc As String
Colvente As Float ' variable pour Colisage de vente
PVHT2 As Float ' Variable pour le prix de vente du colisage
Ttva As Float
Tx As Float
B As Integer = 0
ChkFocus As Integer = 2 'gère la perte de focus. 0 gestion normale, 1 gestion suite à modif, 2 gestion bloquée pour faire une recherche (clic sur togglebutton 2)
Chkf As Integer = 0
Nvc As Integer
ye2 As Integer
dte As String
dte2 As String
dte3 As String
Nfac As String
rResult As Result
Rligbl As Result
Filename As String
Jour As String
Jnl As String
Intit As String
numecr As String
numr As Integer ' Numero ecriture provisoire
numr2 As Integer ' numero ecriture définitif
Cpt As String
CptRem As String
Ctva As String
Ctx As String
Cpttva As String
IntitTva As String
Txtleg As String
Txtleg2 As String
numeroFac As String
Remmo As String
Remart As String
Stk As Boolean
Ecotaxe As Boolean
Valeur_ecotaxe As Float
Taxepv As Boolean
Valeur_Copp As Float
son As Integer = Start.Son
Tva550 As Integer
Codetva As String
Artdsg2 As String
dateech As String
Impfac As Integer ' Flag pour savoir si la facture à été imprimée
qteecot As Float
Bloc As String
Ardi As String
Paht As String
Pmp As String
Codeart As String
Nvart As String ' Flag pour savoir s'il s'agit d'un nouveau produit
Modif As String ' Flag pour savoir si la ligne est en modification
NlgModif As String ' Flag pour récuperer le numéro de ligne modifiée
qte_Cbarre As String = "0" 'Flag pour saisie des quantités en lecture code barre par F9
Imp As String ' Impression facture
Editfac As String ' Flag pour savoir si on peut imprimer la facture
Nmfac As String ' Numéro de facture si facture déjà imprimée
Dfac As String ' Date de facture si facture déjà imprimée
CoulB As Integer ' Variable pour la couleur du background
CoulF As Integer ' Variable pour la couleur du Foreground
Fnt As String ' Variable pour la police
ChangePu As String ' flag bruht pour art
ChangeB As String ' flag bruht pour mo
ChangeP As String ' flag puht net pour mo et art
ChangeTx As String ' flag Txhr pour mo
ChangeR As String ' Flag pour Rem pour mo et art
ChangeT As String ' Flag pour Nettc pour mo et art
ChangeTm As String ' Flag pour Temps/montant Mo
Numfac As String ' utilisé pour archivage facture
Dtefac As String ' utilisé pour archivage facture
Ech As String ' utilisé pour archivage facture
Val_retro As String ' variable pour coeff retrocession
Prg As String
Typec As String ' Type client pour remises par type client
RemType As String ' montant de la remise pour le produit selectionné et le type client
Dbl As String
Tabcli As String
' [GB2:ARRD] Private Rms As String[6, 3] ' Tableau des remises quantitatives
Private Rms As New String[6, 3] ' Tableau des remises quantitatives
Mrgart As Float = 0
Mrgmo As String
PosY As Integer
Visudoc As Boolean
Devises As String
Coulfond As New String[]
Rs2 As String
Artbarre As String
Private $Desc As Boolean
pdx As String
Gmateriel As Boolean 'si gestion du materiel dans les preferences
Materiel As Boolean ' si le produit est un materiel
Produit As String
Blocnum As String
Numligbl2 As String
Mnetht As String
Mnettc As String
Lbarre As Integer = 0 'permet de savoir si on fait une lecture code barre dans coldetail
Majnumserie As Integer = 1
Comclick As Integer = 0
l5 As String = "" ' valeur de la derniere ligne du bloc selectionné
Nlgapp As String ' flag pour récupéré le numéro de ligne à modifier
Impcar As Boolean ' flag pour impression des caractéristiques
Promo As Boolean = False
Cpromo As String ' code promo en cours
Apromo As Boolean 'flag pour savoir si le produit est en promo
pNet As Boolean = False 'flag pour savoir si on gère la mention "Net" en remise
PrvtMo As Float
TxhtMo As Float
Private spiece As String
Private Proform As String = Start.Proform
Private Commande As String = Start.Commande
Private Devis As String = Start.Devis
Private Bon As String = Start.Bon
Private Facture As String = Start.Facture
Private pdf As Cdocuments
Public Bsel As Boolean = False
Public Codearticle As String
Public CodeClient As String
Private hColbl As Boolean = False
Public Codepostal As String
Public Bureaudistributeur As String
Private Tcoeff As Float = 0
Private TvaCli As String
Private encours As String
Private soldecompte As Float
Private $crst As String

'**********************************************************
'*initialisation écrans et gestion onglet client          *
'**********************************************************
Public Sub _New()
  
  Dim Frmt As New String[]
  
  Tab = "Fiches_Parametres" 
  rResult = Utils.db.Exec("SELECT * FROM " & tab & "")
  If rResult.Available Then
    Val_retro = rResult!coretro
    devises = rResult!devise
    If IsNull(devises) Then devises = "Euros"
  Endif
  Try Gmateriel = Settings["/Soc" & Start.Societe & "/Materiel"]
  If Error Then Gmateriel = False
  'IF NOT Gmateriel THEN
  '  Panel8.Delete
  '  Tabstrip1.Count = 1
  'ENDIF
  Tabcli = "Fiches_Cli" 
  
  Try Tva550 = Settings["/Soc" & Start.Societe & "/Tva550"]
  If Tva550 Then
    Codetva = Settings["/Soc" & Start.Societe & "/Codetva"]
  Else
    tvar.Visible = False
  Endif
  If Not Settings["/Soc" & Start.Societe & "/Gestion"] Then
    ToggleButton7.Visible = True
    Solde.Visible = True
    TextLabel37.Visible = True
  Endif
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  Frmt = Utils.FColr(Settings["/Coul/Fnets"])
  Coulfond = Utils.Coulfd()
  Artqte.Text = "1,00"
  Music.Load(Start.Musique)
  Balloon.delay = 2000
  If Settings["/Soc" & Start.Societe & "/Poids"] <> "0" Then
    TextLabel65.Visible = True
    PdxArt.Visible = True
    TextLabel64.Visible = True
    Poids.Visible = True
  Else
    HPanel1.Width = 720
  Endif
  If Not IsNull(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) And If Settings["/Soc" & Start.Societe & "/CodeVendeur"] <> "0" Then
    sVendeur.Text = Mid$(Settings["/Soc" & Start.Societe & "/CodeVendeur"], 3, Len(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) - 2)
    TextLabel69.Text = "Vendeur connecté"
  Else
    TextLabel69.Text = ""
  Endif
  Me.Center
  n = 1
  T = 0
  Modif = 0
  Tp = "B"
  Prg = "1"
  Tri = "cli_nom"
  Visudoc = False
  With Colbl
    .Columns.count = 9
    .Columns[0].Width = 1
    .Columns[1].Width = 20
    .Columns[2].Width = 120
    .Columns[2].Title = "N° Bl"
    .Columns[3].Width = 80
    .Columns[3].Title = "Date"
    .Columns[4].Width = 80
    .Columns[4].Title = "Code"
    .Columns[5].Width = 286
    .Columns[5].Title = "Nom client"
    .Columns[6].Width = 176
    .Columns[6].Title = "Prénom client"
    .Columns[7].Width = 112
    .Columns[7].Title = "N° facture"
    .Columns[8].Width = 16
    
  End With
  CleanArt()
  Coldetail.Columns.count = 10
  Coldetail.Columns[0].Width = 50
  Coldetail.Columns[2].Alignment = Align.Left
  Coldetail.Columns[1].Width = 140
  Coldetail.Columns[2].Width = 350
  Coldetail.Columns[3].Width = 92
  Coldetail.Columns[4].Width = 60
  Coldetail.Columns[5].Width = 92
  Coldetail.Columns[6].Width = 55
  Coldetail.Columns[7].Width = 92
  Coldetail.Columns[8].Width = 92
  Coldetail.Columns[9].Width = 30
  Coldetail.Columns[0].Text = "N° Lg"
  Coldetail.Columns[1].Text = "Code"
  Coldetail.Columns[2].Text = "Désignation"
  Coldetail.Columns[3].Alignment = 2
  Coldetail.Columns[3].Text = "Px Unitaire"
  Coldetail.Columns[4].Alignment = 2
  Coldetail.Columns[4].Text = "Qté/Tps"
  Coldetail.Columns[5].Alignment = 2
  Coldetail.Columns[5].Text = "Px brut"
  Coldetail.Columns[6].Alignment = 2
  Coldetail.Columns[6].Text = "Remise"
  Coldetail.Columns[7].Alignment = 2
  Coldetail.Columns[7].Text = "Px net"
  Coldetail.Columns[8].Alignment = 2
  Coldetail.Columns[8].Text = "Px TTC"
  Coldetail.Columns[9].Alignment = 3
  Coldetail.Columns[9].Text = "TL"
  solde.Text = "0,00"
  
  'SetObservers(ME, ME)
  tribl = "numbl"
  TextLabel47.Text = Settings["/Soc" & Start.Societe & "/Taxe"]
  TextLabel50.Text = Settings["/Soc" & Start.Societe & "/Taxe"]
  TextLabel94.Text = Settings["/Soc" & Start.Societe & "/Taxe"]
  
End

Public Sub Form_Open()
  
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabPromo") & " where datedeb <= &1 and datefin >= &1", Format$(Now, "yyyy-mm-dd"))
  If rResult.Available Then
    Promo = True
    Cpromo = rResult!code
  Endif
  Colbl.Clear
  If $Desc = False Then
    Deb1()
  Else
    Deb2()
  Endif
  If Settings["/Soc" & Start.Societe & "/MoArt"] Then
    Motm_Click()
  Else
    If Settings["/Soc" & Start.Societe & "/ComArt"] Then
      Com_Click()
    Else
      BArt_Click()
    Endif
  Endif
  Imp = "0"
  Coldetail.MoveLast()
  Try Coldetail.Item.Selected = True
  If Not Error Then
    Nlg.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Else
    Nlg.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  ChkFocus = 2
  Button13.Visible = True
  Button24.visible = True
  CodeP.Readonly = True
  Desg.ReadOnly = True
  Desg2.ReadOnly = True
  Marque.ReadOnly = True
  Typemat.ReadOnly = True
  Code.SetFocus
  
End

Public Sub Colbl_ColumnClick(Column As Integer)
  
  $Desc = Not $Desc
  If column = 2 Then Tribl = "numbl"
  If column = 3 Then tribl = "datebl"
  If column = 4 Then tribl = "cdclibl"
  If column = 5 Then tribl = "nmclibl"
  If column = 6 Then tribl = "pnmclibl"
  If column = 7 Then tribl = "numfac"
  If $Desc = True Then
    deb2
  Else
    Deb1
  Endif
  
End

Public Sub Colbl_Data(Row As Integer, Column As Integer)
  
  Dim Frmt As New String[]
  
  With Utils
    ChkFocus = 2
    Factbl[0] = "imp"
    Factbl[1] = "type"
    Factbl[2] = "numbl"
    Factbl[3] = "datebl"
    Factbl[4] = "cdclibl"
    Factbl[5] = "nmclibl"
    Factbl[6] = "pnmclibl"
    Factbl[7] = "numfac"
    .rs3.MoveTo(Row)
    Try Colbl.data.Text = Str(.rs3[Factbl[Column]])
    If column = 1 Then
      Select Case Str(.rs3[Factbl[1]])
        Case "F"
          If Str(.rs3[Factbl[0]]) = "1" Then
            Frmt = Utils.FColr(Facture)
            Try CoulB = Val(Frmt[0])
            Try CoulF = Val(Frmt[2])
            Try Fnt = Frmt[1]
          Else
            Frmt = Utils.FColr(Bon)
            Try CoulB = Val(Frmt[0])
            Try CoulF = Val(Frmt[2])
            Try Fnt = Frmt[1]
          Endif
        Case "B"
          Frmt = Utils.FColr(Bon)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
        Case "A"
          Frmt = Utils.FColr(Commande)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
        Case "D"
          Frmt = Utils.FColr(Devis)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
        Case "P"
          Frmt = Utils.FColr(Proform)
          Try CoulB = Val(Frmt[0])
          Try CoulF = Val(Frmt[2])
          Try Fnt = Frmt[1]
      End Select
    Endif
    If Error Then
      If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then
        CoulB = Val("&HFAFAFA&")
      Else
        CoulB = Val("&HF9F9BD&")
      Endif
      CoulF = Val("&H000000&")
      Fnt = "serif 10"
    Endif
    Colbl.Data.Background = CoulB
    Colbl.Data.Foreground = CoulF
    Colbl.Data.Font = Font[Fnt]
    If Column = 3 Then
      Colbl.data.Text = Replace$(Colbl.data.Text, "/", ".")
      Colbl.data.Text = Left$(Colbl.data.Text, 6) & Mid$(Colbl.data.Text, 7, 4)
    Endif
  End With
  
End

Public Sub Deb2()
  
  Tab = "Fiches_BlM" 
  Utils.Base3(Colbl, "select * from " & Tab & " order by " & tribl & " asc")
  
End

Public Sub Deb1()
  
  Tab = "Fiches_BlM" 
  Utils.Base3(Colbl, "select * from " & Tab & " order by " & tribl & " desc")
  
End

Public Sub Refresh()
  
  Form_Open()
  
End

Public Sub CleanChamps()
  
  num.Clear
  Datej.Clear
  Code.Clear
  Code3.Clear
  Cv.Clear
  Nom.Clear
  Pnm.Clear
  Adr1.Clear
  Adr2.Clear
  Cp.Clear
  Burd.Clear
  Telbur.Clear
  Teldom.Clear
  Telport.Clear
  Divers.Clear
  Totht1.Text = "0,00"
  Totva1.Text = "0,00"
  Tottc1.Text = "0,00"
  Txmo.Text = "0,00"
  Txpieces.Text = "0,00"
  solde.Text = "0,00"
  Totalmo = "0,00"
  Totalart = "0,00"
  Totalrem = "0,00"
  Totalmottc = "0,00"
  Totalart = "0,00"
  Totalartttc = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Mrg.Text = "0,00"
  Exo.Value = False
  Majc.Value = False
  tvar.Value = False
  Retro.value = False
  Marge.Text = "0,00"
  MargeMo.text = "0,00"
  Mrgmo = "0,00"
  Mrgmo = 0
  Mrgart = 0
  acpt.Clear
  Macompte.Clear
  Apromo = False
  Courriel.Clear
  
End

Public Sub ChkPrx()
  
  If InStr("0123456789,.", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif
  
End

'**********************************************************
'*      Gestion des touches sur le panel Entete           *
'**********************************************************
Public Sub Entete_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    
    Select Case Last.tag
        
      Case 1
        QuitteDate()
        If b <> "1" Then
          Code.SetFocus
          Code.Select
        Else
          Datej.SetFocus
          Datej.Select
          b = "0"
        Endif
        Stop Event
        
      Case 2
        If Impfac <> "1" And Not IsNull(code.text) Then
          compteman()
          If Val(solde.Text) > 0 Then
            code.Background = &HF51B03&
          Else
            Code.Background = Color.TextBackground
          Endif
          If b <> 1 Then
            Cv.SetFocus
            Cv.Select
          Else
            b = 0
            Code.SetFocus
            Code.Select
          Endif
          Stop Event
        Endif
        
      Case 3
        Nom.SetFocus
        Nom.Select
        Stop Event
        
      Case 4
        If Code.Text = "" Then
          If Son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir votre client Svp ", "Ok")
          b = 1
        Endif
        If b <> 1 Then
          Pnm.SetFocus
          Pnm.Select
        Else
          b = 0
          Code.SetFocus
          Code.Select
        Endif
        Stop Event
        
      Case 5
        Adr1.SetFocus
        Adr1.Select
        Stop Event
        
      Case 6
        Adr2.SetFocus
        Adr2.Select
        Stop Event
        
      Case 7
        Cp.SetFocus
        Cp.Select
        Stop Event
        
      Case 8
        Cpman()
        Stop Event
        
      Case 9
        If Cdivers Then 
          Button13.SetFocus
        Else
          Telbur.SetFocus
          Telbur.Select
        Endif
        Stop Event
        
      Case 10
        Teldom.SetFocus
        Teldom.Select
        Stop Event
        
      Case 11
        Telport.SetFocus
        telport.Select
        Stop Event
        
      Case 12
        Txmo.SetFocus
        txmo.Select
        Stop Event
        
      Case 13
        Txpieces.SetFocus
        Txpieces.Select
        Stop Event
        
      Case 14
        Code.SetFocus
        Code.Select
        Stop Event
        
    End Select
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.F2 Then
    Select Case Last.tag
      Case 1
        RdimColbl()
        Stop Event
        
      Case 2
        SelectionClient()
        Stop Event
        
      Case 8
        ToggleButton8_Click()
        
      Case 15
        'ToggleButton5_Click()
        Stop Event
        
    End Select
  Endif
  If Key.code = Key.F5 Then
    ConVendeurs.ShowModal()
    If Settings["/Soc" & Start.Societe & "/CodeVendeur"] = "" Then
      sVendeur.Text = ""
      TextLabel70.Text = ""
    Else
      sVendeur.Text = Mid$(Settings["/Soc" & Start.Societe & "/CodeVendeur"], 3, Len(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) - 2)
      TextLabel70.Text = "Vendeur connecté"
    Endif
  Endif
  
End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Entete_GotFocus()
  
  With Utils
    .SetEditColor(Me, Last)
  End With
  num.Background = &HD4D0C8&
  If Val(solde.Text) > 0 And Settings["/Soc" & Start.Societe & "/Gestion"] <> "0" Then
    code.Background = &HF51B03&
  Else
    code.Background = Color.TextBackground
  Endif
  
End

Public Sub Verif_Encours()
  
  If encours > "0" Then
    If Soldecompte >= Val(utils.cpoint(encours)) Then
      If Message.Question("Attention ! L'encours de ce client est dépassé.\nVoulez-vous continuer ?", "Oui", "Non") = 2 Then
        Raz_client()
      Endif
    Else
      b = 0
    Endif
  Else
    b = 0
  Endif
  
End

Public Sub Raz_client()
  
  code.Clear
  Nom.Clear
  Pnm.Clear
  num2.Clear
  Nm.Clear
  Adr1.Clear
  Adr2.Clear
  Cp.Clear
  Burd.Clear
  Telbur.Clear
  Teldom.Clear
  Telport.Clear
  Divers.Clear
  Txmo.Clear
  Txpieces.Clear
  Encours = "0"
  solde.Text = Format$("0", "0.00")
  Solde.Background = Color.TextBackground
  code.SetFocus
  b = 1
  
End

'**********************************************************
'*       Gestion des boutons du columnview Entete          *
'**********************************************************
Public Sub Btn_Click()
  
  Dim iskey As Integer = 0
  
  Select Case Last.tag
      
    Case 1
      Button7_Click()
      
    Case 2
      
    Case 3
      button2_click()
      
    Case 4
      Bl_Suppr()
      
    Case 5
      button4_click()
      
    Case 6
      If Exist(filename) Then Try Kill filename
      CleanChamps()
      Me.Close
      
    Case 7
      
      If num.Text = "" Then
        ChkFocus = 2
        Dsg2.SetFocus
        If Son Then
          Music.Play
        Endif
        Try Message.Warning("Aucune sélection en cours !", "OK")
      Else
        If datej.text = "" Then
          If Son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir la date du bon avant de saisir les lignes de détail !", "OK")
          datej.SetFocus
          datej.Select
        Else
          If Not Code.Text Then
            If Son Then
              Music.Play
            Endif
            Try Message.Warning("Veuillez saisir un code client Svp ", "Ok")
            Code.SetFocus
            Code.Select
          Else
            If Not Nom.Text Then
              If Son Then
                Music.Play
              Endif
              Try Message.Warning("Veuillez saisir un nom pour votre client Svp ", "Ok")
              Nom.SetFocus
              Nom.Select
            Else
              If IsNull(Numserie.Text) Then
                If Son Then
                  Music.Play
                Endif
                Try Message.Warning("Veuillez saisir un matériel Svp ! ", "Ok")
              Else
                'Utils.db.Exec("UNLOCK TABLES")
                Motm.Value = False
                Com.Value = False
                Panel5.Visible = True
                If Tp = "B" Or If Tp = "F" And ImpFac <> "1" Then Maj_Quantite2()
                Button4_Click()
                If Not IsNull(Settings["/Soc" & Start.Societe & "/CodeVendeur"]) And Coldetail.count = 0 Then
                  Com.Value = True
                  Intitule.text = "Vous avez été servi par " & sVendeur.Text
                  Enrg_Ligcom()
                Endif
                If Settings["/Soc" & Start.Societe & "/MoArt"] Then
                  Motm.Value = True
                  Motm_Click()
                Else
                  If Settings["/Soc" & Start.Societe & "/ComArt"] Then
                    Com.Value = True
                    Com_Click()
                  Else
                    BArt.Value = True
                    BArt_Click()
                  Endif
                Endif
                b = 0
                Cart.SetFocus
              Endif
            Endif
          Endif
        Endif
      Endif
      
    Case 8
      chkfocus = 2
      If Tp = "B" Or Tp = "F" And ImpFac <> "1" Then Maj_Quantite()
      Razmo()
      Cleanart()
      Comcode.Text = ""
      Nlgcom.Text = ""
      intitule.Text = ""
      Tot_Remises()
      Button4_Click()
      $desc = False
      deb1()
      Colbl.SetFocus
      If Nv <> 1 Then
        Repeat
          Colbl.MoveTo(iskey, 0)
          Inc iskey
        Until colbl[colbl.row, 2].Text = num.text
      Else
        Colbl.MoveTo(0, 0)
        Nv = 0
      Endif
      Panel5.Visible = False
      
    Case 9
      If num.Text = "" Or Code.Text = "" Then
        If Son Then
          Music.Play
        Endif
        Try Message.Warning("Votre bon n'est pas numeroté ou vous n'avez pas saisi de code client !", "OK")
      Else
        If Coldetail.Count = 0 And BFac.value = True Or If Coldetail.Count = 0 And Bbon.Value = True Or If Coldetail.Count = 0 And Bprof.value = True Then
          If Son Then
            Music.Play
          Endif
          Try Message.Warning(" Impression impossible, aucune ligne n'a été saisie !", "Ok")
        Else
          If Tp = "A" Then Button4_Click()
          Button14.Enabled = True
          Bl_Edit()
        Endif
      Endif
      
    Case 10
      
    Case 11
      
    Case 12
      Button12_Click()
      
    Case 17
      Button17_Click()
      
  End Select
  
End

'**********************************************************
'*       Gestion du click sur radiobutton Motm            *
'**********************************************************
Public Sub Motm_Click()
  
  ChkFocus = 2
  Panel2.visible = True
  Panel3.Visible = False
  Panel4.visible = False
  Razmo()
  Colmo.Visible = False
  HBox8.Visible = False
  Colmo.clear
  Colcom.Clear
  Colcom.visible = False
  ' On récupère le dernier numéro de ligne
  Coldetail.MoveLast()
  Try Coldetail.Item.Selected = True
  If Not Error Then
    Nlg.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Else
    Nlg.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.Item.Selected = True
    If Not Error Then
      If Coldetail.Current[0] = Nlgapp Then Break
    Endif
  Until Coldetail.MoveNext()
  Rem.Text = Txmo.Text
  typeL = "M"
  Cmo.Select
  Cmo.SetFocus
  n = 1
  chkfocus = 2
  Modif = "0"
  
End

'********************************************************************
'* Gestion du click sur radiobutton Art pour tous les articles      *
'********************************************************************
Public Sub BArt_Click()
  
  ChkFocus = 2
  Panel2.visible = False
  Panel3.Visible = True
  Panel4.visible = False
  Colmo.Visible = False
  HBox8.Visible = False
  Colmo.clear
  Colcom.Clear
  Colcom.visible = False
  Cleanart()
  Coldetail.MoveLast()
  Try Coldetail.Item.Selected = True
  If Not Error Then
    Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Else
    Nlgart.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.Item.Selected = True
    If Not Error Then
      If Coldetail.Current[0] = Nlgapp Then Break
    Endif
  Until Coldetail.MoveNext()
  Artrm.Text = Txpieces.Text
  typeL = "A"
  Cart.SetFocus
  Cart.Select
  N = 1
  Modif = "0"
  ChkFocus = 2
  
End

'*******************************************************************
'* Gestion du click sur radiobutton Art pour les articles en stock *
'*******************************************************************
Public Sub B2Art_Click()
  
  BArt_Click()
  
End

'**********************************************************
'*       Gestion du click sur radiobutton Com             *
'**********************************************************
Public Sub com_Click()
  
  Dim l As String
  
  Panel2.visible = False
  Panel3.Visible = False
  Panel4.Visible = True
  Comcode.Text = ""
  Nlgcom.Text = ""
  intitule.Text = ""
  Colmo.Visible = False
  HBox8.Visible = False
  Colmo.clear
  Colcom.Clear
  Colcom.visible = False
  l = coldetail.Key
  Coldetail.MoveLast()
  Try Coldetail.Item.Selected = True
  If Not Error Then
    Nlgcom.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Else
    Nlgcom.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  typeL = "C"
  If Comclick = 1 Then
    Coldetail.MoveFirst()
    While Coldetail.Key <> (Format$(Val(l), "0000"))
      Coldetail.MoveNext()
      Try Coldetail.Item.Selected = True
      If (Format$(Val(Coldetail.key), "0000")) = (Format$(Val(l), "0000")) Then Break
    Wend
  Endif
  Comclick = 0
  Comcode.SetFocus
  Comcode.Select
  N = 1
  chkfocus = 2
  
End

'**********************************************************
'*       Gestion du click sur bouton "Nouveau"            *
'**********************************************************
Public Sub Button2_Click()
  
  CleanChamps()
  CleanChampsMat()
  modif = "0"
  Tab = "Fiches_Parametres" 
  Tab2 = "Fiches_BlM" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    num.Text = rResult!dnbon
  Endif
  Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab2 & " WRITE")
  If num.Text = "" Then num.Text = "000000"
  num.Text = Val(num.Text) + 1
  num.Text = Format$(num.Text, "000000")
  num2.Text = num.Text
  Datej.Text = Format$(Now, "dd.mm.yyyy")
  rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " where numbl = &1", num.text)
  If rResult.Available Then
    Try Message.Warning("Création impossible ce numéro de BL est déjà attribué")
    Num.text = ""
    Coldetail.Clear
  Else
    Nv = 1
    Nvc = 0
    ' on met a jour les parametres
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnbon = &1", num.Text)
    datej.SetFocus
    datej.Select
    Coldetail.Clear
    Button8.Visible = False
    Button6.Visible = True
    Impfac = "0"
    Bbon.value = True
    Utils.db.Exec("UNLOCK TABLES")
    button4_click()
    $desc = False
    deb1()
    Colbl.MoveTo(0, 0)
  Endif
  If Settings["/Soc" & Start.Societe & "/AutoEnt"] Then
    Exo.Value = True
    Exo.Enabled = False
  Endif
  If Settings["/Soc" & Start.Societe & "/Factdef"] Then
    BFac.value = True
  Else
    If Settings["/Soc" & Start.Societe & "/Bldef"] Then
      Bbon.value = True
    Else
      If Settings["/Soc" & Start.Societe & "/Devisdef"] Then
        Bdevis.value = True
      Endif
    Endif
  Endif
  Nv = 0
  CodeP.Readonly = True
  Desg.ReadOnly = True
  Desg2.ReadOnly = True
  Marque.ReadOnly = True
  Typemat.ReadOnly = True
  
End

'**********************************************************
'*       Gestion du click sur Bouton "Enregistrer"        *
'**********************************************************
Public Sub Button4_Click()
  
  Dim collectif As String
  Dim Colcpt As String
  Dim type As String
  Dim copie As String = Settings["/Soc" & Start.Societe & "/Pdf"]
  Dim iskey As Integer = 0
  
  tribl = "numbl"
  type = "C"
  If Not IsNull(num.Text) Then
    If Bbon.Value Then Tp = "B"
    If Bdevis.Value Then Tp = "D"
    If Bprof.Value Then Tp = "P"
    If BFac.Value Then Tp = "F"
    If Bfat.Value Then Tp = "A"
    With utils
      Tab = "Fiches_BlM" 
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numbl = &1", num.text)
      If rResult.Available Then
        Utils.db.Exec("UPdate  " & Tab & "  SET  numbl = &1, datebl = &2, cdclibl =&3,  nmclibl = &4, rmobl = &5, rartbl = &6, type = &7, pnmclibl = &8, adr1bl =&9, adr2bl =&{10}, cpbl =&{11}, villebl =&{12}, exobl = &{13}, cvclibl =&{14}, tvar = &{15}, totalht = &{16}, acpt = &{17}, mreg = &{18}, retro = &{19}, marge_art = &{20}, remmobl = &{21}, remartbl = &{22}, marge_mo = &{23}, numserie = &{24}, codep = &{25}, desg1 = &{26}, desg2 = &{27}, marque = &{28}, typemat = &{29} WHERE numbl = &1", num.Text, .Cdate_Dbase(datej.Text), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, tvar.Value, .PointBase(Totht.Text), .PointBase(acpt.Text), .PointBase(Regmt.Text), Retro.value, .PointBase(Mrgart), .PointBase(Remmo), .PointBase(Remart), .PointBase(Mrgmo), Numserie.Text, CodeP.Text, desg.Text, desg2.Text, marque.text, typemat.text)
      Else
        Utils.db.Exec("INSERT INTO " & Tab & "(numbl,datebl,cdclibl, nmclibl, rmobl, rartbl, type, pnmclibl, adr1bl, adr2bl, cpbl, villebl, exobl, cvclibl, tvar, Imp, acpt, mreg, totalht, retro, marge_art, remmobl, remartbl, marge_mo, numserie, codep, desg1, desg2, marque, typemat) VALUES (&1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15}, &{16}, &{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26}, &{27}, &{28}, &{29}, &{30})", num.Text, .Cdate_Dbase(datej.Text), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, tvar.Value, 0, .PointBase(acpt.Text), .PointBase(Regmt.Text), .PointBase(Totht.Text), retro.value, .PointBase(Mrgart), .PointBase(Remmo), .PointBase(Remart), .PointBase(Mrgmo), Numserie.Text, CodeP.Text, desg.Text, desg2.Text, marque.Text, typemat.text)
      Endif
      Tab = "Fiches_EntMat" 
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numserie = &1 and codep = &2 and numbl = &3", Numserie.Text, CodeP.Text, num.text)
      If rResult.Available Then
        Utils.db.Exec("UPdate  " & Tab & "  SET  numserie = &1, codep = &2, numbl =&3, libelle = &4 WHERE numserie = &1 and codep = &2 and numbl = &3", Numserie.Text, CodeP.Text, Num.Text, LibelleMat.Text)
      Else
        Try Utils.db.Exec("INSERT INTO " & Tab & "(numserie, codep, numbl, libelle) VALUES (&1,&2,&3,&4)", Numserie.Text, CodeP.Text, Num.Text, LibelleMat.Text)
      Endif
      Tab = "Fiches_Cli" 
      Tab3 = "Fiches_Comptes" 
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where cli_code = &1", Code.text)
      If rResult.Available Then
        If Majc.Value And nvc <> 1 Then ' si le client existe et que le bouton Majc est coché alors on met a jour la table des comptes
          Utils.db.Exec("UPdate  " & Tab & "  SET  cli_nom = &2, cli_pnm = &3, cli_adr1 = &4, cli_adr2 = &5, cli_cd_ptl =&6, cli_ville =&7, cli_tel_bur = &8, cli_tel_dom = &9, cli_pble = &{10}, cli_obs = &{11}, cli_rmo =&{12}, cli_rart =&{13}, cli_rs_soc=&{14}, cli_exo=&{15} WHERE cli_code = &1", code.Text, nom.Text, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Telbur.Text, Teldom.Text, Telport.Text, Divers.Text, Txmo.Text, Txpieces.Text, Cv.Text, Exo.Value)
          Utils.db.Exec("UPdate " & Tab3 & " SET intitule_cc = &2 WHERE compte_cc = &1", Code.Text, Nom.Text)
        Else
          If nvc = 1 Then
            If Son Then
              Music.Play
            Endif
            Try Message.Error("Création impossible, ce code client existe déjà !")
            nvc = 0
            Return
          Endif
        Endif
      Else
        If Nvc = 1 Then ' si c'est un nouveau client on met a jour la table des comptes
          rresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabComptes") & " where coll = '1' order by cast(compte_cc AS char)")
          If rresult.Available Then
            Repeat
              Colcpt = rresult!compte_cc
              If Left$(Colcpt, 2) = Left$(Code.Text, 2) Then collectif = Colcpt
            Until rresult.MoveNext()
          Endif
          Utils.db.Exec("insert into " & Cbase.Table("TabComptes") & " (compte_cc,intitule_cc,type_cc,coll,coll_cc, solde,cent_cc,comptr_cc, gen_tv, gen_ta, soldep, lettrable) values ( &1,&2,&3,&4,&5,&6,&7,&8,&9,&{10},&{11},&{12})", Code.Text, Nom.Text, "C", 0, collectif, 0, 0, 0, 0, 0, 0, True)
          Utils.db.Exec("INSERT INTO  " & Tab & "  (cli_code, cli_nom, cli_pnm, cli_adr1, cli_adr2, cli_cd_ptl, cli_ville, cli_tel_bur, cli_tel_dom, cli_pble, cli_obs, cli_rmo, cli_rart, cli_rs_soc, cli_exo, cli_collectif , cli_cdech, cli_email, cli_actif, cli_copie) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20})", code.Text, nom.Text, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Telbur.Text, Teldom.Text, Telport.Text, Divers.Text, Txmo.Text, Txpieces.Text, Cv.Text, Exo.Value, collectif, "00", Courriel.Text, "0", Copie)
        Endif
      Endif
      Enrgcp.Ecp(Cp.Text, Burd.Text)
      Tab = "Fiches_Parametres" 
      If Nvc = 1 Then ' si c'est un nouveau client on met a jour les parametres
        Utils.db.Exec("UPDATE  " & Tab & "  SET  dnc = &1", Code.Text)
      Endif
    End With
    ' sKey = Colbl.row
    ' Colbl.Clear
    'form_Open()
    If Nv <> 1 Then
      Try colbl[colbl.row, 3].Text = Left$(Datej.Text, 6) & Right$(Datej.Text, 2)
      Try colbl[colbl.row, 4].Text = Code.Text
      Try colbl[colbl.row, 5].Text = Nom.Text
      Try colbl[colbl.row, 6].Text = Pnm.Text
      If $Desc = False Then
        Deb1()
      Else
        Deb2()
      Endif
    Endif
    If Nv <> 1 Then
      Repeat
        Colbl.MoveTo(iskey, 0)
        Inc iskey
      Until colbl[colbl.row, 2].Text = num.text
    Else
      Colbl.MoveTo(0, 0)
      Nv = 0
    Endif
    Code3.text = code.Text
    Nm.Text = Nom.Text
    'Else
    'If IsNull(Code.text) Then Balloon.Warning("Veuillez saisir un client avant d'enregistrer votre document SVP !", Code)
  Endif
  Nvc = 0
  B = 0
Catch
  Me.Mouse = Mouse.Default
  Music.Play
  message.Error(Error.Text & " " & Error.where)
  
End

'**************************************************
'*    Gestion des commentaires ( dossier vide )   *
'**************************************************
Public Sub button6_Click()
  
  Tab5 = "Fiches_Cli" 
  
  If Not divers.Visible Then
    Divers.Visible = True
  Else
    divers.Visible = False
    Utils.db.Exec("UPDATE  " & Tab5 & "  SET  cli_obs = &2 WHERE cli_code = &1", Code.Text, Divers.Text)
    If Len(Divers.Text) <> 0 Then
      Button8.Visible = True
      Button6.Visible = False
    Else
      Button8.Visible = False
      Button6.Visible = True
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'******************************************************
'*  Gestion des commentaires ( dossier mouvementé )   *
'******************************************************
Public Sub button8_Click()
  
  Tab5 = "Fiches_Cli" 
  If Not divers.Visible Then
    Divers.Visible = True
  Else
    divers.Visible = False
    Utils.db.Exec("UPDATE  " & Tab5 & "  SET  cli_obs = &2 WHERE cli_code = &1", Code.Text, Divers.Text)
    If Len(Divers.Text) <> 0 Then
      Button8.Visible = True
      Button6.Visible = False
    Else
      Button6.Visible = True
      Button8.Visible = False
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'**************************************************
'*          Création d'un nouveau client          *
'**************************************************
Public Sub button1_Click()
  
  If Impfac = "1" Then
    Balloon.Warning(("La facture a été imprimée ! Modification de client impossible."), Code)
  Else
    'Button2_click()
    Tab = "Fiches_Parametres" 
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
    If IsNull(rResult!dnc) Or If rResult!dnc <= 411000 Then
      If Son Then
        Music.Play
      Endif
      Try Message.Error("Il y a un problème pour la création des comptes clients \n Veuillez controler les paramètres SVP !")
    Else
      Code.Text = rResult!dnc
      If Val(Code.Text) = 411999 Then
        Code.Text = 4111000
      Else
        If Val(Code.Text) = 4119999 Then
          Code.Text = 41110000
        Else
          Code.Text = Val(Code.Text) + 1
        Endif
      Endif
    Endif
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnc = &1", Code.Text)
    Cv.Clear
    Nom.Clear
    Pnm.Clear
    Adr1.Clear
    Adr2.Clear
    Cp.Clear
    Burd.Clear
    Solde.Text = "0,00"
    Cv.SetFocus
    Cv.Select
    Majc.Value = True
    Nvc = 1
  Endif
  
End

'**************************************************
'*    Gestion d'une selection manuelle d'un bon    *
'**************************************************
Public Sub Colbl_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Then Colbl_Click()
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
End

Public Sub RdimColbl()
  
  If Not hColbl Then
    colbl.Height = Me.Window.Height / 1.02
    hColbl = True
    Deb1()
  Else
    colbl.Height = Me.Window.Height / 4.70
    hColbl = False
  Endif
  
End

'*****************************************************
'*    Gestion d'une selection d'un bon a la souris   *
'*****************************************************
Public Sub Colbl_Click()
  
  'Utils.db.Exec("UNLOCK TABLES")
  Tab = "Fiches_BlM" 
  Tab2 = "Fiches_Cli" 
  Tab3 = "Fiches_Comptes" 
  CleanChamps()
  CleanChampsMat()
  dtef.ReadOnly = False
  Dtech.ReadOnly = False
  Nvc = 0
  With utils
    Variables.bRemise = False
    Try rResult = Utils.db.Exec("select * from " & Tab & " where numbl = &1", colbl[colbl.row, 2].Text)
    If Not Error Then
      If rResult.count = 0 Then rResult = Utils.db.Exec("select * from " & Tab & " where numfac = &1", colbl[colbl.row, 2].Text)
      If rResult.Available Then
        Datej.text = .Cdate_Aff(rResult!datebl)
        If Not IsNull(rResult!ech) Then Dtech.text = .Cdate_Aff(rResult!ech)
        num.text = rResult!numbl
        Code.text = rResult!cdclibl
        Impfac = rResult!imp
        If Impfac = "1" Then
          Code.ReadOnly = True
          Code.Background = &HD4D0C8&
        Else
          Code.ReadOnly = False
          'Code.Background = Color.TextBackground
        Endif
        Cv.Text = rResult!cvclibl
        Nom.text = rResult!nmclibl
        If Impfac = "1" Then
          Nom.ReadOnly = True
          Nom.Background = &HD4D0C8&
        Else
          Nom.ReadOnly = False
          'Nom.Background = Color.TextBackground
        Endif
        Pnm.Text = rResult!pnmclibl
        If Impfac = "1" Then
          Pnm.ReadOnly = True
          Pnm.Background = &HD4D0C8&
        Else
          Pnm.ReadOnly = False
          'Pnm.Background = Color.TextBackground
        Endif
        Adr1.Text = rResult!adr1bl
        Adr2.text = rResult!adr2bl
        Cp.Text = rResult!cpbl
        Burd.text = rResult!villebl
        If rResult!acpt = "" Then
          Acpt.Text = "0,00"
        Else
          acpt.Text = Format$(rResult!acpt, "0.00")
        Endif
        Macompte.Text = acpt.Text
        Mrgt.Text = rResult!mreg
        Mrgmo = rResult!marge_mo
        Mrgart = rResult!marge_art
        Mrgt.text = rResult!mreg
        Numserie.Text = rResult!numserie
        CodeP.Text = rResult!codep
        If rResult!rmobl = "" Then
          Txmo.Text = "0,00"
        Else
          Try Txmo.Text = Format$(Val(.cpoint(rResult!rmobl)), "00.00")
          If Error Then Txmo.Text = "0,00"
        Endif
        If rResult!rartbl = "" Then
          Txpieces.Text = "0,00"
        Else
          Try Txpieces.Text = Format$(Val(.cpoint(rResult!rartbl)), "0.00")
          If Error Then Txpieces.Text = "0,00"
        Endif
        Tp = rResult!type
        Try Exo.Value = rResult!exobl
        If Settings["/Soc" & Start.Societe & "/AutoEnt"] Then
          Exo.Value = True
          Exo.Enabled = False
        Endif
        Try Retro.value = rResult!retro
        Try tvar.Value = rResult!tvar
        If Tp = "B" Then Bbon.Value = True
        If Tp = "P" Then Bprof.Value = True
        If Tp = "D" Then Bdevis.Value = True
        If Tp = "F" Then Bfac.Value = True
        If Tp = "A" Then Bfat.Value = True
        Impfac = rResult!imp
        Desg.Text = rResult!desg1
        Desg2.Text = rResult!desg2
        Marque.Text = rResult!marque
        Typemat.Text = rResult!typemat
        Numserie.ReadOnly = False
        Desg.ReadOnly = False
        Desg2.ReadOnly = False
        Marque.ReadOnly = False
        Typemat.ReadOnly = False
      Endif
      rResult = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", Code.text)
      If rResult.Available Then
        Code3.Text = Code.Text
        num2.Text = num.Text
        Nm.Text = Nom.Text
        telbur.Text = rResult!cli_tel_bur
        Teldom.text = rResult!cli_tel_dom
        TelPort.text = rResult!cli_pble
        Divers.text = rResult!cli_obs
        Typec = rResult!cli_typec
        Nbexpl.text = rResult!cli_expl
        TvaCli = rResult!cli_id_tva
        Encours = rResult!cli_plaf_ecrs
        If Tp = "D" Then Nbexpl.Text = "1"
        Ech = rResult!cli_cdech
        dtef.Text = Format$(Now, "dd.mm.yyyy")
        If IsNull(Dtech.text) Then Dtech.Text = dateEcheance(Ech)
        Courriel.Text = rResult!cli_email
      Endif
      
      rResult = Utils.db.Exec("select * from " & Cbase.Table("TabComptes") & " where compte_cc = &1", Code.text)
      If rResult.Available Then
        If rResult!solde = "" Then
          solde.Text = Format$("0", "0.00")
        Else
          solde.text = Format$(rResult!solde, "0.00")
        Endif
        Soldecompte = Val(Utils.cpoint(solde.text))
        If Val(solde.Text) > 0 And Settings["/Soc" & Start.Societe & "/Gestion"] = "0" Then
          code.Background = &HF51B03&
        Else
          code.Background = Color.TextBackground
        Endif
      Endif
      If IsNull(Encours) Then encours = "0"
      Verif_Encours()
      If b = 0 Then
        Tab2 = "Fiches_Materiels" 
        Tab3 = "Fiches_EntMat" 
        rResult = Utils.db.Exec("select * from " & Tab3 & " where numserie = &1 and codep = &2 and numbl = &3", Numserie.Text, CodeP.text, Num.Text)
        If rResult.Available Then LibelleMat.Text = rResult!libelle
        rResult = Utils.db.Exec("select * from " & Tab2 & " where mat_serie = &1 and mat_code = &2", Numserie.Text, CodeP.text)
        If rResult.Available Then
          Desg.Text = rResult!mat_design
          Desg2.Text = rResult!mat_design2
          Marque.Text = rResult!mat_marque
          TypeMat.Text = rResult!mat_type
          Prvt.text = rResult!mat_prvt
        Endif
        If Len(Divers.Text) <> 0 Then
          Button8.Visible = True
          Button6.Visible = False
        Else
          Button8.Visible = False
          Button6.Visible = True
        End If
        If Bfat.value Then
          Button13.Visible = False
          Button24.visible = False
        Endif
        Totmo.Text = "0,00"
        Totart.Text = "0,00"
        Totrem.Text = "0,00"
        Totht.Text = "0,00"
        Tottc.Text = "0,00"
        Tottva.Text = "0,00"
        Coldetail.Clear
        Recup_ligbl()
        chkfocus = 2
        T = 0
        B = 1
        Nv = 0
        nvc = 0
      Endif
      Cv.SetFocus
    Else
      code.SetFocus
    Endif
  End With
  
End

'**********************************************************
'*               Recuperation des lignes de BL            *
'**********************************************************
Public Sub Recup_ligbl()
  
  Dim sline As String
  Dim Lg As Integer = 1
  Dim nlgcar As String
  Dim sKey As String
  
  Tab = "Fiches_LigblM" 
  Tab2 = "Fiches_Art" 
  Totalmo = "0,00"
  Totalart = "0,00"
  Totalrem = "0,00"
  Totalmottc = "0,00"
  Totalartttc = "0,00"
  Totalremttc = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Mrg.text = "0,00"
  Mrgart = 0
  Mrgmo = 0
  Poids.text = "0,000"
  chkfocus = 1
  With utils
    Rligbl = Utils.db.Exec("select * from " & Tab & " where num_ligbl = &1 order by numlig_ligbl", num.text)
    If Rligbl.Available Then
      Repeat
        If Rligbl!typel_ligbl = "C" Then
          For Each sline In Split(Rligbl!com_ligbl, "\n")
            Coldetail.Add(Rligbl!numlig_ligbl & Lg, Rligbl!numlig_ligbl & Lg)
            Coldetail.Item[0] = Rligbl!numlig_ligbl
            Coldetail.Item[1] = Rligbl!code_ligbl
            Coldetail.Item[2] = sline
            Coldetail.Item[9] = Rligbl!typel_ligbl
            Coldetail.Item[16] = Rligbl!block_ligbl
            Inc Lg
          Next
        Else
          If Rligbl!typel_ligbl = "R" Then
            Nlgcar = Format$(Rligbl!numlig_ligbl, "0000")
            For Each sline In Split(Rligbl!com_ligbl, "\n")
              Coldetail.Add(Nlgcar & Lg, Nlgcar & Lg)
              Coldetail.Item[0] = Nlgcar
              Coldetail.Item[1] = Rligbl!code_ligbl
              Coldetail.Item[2] = sline
              Coldetail.Item[9] = Rligbl!typel_ligbl
              Coldetail.Item[16] = Rligbl!block_ligbl
              Inc Lg
              'Nlgcar = Format$(Val(nlgcar) + 1, "0000")
            Next
          Else
            Coldetail.Add(Rligbl!numlig_ligbl, Rligbl!numlig_ligbl)
            Coldetail.Item[0] = Rligbl!numlig_ligbl
            Coldetail.Item[1] = Rligbl!code_ligbl
            If Rligbl!typel_ligbl = "T" Then
              Coldetail.Item[2] = Rligbl!libel_ligbl
              Coldetail.Item[9] = Rligbl!typel_ligbl
              Coldetail.Item[16] = Rligbl!block_ligbl
            Else
              Coldetail.Item[2] = Rligbl!libel_ligbl
              If Len(Rligbl!pu_ligbl) - InStr(Rligbl!pu_ligbl, ",") = 2 Then
                Coldetail.Item[3] = Rligbl!pu_ligbl & "  "
              Else
                Coldetail.Item[3] = Rligbl!pu_ligbl
              Endif
              Coldetail.Item[4] = Rligbl!qte_ligbl
              If Len(Rligbl!brut_ligbl) - InStr(Rligbl!brut_ligbl, ",") = 2 Then
                Coldetail.Item[5] = Rligbl!brut_ligbl & "  "
              Else
                Coldetail.Item[5] = Rligbl!brut_ligbl
              Endif
              Coldetail.Item[6] = Rligbl!rem_ligbl
              If Val(.cpoint(Coldetail.item[6])) <> 0 Then
                Variables.bRemise = True
              Endif
              'Coldetail.Item[6] = Format$(Val(.CPoint(Rligbl!brut_ligbl)) - Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
              If Len(Rligbl!netht_ligbl) - InStr(Rligbl!netht_ligbl, ",") = 2 Then
                Coldetail.Item[7] = Rligbl!netht_ligbl & "  "
              Else
                Coldetail.Item[7] = Rligbl!netht_ligbl
              Endif
              Coldetail.Item[9] = Rligbl!typel_ligbl
              If Len(Rligbl!nettc_ligbl) - InStr(Rligbl!nettc_ligbl, ",") = 2 Then
                Coldetail.Item[8] = Rligbl!nettc_ligbl & "  "
              Else
                Coldetail.Item[8] = Rligbl!nettc_ligbl
              Endif
              Coldetail.Item[10] = Rligbl!tm_ligbl
              Coldetail.Item[12] = Rligbl!tx_ligbl
              Coldetail.Item[13] = Rligbl!fam_ligbl
              Coldetail.Item[14] = Rligbl!dec_ligbl
              Coldetail.Item[16] = Rligbl!block_ligbl
              Coldetail.Item[17] = Rligbl!pdstotal_ligbl
              If Rligbl!typel_ligbl = "A" Then
                If Not IsNull(Coldetail.Item[17]) Then
                  Poids.text = Format$(Val(.cpoint(Poids.text)) + Coldetail.Item[17], "0.000")
                Endif
                Coldetail.Item[18] = Rligbl!mrgart_ligbl
                If Not IsNull(Rligbl!mrgart_ligbl) Then Mrgart = Mrgart + Rligbl!mrgart_ligbl
              Endif
              If Rligbl!typel_ligbl = "M" Then
                Coldetail.Item[19] = Rligbl!mrgmo_ligbl
                If Not IsNull(Rligbl!mrgmo_ligbl) Then Mrgmo = Mrgmo + Rligbl!mrgmo_ligbl
              Endif
              Mrg.text = Format$(Mrgart + mrgmo, "0.00")
              If Rligbl!typel_ligbl <> "E" And Rligbl!typel_ligbl <> "P" And Rligbl!typel_ligbl <> "T" Then
                CalculTotal()
              Endif
            Endif
          Endif
        Endif
      Until Rligbl.MoveNext()
      Totmo.Text = Totalmo
      Totart.Text = Totalart
      Totrem.Text = Totalrem
      Totht.Text = Totalht
      Tottc.Text = Totalttc
      Tottva.Text = Format$(Val(.CPoint(Tottc.Text)) - Val(.CPoint(Totht.Text)), "0.00")
      Totht1.Text = Totht.Text
      Totva1.Text = Tottva.Text
      Tottc1.Text = Tottc.Text
    Endif
  End With
  If coldetail.count <> 0 Then
    Coldetail.MoveLast()
    Try Coldetail.Item.Selected = True
    Nlgart.Text = Format$(Val(Coldetail.item[0]) + 1, "0000")
    Nlg.Text = Format$(Val(Coldetail.item[0]) + 1, "0000")
    NlgCom.Text = Format$(Val(Coldetail.item[0]) + 1, "0000")
    skey = Coldetail.Key
    Coldetail[skey].EnsureVisible()
  Else
    Nlgart.Text = "0001"
  Endif
  
End

'**************************************************
'*       Calcul du total en bas du document       *
'**************************************************
Public Sub CalculTotal()
  
  Dim Tva As String
  Dim Rtva As Result
  Dim Mtva As Float
  
  Tva = "Fiches_Tvaav" 
  With Utils
    Rtva = Utils.db.Exec("select * from " & Tva & " where code_tva = &1", Rligbl!tx_ligbl)
    If Rligbl!typel_ligbl = "M" Then
      Try Totalmo = Format$(Val(.CPoint(Totalmo)) + Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
      Try Totalmottc = Format$(Val(Totalmottc) + (Val(.CPoint(Rligbl!netht_ligbl)) + (Val(.CPoint(Rligbl!netht_ligbl)) * Rtva!taux_tva / 100)), "0.00")
    Else
      If Rligbl!typel_ligbl = "A" Then
        Try Totalart = Format$(Val(.CPoint(Totalart)) + Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
        Try Totalartttc = Format$(Val(Totalartttc) + (Val(.CPoint(Rligbl!netht_ligbl)) + (Val(.CPoint(Rligbl!netht_ligbl)) * Rtva!taux_tva / 100)), "0.00")
      Endif
    Endif
    Try Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(Rligbl!brut_ligbl)) - Val(.CPoint(Rligbl!netht_ligbl))), "0.00")
    Try Totalht = Format$(Val(.CPoint(Totalht)) + Val(.CPoint(Rligbl!netht_ligbl)), "0.00")
    Try Totalttc = Format$(Val(.CPoint(Totalttc)) + Val(.CPoint(Rligbl!nettc_ligbl)), "0.00")
    Try Mtva = Val(.CPoint(Rligbl!brut_ligbl)) - Val(.CPoint(Rligbl!netht_ligbl))
    Try Totalremttc = Format$(Val(Totalremttc) + Mtva + (Mtva * Rtva!taux_tva / 100), "0.00")
    If Settings["/Soc" & Start.Societe & "/Impttc"] Then
      Totalmo = Totalmottc
      Totalart = Totalartttc
      Totalrem = Totalremttc
    Endif
  End With
  
End

'******************************GESTION DU CODE POSTAL*********************************
Public Sub Cpman()
  
  Dim Cpresult As Result
  Dim MyForm2 As Tricp
  
  CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp.Text & "%' order by cp, burdist")
  If CpResult.Available Then
    If CpResult.count > 1 Then
      MyForm2 = New Tricp("FactureMat", Cp.Text)
      Try MyForm2.Showmodal()
      If Bsel = True Then
        Cp.text = Codepostal
        Burd.Text = Bureaudistributeur
        Burd.setfocus
      Else
        Burd.clear
        Burd.SetFocus
      Endif
    Else
      Burd.text = CpResult!burdist
      Burd.SetFocus
      Burd.Select
    Endif
  Else
    Burd.SetFocus
    Burd.Select
  Endif
  
End

Public Sub aff_cp()
  
  Dim CpResult As Result
  
  Colcp.visible = True
  Button5.Visible = True
  Colcp.Columns.count = 2
  Colcp.Columns[0].Width = 60
  Colcp.Columns[1].Width = 280
  Colcp.Columns[0].Text = "CP"
  Colcp.Columns[1].Text = "Bureau distributeur"
  If cp.text Then
    CpResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCpostaux") & " where cp like '" & cp.Text & "%' order by cp, burdist")
    If CpResult.Available Then
      Repeat
        Colcp.Add(CpResult!cp & CpResult!burdist, CpResult!cp & CpResult!burdist)
        Colcp.Item[0] = CpResult!cp
        Colcp.Item[1] = CpResult!burdist
      Until CpResult.MoveNext()
      Colcp.MoveFirst()
      Colcp.Item.Selected = True
      Colcp.setfocus
    Endif
  Endif
  
End

Public Sub Colcp_Click()
  
  Cp.Text = Colcp.Item[0]
  Burd.Text = Colcp.Item[1]
  Colcp.clear
  Colcp.visible = False
  Burd.SetFocus
  Burd.Select
  
End
'****************************************************************
'* Gestion du columnview Colcp lors d'une saisie manuelle       *
'****************************************************************

Public Sub Colcp_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcp.MoveCurrent
    Colcp_Click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colcp.visible = False
    Colcp.clear
    Cp.Select
    Cp.SetFocus
    Stop Event
  Endif
  
End

Public Sub ChkCp()
  
  If InStr("0123456789", Key.Text) = 0 Then
    If key.code <> key.BackSpace And Key.Code <> Key.tab And Key.Code <> Key.Delete And Key.code <> Key.enter And Key.code <> Key.return Then
      Stop Event
    Endif
  Endif
  
End

Public Sub ToggleButton8_Click()
  
  If Colcp.visible = False Then
    Colcp.visible = True
    aff_cp()
  Else
    Colcp.Clear
    Colcp.visible = False
  Endif
  
End

'********************************FIN DE GESTION DU CODE POSTAL**************************

'**********************************************************
'*                 Gestion onglet Saisie MO               *
'**********************************************************
Public Sub SelectionMo()
  
  Tabmo = "Fiches_Mo" 
  Colmo.Clear
  If ColFam.Visible Then
    ColFam.Clear
    ColFam.Visible = False
  Endif
  If ColCom.Visible Then
    Colcom.Clear
    ColCom.Visible = False
  Endif
  If Colmo.Visible Then
    Colmo.Clear
    Colmo.Visible = False
    HBox8.Visible = False
  Else
    Colmo.Visible = True
    HBox8.Visible = True
  Endif
  Tri = "mo_code"
  Trimo()
  chkfocus = 2
  Co2.SetFocus
  
End

Public Sub TriMo()
  
  With ColMo
    .Columns.count = 3
    .Columns[0].Width = CO2.Width
    .Columns[1].Width = FO2.Width
    .Columns[2].Width = FAM2.Width
  End With
  
End

Public Sub colmo_Data(Row As Integer, Column As Integer)
  
  chkfocus = 2
  MoTable[0] = "mo_code"
  MoTable[1] = "mo_design"
  MoTable[2] = "mo_fam"
  Utils.rs4.MoveTo(Row)
  colmo.data.Text = Str(Utils.rs4[motable[Column]])
  chkfocus = 0
  
End

Public Sub Deb7()
  
  Utils.Base4(ColMo, "select * from " & Tabmo & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & "")
  
End

Public Sub Deb8()
  
  Utils.Base4(ColMo, "select * from " & Tabmo & " where " & Tri & " like  \"%" & sel & "%\" order by " & Tri & " Desc")
  
End

Public Sub Ref()
  
  Tri = "mo_code"
  Trimo()
  
End

Public Sub Dbclkmo()
  
  If Not Dbl Then
    Deb8()
    Dbl = "1"
  Else
    Deb7()
    Dbl = ""
  Endif
  
End

Public Sub Colmo_Close()
  
  Colmo.Clear
  Colmo.Visible = False
  HBox8.Visible = False
  Stop Event
  
End

Public Sub Co2_Click()
  
  sel = ""
  Dbl = ""
  Co2.Text = ""
  Fo2.Text = "Intitulé"
  Tri = "mo_code"
  Deb7()
  
End

Public Sub Co2_Dblclick()
  
  sel = ""
  Co2.Text = ""
  Fo2.Text = "Intitulé"
  Tri = "mo_code"
  Dbclkmo()
  
End

Public Sub CO2_GotFocus()
  
  Try Utils.ObsGotf(Co2)
  CO2_Click()
  CO2.SetFocus
  
End

Public Sub CO2_LostFocus()
  
  Try Utils.ObsLstf(CO2)
  
End

Public Sub CO2_KeyPress()
  
  If key.code = key.esc Or key.code = key.F2 Then
    Colmo_Close()
    Cmo.SetFocus
  Else
    If key.code = key.down Then
      Colmo.MoveTo(0, 0)
      Colmo.SetFocus
    Else
      If Key.code = Key.Right Then
        FO2_GotFocus()
      Else
        Chkinput3()
      Endif
    Endif
  Endif
  
End

Public Sub FO2_Click()
  
  sel = ""
  Dbl = ""
  Co2.Text = "Code Mo" ""
  Fo2.Text = ""
  Tri = "mo_design"
  Deb7()
  
End

Public Sub FO2_Dblclick()
  
  sel = ""
  Co2.Text = "Code Mo"
  Fo2.Text = ""
  Tri = "mo_design"
  Dbclkmo()
  
End

Public Sub FO2_GotFocus()
  
  Try Utils.ObsGotf(fo2)
  FO2_Click()
  Fo2.SetFocus
  
End

Public Sub FO2_LostFocus()
  
  Try Utils.ObsLstf(FO2)
  
End

Public Sub FO2_KeyPress()
  
  If key.code = key.esc Or key.code = key.F2 Then
    Colmo_Close()
    Cmo.SetFocus
  Else
    If key.code = key.down Then
      Colmo.MoveTo(0, 0)
      Colmo.SetFocus
    Else
      If Key.code = Key.Right Then
        CO2_GotFocus()
      Else
        Chkinput3()
      Endif
    Endif
  Endif
  
End

Public Sub ChkInput3()
  
  If InStr("\"&'", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
    Deb7()
  Else
    Stop Event
  Endif
  
End

'***************************************************
'*      Selection d'un code MO a la souris         *
'***************************************************
Public Sub Colmo_Click()
  
  Tabmo = "Fiches_Mo" 
  Cmo.Text = colmo[colmo.row, 0].Text
  chkfocus = 1
  Tmont.Text = "1,00"
  With utils
    mo_man()
    Colmo.Clear
    Colmo.visible = False
    HBox8.Visible = False
  End With
  
End

'***************************************************
'* Selection d'un code Mo manuellement         *
'***************************************************
Public Sub Colmo_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colmo_Click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    Colmo.visible = False
    HBox8.Visible = False
    Colmo.clear
    Cmo.Select
    Cmo.SetFocus
    Stop Event
  Endif
  
End

'**********************************************************
'*         Recuperation de la main d'oeuvre               *
'**********************************************************
Public Sub mo_man()
  
  Tabmo = "Fiches_Mo" 
  chkfocus = 1
  If Impfac <> "1" Then
    rResult = Utils.db.Exec("SELECT * FROM " & Tabmo & " where mo_code = &1", Cmo.Text)
    If rResult.Available Then
      With utils
        Cmo.Text = rResult!mo_code
        libelle.text = rResult!mo_design
        cdfam.Text = rResult!mo_fam
        Txhr.Text = Format$(rResult!mo_txht, "0.00")
        Rem.Text = .CPoint(Rem.Text)
        If IsNull(Rem.Text) Then Rem.Text = "0,00"
        Try PrvtMo = rResult!mo_prvt
        If Error Then PrvtMo = 0
        If Not tvar.Value Then
          Tmo.Text = rResult!mo_tva
          Tmo.readonly = True
        Else
          Tmo.Text = Codetva
          Tmo.readonly = False
        Endif
        'Tmo.text = rResult!mo_tva
        Tm.text = rResult!mo_tempmont
        If Tm.Text = "1" Then Tm.Text = "T"
        If Tm.Text = "0" Then Tm.Text = "M"
        If Tm.Text = "M" And rResult!mo_valeurht <> 0 Then
          Txhr.Text = Format$(rResult!mo_valeurht, "0.00")
          Brutht.Text = Txhr.Text
          Netht.Text = Brutht.Text
          Arr = rResult!mo_cdarr
          Arrondimo()
        Else
          If rResult!mo_montant <> 0 And Tm.Text = "T" Then
            Tmont.Text = Format$(rResult!mo_montant, "0.00")
            Brutht.Text = Format$(Val(Tmont.Text) * Val(Txhr.Text), "0.00")
            Calc_Net()
          Else
            Brutht.Text = Txhr.Text
            Calc_Net()
          Endif
        Endif
        Calc_Rem()
        Calc_TC()
        Try MargeMo.Text = Format$(rResult!mo_marge, "0.00")
        If Error Then Calc_MargeMo()
        If Settings["/Soc" & Start.Societe & "/AutoEnt"] Then Calc_moHt()
        libelle.SetFocus
        libelle.Select
      End With
    Else
      If Son Then
        Music.Play
      Endif
      Try Message.Warning("Le code MO " & Cmo.Text & " n'existe pas !", "OK")
      Cmo.SetFocus
      Cmo.clear
      b = 1
    Endif
  Else
    If Son Then
      Music.Play
    Endif
    Colmo.Visible = False
    HBox8.Visible = False
    Try Message.Warning("La facture a été imprimée, ajout de MO impossible")
    b = 1
    Cmo.Clear
    Cmo.SetFocus
    Cmo.Select
  Endif
  
End

Public Sub Calc_MargeMo()
  
  Dim Tx As Float
  Dim txh As Float
  Dim Txf As Float
  
  Tabmo = "Fiches_Mo" 
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabMo") & " where mo_code = &1", Cmo.Text)
  If rResult.Available Then
    Try PrvtMo = rResult!mo_prvt
    If Error Then PrvtMo = 1
    TxhtMo = rResult!mo_txht
  Endif
  If Tm.Text = "T" Then
    'On calcule le montant du taux horaire
    'Txh = Val(Utils.cpoint(Txhr.Text)) * Val(Utils.cpoint(Tmont.Text))
    Txh = Val(Utils.cpoint(Netht.Text))
    'Puis le montant du prix de revient
    Txf = PrvtMo * Val(Utils.cpoint(Tmont.Text))
    'On calcule la marge en valeur pour finir.
    MargeMo.text = Format$(Txh - Txf, "0.00")
  Else
    'On calcule à quoi correspond le montant du forfait
    Try Tx = Val(Utils.cpoint(Netht.Text)) / TxhtMo
    'Puis on calcule le montant du taux horaire
    Txh = TxhtMo * tx
    'Puis le montant du prix de revient
    Txf = PrvtMo * tx
    'On calcule la marge en valeur pour finir.
    MargeMo.text = Format$(Txh - Txf, "0.00")
  Endif
  If Val(Utils.cpoint(MargeMo.Text)) < 0 Then
    MargeMo.Background = &HEF3E1A&
  Else
    MargeMo.Background = &HD4D0C8&
  Endif
  
End

'**********************************************************
'*            On veut rechercher une Mo                   *
'**********************************************************
Public Sub ToggleButton2_Click()
  
  chkfocus = 2
  SelectionMo()
  
End

'*******************************
'*    Gestion du panel Mo      *
'*******************************
Public Sub mo_KeyPress()
  
  If key.Code = key.F4 Then Movr.ShowModal()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    
    Select Case Last.tag
        
      Case 1
        ChkFocus = 2
        mo_man()
        If b <> 1 Then
          If Val(Brutht.text) = 0 Then
            libelle.SetFocus
            libelle.Select
          Else
            Tmont.SetFocus
            Tmont.Select
          Endif
        Endif
        b = 0
        Stop Event
        
      Case 2
        ChkFocus = 2
        Libelle.Text = Utils.Remplace(Libelle.Text)
        If Not Cmo.Text Then
          Try Message.Warning("Veuillez saisir une MO SVP", "Ok")
          Cmo.SetFocus
          Cmo.Select
        Else
          If Not Libelle.Text Then
            Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
            Libelle.SetFocus
            Libelle.Select
          Else
            Tmont.SetFocus
            Tmont.Select
          Endif
        Endif
        Stop Event
        
      Case 3
        ChkFocus = 2
        Tm.Text = Upper$(Tm.Text)
        If Tm.text <> "T" And Tm.text <> "M" Then Tm.text = "T"
        Txhr.SetFocus
        Txhr.Select
        Stop Event
        
      Case 4
        ChkFocus = 2
        Calc_Txhr()
        If b = 1 Then
          Txhr.SetFocus
          Txhr.Select
          b = 0
        Else
          Tmont.SetFocus
          Tmont.Select
        Endif
        Stop Event
        
      Case 5
        ChkFocus = 2
        Calc_Tmont()
        If b = 1 Then
          Tmont.SetFocus
          Tmont.Select
          b = 0
        Else
          Button10.SetFocus
        Endif
        Stop Event
        
      Case 6
        ChkFocus = 2
        Calc_brut()
        If b = 1 Then
          Brutht.SetFocus
          Brutht.Select
          b = 0
        Else
          Rem.SetFocus
          Rem.Select
        Endif
        Stop Event
        
      Case 7
        ChkFocus = 2
        Calc_Rem()
        If b = 1 Then
          Rem.SetFocus
          Rem.Select
          b = 0
        Else
          Netht.SetFocus
          Netht.Select
        Endif
        Stop Event
        
      Case 8
        ChkFocus = 2
        Calc_Puht()
        If b = 1 Then
          Netht.SetFocus
          Netht.Select
          b = 0
        Else
          Nettc.SetFocus
          Nettc.Select
        Endif
        Stop Event
        
      Case 9
        ChkFocus = 2
        With Utils
          Nettc.Text = .Cpoint(Nettc.Text)
          If Val(Nettc.Text) = Null Then
            If Son Then
              Music.Play
            Endif
            Try message.Warning("Veuillez verifier votre saisie SVP !")
            Nettc.SetFocus
            Nettc.Select
          Else
            tx = (1 + Ttva / 100)
            Netht.Text = Format$(Val(.CPoint(Nettc.Text)) / Tx, "0.00")
            Calc_PuHt()
            If b = 1 Then
              Nettc.SetFocus
              Nettc.Select
            Else
              Button10.SetFocus
            Endif
          Endif
        End With
        Stop Event
    End Select
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.F2 Then
    
    Select Case Last.tag
        
      Case 1
        SelectionMo()
        Stop Event
        
    End Select
  Endif
  
  If Key.code = Key.F5 Then
    hForm = New FCalc
    ChkFocus = 2
    hForm.Showmodal()
    If Not IsNull(FCalc.Resultat) Then Last.Text = Format$(Val(FCalc.Resultat), "0.00")
  Endif
  
End

Public Sub Tmo_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then Tmo_LostFocus()
  
End

Public Sub Tmo_LostFocus()
  
  Calc_Tmont()
  Nettc.SetFocus
  Nettc.Select
  
End

Public Sub mo_Lostfocus()
  
  Calc_MargeMo()
  If chkfocus <> 2 And Cmo.text Then
    Select Case Last.tag
        
      Case 1
        If Not IsNull(Cmo.text) Then mo_man()
        If b <> 1 Then
          If Val(Brutht.text) = 0 Then
            libelle.SetFocus
            libelle.Select
          Endif
        Endif
        b = 0
        Stop Event
        
      Case 2
        Libelle.Text = Utils.Remplace(Libelle.Text)
        If Not Cmo.Text Then
          Try Message.Warning("Veuillez saisir une MO SVP", "Ok")
          Cmo.SetFocus
          Cmo.Select
        Else
          If Not Libelle.Text Then
            Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
            Libelle.SetFocus
            Libelle.Select
          Endif
        Endif
        Stop Event
        
      Case 3
        Tm.Text = Upper$(Tm.Text)
        If Tm.text <> "T" And Tm.text <> "M" Then Tm.text = "T"
        Txhr.SetFocus
        Txhr.Select
        Stop Event
        
      Case 4
        Calc_Txhr()
        If b = 1 Then
          Txhr.SetFocus
          Txhr.Select
          b = 0
        Endif
        
        Stop Event
        
      Case 5
        If chkfocus <> 1 Then
          Calc_Tmont()
          If b = 1 Then
            Tmont.SetFocus
            Tmont.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 6
        If chkfocus <> 1 Then
          Calc_brut()
          If b = 1 Then
            Brutht.SetFocus
            Brutht.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 7
        If chkfocus <> 1 Then
          Calc_Rem()
          If b = 1 Then
            Rem.SetFocus
            Rem.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 8
        If chkfocus <> 1 Then
          Calc_Puht()
          If b = 1 Then
            Netht.SetFocus
            Netht.Select
            b = 0
          Endif
        Endif
        chkfocus = 0
        Stop Event
        
      Case 9
        With Utils
          If chkfocus <> 1 Then
            Try changep = .cpoint(Netht.Text)
            Nettc.Text = .Cpoint(Nettc.Text)
            If Val(Nettc.Text) = Null Then
              If Son Then
                Music.Play
              Endif
              Try message.Warning("Veuillez verifier votre saisie SVP !")
              Nettc.SetFocus
              Nettc.Select
            Else
              tx = (1 + Ttva / 100)
              Netht.Text = Format$(Val(.CPoint(Nettc.Text)) / Tx, "0.00")
              Calc_PuHt()
            Endif
          Endif
        End With
        Stop Event
    End Select
    chkfocus = 0
  Endif
  
End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub mo_GotFocus()
  
  With Utils
    .SetEditColor(Me, Last)
  End With
  Cdfam.Background = &HD4D0C8&
  Nlg.Background = &HD4D0C8&
  Select Case Last.tag
    Case 4
      Chg()
    Case 5
      Chg()
      Stop Event
    Case 6
      Chg()
      Stop Event
    Case 7
      Chg()
      Stop Event
    Case 8
      Chg()
      Stop Event
    Case 9
      Chg()
      Stop Event
  End Select
  
End

Public Sub Chg()
  
  With Utils
    ChangeTx = .CPoint(Txhr.Text)
    Changeb = .CPoint(Brutht.Text)
    Changep = .CPoint(Netht.Text)
    Changer = .CPoint(Rem.Text)
    Changet = .CPoint(Nettc.Text)
    Changetm = .CPoint(Tmont.Text)
  End With
  
End

Public Sub Razmo()
  
  Cmo.Text = ""
  libelle.Text = ""
  Tm.Text = ""
  Cdfam.Text = ""
  Txhr.Text = ""
  Tmont.Text = "1,00"
  Brutht.Text = ""
  Rem.Text = "0,00"
  Netht.Text = ""
  Nettc.Text = ""
  Tmo.Text = ""
  ChangeB = ""
  ChangeP = ""
  ChangeTx = ""
  Changer = ""
  ChangeT = ""
  MargeMo.text = "0,00"
  If coldetail.count <> 0 Then
    Coldetail.MoveLast()
    Coldetail.Item.Selected = True
    Nlg.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Else
    Nlg.Text = "0001"
  Endif
  
End

'***********************
'*  Calcul du net MO   *
'***********************
Public Sub Calc_Net()
  
  With utils
    If rem.text <> "0,00" Then
      Netht.Text = Format$(Val(Brutht.Text) - (Val(Brutht.Text) * Val(rem.Text) / 100), "0.00")
    Else
      netht.Text = Format$(Val(Brutht.Text), "0.00")
    Endif
    
  End With
  
End

'*********************
'*  Verif Tx hr MO   *
'*********************
Public Sub Calc_Txhr()
  
  With utils
    Txhr.Text = .CPoint(Txhr.Text)
    If Val(Txhr.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If ChangeTx <> Txhr.Text Then
        Txhr.Text = Format$(Val(Txhr.Text), "0.00")
        Calc_Tmont()
      Endif
      b = 0
    Endif
  End With
  
End

'********************
'*  Verif brut MO   *
'********************
Public Sub Calc_Brut()
  
  With utils
    Brutht.Text = .CPoint(Brutht.Text)
    If Val(Brutht.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Changeb <> Brutht.Text And Tm.text = "T" Then
        chkfocus = 1
        If Son Then
          Music.Play
        Endif
        'If message.Question(" Vous venez de modifier le prix brut HT. Voulez-vous \n 1- Modifier la quantité \n 2- Modifier le taux horaire ", " 1 ", " 2 ") = "1" Then
        'Brutht.Text = Format$(Val(Brutht.Text), "0.00")
        'Tmont.Text = Format(Val(.CPoint(Brutht.Text)) / Val(.CPoint(Txhr.Text)), "0.00")
        'Else
        'Txhr.Text = Format(Val(.CPoint(Brutht.Text)) / Val(.CPoint(Tmont.Text)), "0.00")
        'Endif
        Brutht.Text = Format$(Val(.CPoint(Brutht.Text)), "0.00")
      Else
        If Changeb <> Brutht.Text And Tm.text = "M" Then Txhr.text = Format$(Val(Brutht.Text), "0.00")
        Brutht.Text = Format$(Val(Brutht.Text), "0.00")
      Endif
      Calc_Net()
      Calc_TC()
      Calc_moHt()
      'Rem.SetFocus
      'rem.Select
      b = 0
    Endif
  End With
  
End

'************************
'*    Verif du T/M      *
'************************
Public Sub Calc_Tmont()
  
  With utils
    Tmont.Text = .CPoint(Tmont.Text)
    If Val(tmont.Text) = 0 Or Val(tmont.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Brutht.Text = Format(Val(Tmont.Text) * Val(Txhr.Text), "0.00")
      Calc_Net()
      Calc_TC()
      Calc_moHt()
      Tmont.Background = Color.TextBackground
      'Montante = Val(Brutht.text)
      b = 0
    Endif
  End With
  
End

'******************
'*  Verif du PU   *
'******************
Public Sub Calc_Puht()
  
  With Utils
    Netht.Text = .CPoint(Netht.Text)
    If Val(Netht.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
        Netht.SetFocus
        Netht.Select
      Endif
    Else
      If changep <> Netht.Text Then
        chkfocus = 1
        Rem.Text = "0,00"
        Netht.Text = Format$(Val(.CPoint(Netht.Text)), "0.00")
        If Son Then
          Music.Play
        Endif
        If message.Question(" Vous venez de modifier le prix net HT. Voulez-vous \n 1- Modifier la remise \n 2- Modifier le prix brut et le taux horaire ", " 1 ", " 2 ") = "1" Then
          Rem.Text = Format(Val(.CPoint(Brutht.Text)) - Val(.CPoint(Netht.Text)), "0.00")
          Rem.Text = Format$((Val(.CPoint(Rem.Text)) * 100) / Val(.CPoint(brutht.Text)), "00.00")
        Else
          If Val(rem.Text) <> 0 And Val(rem.Text) <> Null Then
            Brutht.Text = Format$(Val(.CPoint(Netht.Text)) / (1 - (Val(.CPoint(Rem.Text)) / 100)), "0.00")
          Else
            Brutht.Text = Format$(Val(.CPoint(Netht.Text)), "0.00")
          Endif
          Txhr.Text = Format(Val(.CPoint(Brutht.Text)) / Val(.CPoint(Tmont.Text)), "0.00")
        Endif
        Calc_TC()
        Calc_moHt()
      Endif
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

'************************
'*  Verif de la remise  *
'************************
Public Sub Calc_Rem()
  
  With Utils
    If Rem.Text = "" Then Rem.Text = "0,00"
    rem.Text = .CPoint(rem.Text)
    If Val(Rem.Text) = Null Then
      If Son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Else
      rem.Text = Format$(Val(.CPoint(rem.Text)), "0.00")
      NetHt.Text = Format$(Val(brutht.Text) - (Val(brutht.Text) * Val(Rem.Text) / 100), "0.00")
      Calc_TC()
      If Val(Nettc.Text) <> 0 Then Calc_moHt()
      'Montante = Val(Netht.Text)
      b = 0
    Endif
  End With
  
End

'***********************************
'* On gère l' arrondi de la MO     *
'***********************************
Public Sub arrondimo()
  
  If Not Nettc.Text Then Nettc.Text = "0,00"
  If Arr = "0,05" Then
    If Right$(Nettc.Text) Like "[34567]*" Then
      Nettc.Text = Left$(Nettc.Text, (Len(Nettc.Text) - 1)) & "5"
    Else
      Nettc.Text = Round(Val(Nettc.Text), -1)
      Nettc.Text = Format$(Nettc.Text, "0.00")
    Endif
  Endif
  
  If Arr = "0,10" Then
    Nettc.Text = Round(Val(Nettc.Text), -1)
    Nettc.Text = Format$(Nettc.Text, "0.00")
  Endif
  
  If Arr = "0,50" Then
    If Abs(Val(Nettc.Text)) <= Abs(Val(Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & 25)) Then
      Nettc.Text = Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & "00"
    Else
      If Abs(Val(Nettc.Text)) <= Abs(Val(Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & 75)) Then
        Nettc.Text = Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & "50"
      Endif
      If Abs(Val(Nettc.Text)) >= Abs(Val(Left$(Nettc.Text, (Len(Nettc.Text) - 2)) & 76)) Then
        Nettc.Text = Round(Val(Nettc.Text))
        Nettc.Text = Format$(Nettc.Text, "0.00")
      Endif
    Endif
  Endif
  
  If Arr = "1,00" Then
    Nettc.Text = Round(Val(Nettc.Text))
    Nettc.Text = Format$(Nettc.Text, "0.00")
  Endif
  
End

'***********************
'* Calcul du TTC       *
'***********************
Public Sub Calc_TC()
  
  Tab = "Fiches_Tvaav" 
  With Utils
    Ttva = 0
    If Not Exo.Value Then
      rResult = Utils.db.Exec("select * from " & Tab & " where code_tva = &1", Tmo.Text)
      If rResult.Available Then
        Ttva = rResult!taux_tva
      Endif
    Else
      Tmo.Text = ""
    Endif
    Nettc.Text = Format$(Val(Netht.Text) + (Val(Netht.Text) * Ttva / 100), "0.00")
    If Val(Nettc.Text) <> 0 Then Arrondimo()
  End With
  
End

'***********************
'*  Calcul du HT       *
'***********************
Public Sub Calc_moHt()
  
  With Utils
    tx = (1 + Ttva / 100)
    Rem.Text = .CPoint(Rem.Text)
    If Val(Rem.Text) = Null Or Val(.CPoint(Rem.Text)) = 0 Then
      Rem.Text = "0"
      Rem.Text = Format$(Val(.CPoint(Rem.Text)), "00.00")
    Endif
    Nettc.Text = .CPoint(Nettc.Text)
    If Val(Nettc.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Nettc.Text = Format$(Val(.CPoint(Nettc.Text)), "0.00")
    Endif
    Netht.Text = Format$(Val(.CPoint(Nettc.Text)) / Tx, "0.00")
    If Val(Rem.Text) <> 0 And Val(Rem.Text) <> Null Then
      Try Brutht.Text = Format$(Val(.CPoint(Netht.Text)) / (1 - (Val(.CPoint(Rem.Text)) / 100)), "0.00")
    Else
      Brutht.Text = Netht.Text
    Endif
    Txhr.Text = Format$(Val(.CPoint(Brutht.Text)) / (Val(.CPoint(Tmont.Text))), "0.00")
    Txhr.Text = Format$(Val(.CPoint(Txhr.Text)), "0.00")
    
  End With
Catch
  If Son Then
    Music.Play
  Endif
  Try message.Error("Il y a une incohérence dans votre saisie. Veuillez controler SVP !")
  
End

'*****************************************************************
'* Gestion des radiobuttons de selection du type de saisie       *
'*****************************************************************

Public Sub Bbon_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "B"
    If Atype = "D" Or Atype = "P" Or Atype = "C" Then Maj_Quantite()
    Maj_typeBL()
    Button13.Visible = True
    Button24.visible = True
  Else
    Wrg()
  Endif
  
End

Public Sub Bdevis_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "D"
    If Atype = "B" Or Atype = "F" Then Maj_Quantite2()
    Maj_typeBL()
    Button13.Visible = True
    Button24.visible = True
  Else
    Wrg()
  Endif
  
End

Public Sub Bprof_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "P"
    If Atype = "B" Or Atype = "F" Then Maj_Quantite2()
    Maj_typeBL()
    Button13.Visible = True
    Button24.visible = True
  Else
    Wrg()
  Endif
  
End

Public Sub Bfac_Click()
  
  Atype = Tp
  Tp = "F"
  If Atype = "D" Or Atype = "P" Or Atype = "C" Then Maj_Quantite()
  Maj_typeBL()
  Button13.Visible = True
  Button24.visible = True
  
End

Public Sub Bfat_Click()
  
  If Impfac <> 1 Then
    Atype = Tp
    Tp = "A"
    Maj_typeBL()
    Numserie.ReadOnly = False
    Desg.ReadOnly = False
    Desg2.ReadOnly = False
    Marque.ReadOnly = False
    Typemat.ReadOnly = False
    Button13.Visible = False
    Button24.visible = False
  Else
    Wrg()
  Endif
  
End

Public Sub Wrg()
  
  If Son Then
    Music.Play
  Endif
  Bfac.value = True
  Balloon.Warning("Modification du type de document impossible, la facture a été imprimée !", Bfac)
  
End

'****************************
'* On met à  jour le type    *
'****************************
Public Sub Maj_typeBL()
  
  Dim iskey As Integer = 0
  
  Tab = "Fiches_BlM" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numbl = &1", num.text)
  If rResult.Available Then
    Utils.db.Exec("UPDATE  " & Tab & "  SET  type = &2 WHERE numbl = &1", num.Text, Tp)
  Endif
  sel = ""
  'TYB.Clear
  If $Desc = False Then
    Deb1()
  Else
    Deb2()
  Endif
  If Nv <> 1 And Not IsNull(num.text) Then
    Repeat
      Colbl.MoveTo(iskey, 0)
      Inc iskey
    Until colbl[colbl.row, 2].Text = num.text
  Else
    Colbl.MoveTo(0, 0)
    Nv = 0
  Endif
  Colbl_Click()
Catch
  
End

'****************************
'* On enregistre la MO      *
'****************************
Public Sub Button10_Keypress()
  
  If Key.code = 77 Then 'M
    TM.SetFocus
    TM.Select
  Endif
  If Key.code = 88 Then 'X
    Txhr.SetFocus
    Txhr.Select
  Endif
  If Key.code = 80 Then 'P
    Tmont.SetFocus
    Tmont.Select
  Endif
  If Key.code = 66 Then 'B
    Brutht.SetFocus
    Brutht.Select
  Endif
  If Key.code = 82 Then 'R
    Rem.SetFocus
    Rem.Select
  Endif
  If Key.code = 72 Then 'H
    Netht.SetFocus
    Netht.Select
  Endif
  If Key.code = 84 Then 'T
    Nettc.SetFocus
    Nettc.Select
  Endif
  If Key.code = 76 Then 'L
    Libelle.SetFocus
    Libelle.Select
  Endif
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Button10_Click()
  Endif
  
End

Public Sub Button10_Click()
  
  If b = 1 Then
    Cmo.SetFocus
    Cmo.Select
    b = 0
  Else
    If Cmo.Text <> "" Then
      rem.Text = Format$(Val(Utils.CPoint(rem.Text)), "0.00")
      If Val(Brutht.text) = 0 Then
        If Message.Question("Le prix de cette MO est égal à  zéro !\n Confirmez-vous votre saisie ? ", "Oui", "Non") = 1 Then
          MajColdetailMo()
        Endif
      Else
        MajColdetailMo()
      Endif
    Endif
  Endif
  
End

Public Sub MajColdetailMo()
  
  libelle.Text = Utils.Remplace(libelle.Text)
  Mrg.Text = Format$(Val(Utils.cpoint(Mrg.text)) + Val(Utils.cpoint(MargeMo.text)), "0.00")
  If Val(Utils.cpoint(MargeMo.Text)) < 0 Then
    Mrg.Background = &HEF3E1A&
  Else
    Mrg.Background = &HD4D0C8&
  Endif
  Mrgmo = Mrgmo + Val(Utils.cpoint(MargeMo.text))
  If Not IsNull(ChangeTx) And If ChangeTx <> Txhr.text Then
    Calc_Txhr()
    If b = 1 Then
      Txhr.SetFocus
      Txhr.Select
      b = 0
    Else
      Calc_Tmont()
      MajColdetailMo2()
    Endif
  Else
    If Not IsNull(Changeb) And If Changeb <> Brutht.text Then
      Calc_Brut()
      If b = 1 Then
        Brutht.SetFocus
        Brutht.Select
        b = 0
      Else
        MajColdetailMo2()
      Endif
    Else
      If Not IsNull(Changer) And If Changer <> Rem.text Then
        Calc_Rem()
        If b = 1 Then
          Rem.SetFocus
          Rem.Select
          b = 0
        Else
          MajColdetailMo2()
        Endif
      Else
        If Not IsNull(Changep) And If Changep <> NetHt.text Then
          Calc_Puht()
          If b = 1 Then
            NetHt.SetFocus
            NetHt.Select
            b = 0
          Else
            MajColdetailMo2()
          Endif
        Else
          If Not IsNull(Changet) And If Changet <> Nettc.text Then
            Calc_moHt()
            If b = 1 Then
              Nettc.SetFocus
              Nettc.Select
              b = 0
            Else
              MajColdetailMo2()
            Endif
          Else
            If Not IsNull(Changetm) And If Changetm <> Tmont.text Then
              Calc_Tmont()
              If b = 1 Then
                Tmont.SetFocus
                Tmont.Select
                b = 0
              Else
                MajColdetailMo2()
              Endif
            Else
              MajColdetailMo2()
            Endif
          Endif
        Endif
      Endif
    Endif
  Endif
  modif = "0"
  
End

Public Sub MajColdetailMo2()
  
  If modif = "1" Then
    Coldetail.MoveFirst
    Repeat
      Coldetail.Item.Selected = True
      If Coldetail.Item[0] = Nlg.Text Then
        Break
      Endif
    Until Coldetail.MoveNext()
  Endif
  If N = 1 Then Coldetail.Add(Nlg.text, Nlg.text)
  Coldetail.Item[0] = Nlg.text
  Coldetail.Item[1] = Cmo.text
  Coldetail.Item[2] = libelle.text
  Coldetail.Item[3] = Txhr.text
  Coldetail.Item[4] = Tmont.text
  Coldetail.Item[5] = Brutht.text
  Coldetail.Item[6] = rem.text
  Coldetail.Item[7] = Netht.text
  Coldetail.Item[9] = typeL
  Coldetail.Item[8] = Nettc.Text
  Coldetail.Item[10] = Tm.text
  Coldetail.Item[12] = Tmo.Text
  Coldetail.Item[13] = Cdfam.Text
  Bloc = Nlg.text & Cmo.text & Round(Rnd(1000, 9999))
  Enrg_Ligmo()
  Cmo.SetFocus
  Cmo.Select
  Razmo()
  Motm_Click()
  N = 1
  modif = "0"
  'ENDIF
  
End

'**********************************************************
'*                 Gestion onglet Saisie Articles         *
'**********************************************************
Public Sub SelectionArt()
  
  Dim MyForm As TriArticles
  
  Bsel = False
  sel = ""
  If Colmo.Visible Then
    Colmo.Clear
    Colmo.Visible = False
    HBox8.Visible = False
  Endif
  If ColFam.Visible Then
    ColFam.Clear
    ColFam.Visible = False
  Endif
  If ColCom.Visible Then
    Colcom.Clear
    ColCom.Visible = False
  Endif
  ChkFocus = 2
  Tri = "art_code"
  MyForm = New TriArticles(Bart.Value, B2art.Value, Tri, "FactureMat", "", "")
  MyForm.Showmodal()
  If Bsel = True Then
    Cart.text = Codearticle
    Art_Man(Cart.Text)
  Else
    Cart.SetFocus
  Endif
  
End

Public Sub Art_Equ()
  
  Dim Rpl As Result
  
  Rpl = utils.db.Exec("SELECT *  From " & Cbase.Table("TabArt") & " WHERE art_cequ = &1 order by art_code ", Cart.Text)
  If Rpl.count > 1 Then
    hcol.Columns.Count = 3
    hcol.Columns[0].Width = 180
    hcol.Columns[0].Text = "Code"
    hcol.Columns[1].Width = 470
    hcol.Columns[1].Text = "Désignation"
    hcol.Columns[2].Width = 80
    hcol.Columns[2].Text = "Quantité"
    Repeat
      hcol.Add(Rpl!art_code, Rpl!art_code)
      hcol.item[0] = Rpl!art_code
      hcol.item[1] = Rpl!art_design
      hcol.item[2] = Rpl!art_qte
    Until Rpl.MoveNext()
    Panel11.Visible = True
    hcol.SetFocus
  Else
    If Rpl.count = 1 Then
      Cart.Text = Rpl!coderpl1
      Art_man(Cart.Text)
      Art_Rpl()
      ArtQte.SetFocus
      ArtQte.Select
    Endif
  Endif
  
End

Public Sub Art_Rpl()
  
  Dim Rpl As Result
  Dim prodru As String = Cart.Text
  
  If stk And Val(Qte.Text) <= 0 And If Tp = "B" Or Tp = "F" Then
    Rpl = utils.db.Exec("SELECT *  From " & Cbase.Table("TabRpl1") & " Left join " & Cbase.Table("TabArt") & " on art_code = coderpl1 WHERE codep = &1 order by coderpl1", Cart.Text)
    If Rpl.count > 1 Then
      hcol.Columns.Count = 3
      hcol.Columns[0].Width = 180
      hcol.Columns[0].Text = "Code"
      hcol.Columns[1].Width = 470
      hcol.Columns[1].Text = "Désignation"
      hcol.Columns[2].Width = 80
      hcol.Columns[2].Text = "Quantité"
      Repeat
        If Rpl!art_qte > 0 Then
          hcol.Add(Rpl!coderpl1, Rpl!coderpl1)
          hcol.item[0] = Rpl!art_code
          hcol.item[1] = Rpl!art_design
          hcol.item[2] = Rpl!art_qte
        Endif
      Until Rpl.MoveNext()
      If hcol.count = 1 Then
        Cart.Text = hcol.current[0]
        If start.son Then
          Music.Play
        Endif
        Balloon.Info(("Le produit " & prodru & " est en rupture de stock il est remplacé par " & Cart.Text), Cart)
        Wait 2
        Art_man(Cart.Text)
        ArtQte.SetFocus
        ArtQte.Select
      Else
        If hcol.count > 1 Then
          Panel11.Visible = True
          If start.son Then
            Music.Play
          Endif
          Balloon.Info(("Le produit " & prodru & " est en rupture de stock, veuillez sélectionner un produit de remplacement SVP ! " & Cart.Text), hcol)
          hcol.SetFocus
        Endif
      Endif
    Else
      If Rpl.count = 1 Then
        If Val(Utils.cpoint(Rpl!art_qte)) > 0 Then
          Cart.Text = Rpl!coderpl1
          If start.son Then
            Music.Play
          Endif
          Balloon.Info(("Le produit " & prodru & " est en rupture de stock il est remplacé par " & Cart.Text), Cart)
          Wait 2
          Art_man(Cart.Text)
          ArtQte.SetFocus
          ArtQte.Select
        Else
          If start.son Then
            Music.Play
          Endif
          If message.Question("Ce produit n'est plus en stock et il n'y a plus de produits de remplacement\nVoulez-vous continuer la saisie avec ce produit ?", "Oui", "Non") = 1 Then
          Else
            Cleanart()
            Cart.SetFocus
          Endif
        Endif
      Endif
    Endif
  Endif
  
End

Public Sub hcol_click()
  
  Cart.Text = hcol.current[0]
  hcol.Clear
  Panel11.visible = False
  Art_man(Cart.Text)
  Art_Rpl()
  
End

Public Sub hcol_Keypress()
  
  If Key.code = Key.Enter Then hcol_click()
  
  If Key.code = Key.Esc Or If Key.code = Key.f2 Then
    hcol.Clear
    Panel11.visible = False
    Cart.Clear
    Cart.SetFocus
  Endif
  
End

'**************************************
'* On Selectionne l'article saisi     *
'**************************************
Public Sub Art_man(Prod As String)
  
  Dim Remtypec As Result
  Dim Tbrem As String
  Dim Sk As String
  Dim Rarts, Tresult As Result
  
  TextLabel60.Hide
  Qte.Hide
  Tab = "Fiches_Art" 
  Tbrem = "Fiches_RemTypec" 
  chkfocus = 1
  With utils
    If Impfac <> 1 Then
      If Left$(Cart.Text, 1) = "*" Then
        Rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1", Mid$(Prod, 2, Len(Prod)))
      Else
        Rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where art_code = &1", Prod)
      Endif
      Qte.Text = "1"
      Artqte.Text = "1"
      If Not Rarts.Available Then
        Art_Equ()
        Return
        hcol.SetFocus
        'Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_cequ = &1", Cart.Text)
      Endif
      If Not Rarts.Available Then
        Rarts = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabArt") & " where art_refcentrale = &1", Cart.Text)
      Endif
      If Rarts.Available Then
        If Rarts!art_mat = 0 Or If IsNull(Rarts!art_mat) Then
          sk = .cpoint(Rarts!art_qte)
          If IsNull(sk) Then sk = "0"
          If Rarts!art_stocke And Settings["/Soc" & Start.Societe & "/Ctrlstk"] And Val(sk) <= 0 And If Tp = "B" Or Tp = "F" Then
            Try Message.Warning("Saisie impossible! Le stock de ce produit est égal ou inférieur à zéro.")
            Cleanart()
            Artpu.Clear
            b = 1
          Else
            Artdsg.text = Rarts!art_design
            If Not IsNull(Rarts!art_casier) And If Val(sk) > 0 And If Settings["/Soc" & Start.Societe & "/Casier"] <> 0 Then Artdsg.text = Rarts!art_casier & "- " & Artdsg.text
            If Not Rarts!art_stocke And If Settings["/Soc" & Start.Societe & "/Casier"] <> 0 Then Artdsg.text = "Dep- " & Artdsg.text
            If Rarts!art_stocke And If Val(sk) <= 0 And If Settings["/Soc" & Start.Societe & "/Casier"] <> 0 Then Artdsg.text = "Rupt- " & Artdsg.text
            Artdsg2 = Rarts!art_design2
            Artfam.Text = Rarts!art_fam
            Materiel = Rarts!art_mat
            $crst = Rarts!art_crst
            If Materiel Then Artqte.ReadOnly = True
            Nbd = Rarts!art_nbd
            Nbdec = .Find_Nbdec(Nbd)
            Paht = Format$(Rarts!art_paht, "0.000")
            Pmp = Rarts!art_pmp
            If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
            If Bdevis.Value = False Then
              If apromo = True Then
                Artpu.Text = Format$(ArtPromo.Prix_Promo(Cart.text, Cpromo), Nbdec)
                Artbrut.Text = Format(Val(Artpu.Text), Nbdec)
              Endif
              If apromo = True Then Balloon.Info(("Ce produit est actuellement en promotion"), Cart)
            Endif
            If retro.value = False Then
              If Apromo = False Then
                Artpu.Text = Format$(Rarts!art_pvht, Nbdec)
                Artbrut.Text = Format(Val(Artpu.Text), Nbdec)
                Artrm.Text = Txpieces.Text
              Else
                Artrm.Text = "0,00"
              Endif
            Else
              Artpu.Text = Format$(Rarts!art_paht * Val(Val_retro), Nbdec)
              Artbrut.Text = Artpu.Text
              Artrm.Text = "0,00"
            Endif
            If apromo = False Then
              If Retro.value = False And Not IsNull(Typec) And Val(Txpieces.Text) = 0 Then
                If Apromo = False Then
                  Remtypec = Utils.db.Exec("SELECT * FROM " & Tbrem & " where coder = &1 and codef = &2", Typec, Artfam.Text)
                  If RemTypec.Available And apromo = False Then
                    Artrm.Text = RemTypec!remise
                    RemType = Artrm.Text
                  Endif
                Endif
              Endif
              If Retro.value = False Then
                Remtypec = Utils.db.Exec("SELECT * FROM " & Cbase.Table("RemCliFam") & " where codec = &1 and codef = &2", Code.text, Artfam.Text)
                If RemTypec.Available Then
                  Artrm.Text = RemTypec!remise
                  RemType = Artrm.Text
                Endif
              Endif
            Endif
            arr = Rarts!art_cdarr
            Ecotaxe = Rarts!art_ect
            If Rarts!art_eco Then
              Try Valeur_Ecotaxe = Rarts!art_eco
            Endif
            Taxepv = Rarts!art_cpp
            If Rarts!art_copp Then
              Try Valeur_Copp = Rarts!art_copp
            Endif
            If Not tvar.Value Then
              Arttx.Text = Rarts!art_tva
              Arttx.ReadOnly = True
            Else
              Arttx.Text = Codetva
              Arttx.ReadOnly = False
            Endif
            Dec.Text = Rarts!art_dec
            Impcar = Rarts!art_impcar
            Intit = Rarts!art_crst
            Try Colvente = Rarts!art_colvte
            Try PVHT2 = Rarts!art_pvht2
            If Rarts!art_stocke Then Quantite()
            Artrm_LF()
            If retro.value = True Then Artqte_LF()
            If retro.value = True Or If Settings["/Soc" & Start.Societe & "/AutoEnt"] Then Arttc_LF()
            Pdx = Rarts!art_poids2
            If IsNull(Pdx) Then
              Pdx = "0,000"
              Pdxart.Text = Pdx
            Else
              Pdxart.Text = Format$(Pdx, "0.000")
            Endif
            If Not IsNull(typec) Then
              Tresult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCtcli") & " where coder = &1 and codef = &2", Typec, Artfam.Text)
              If Tresult.Available Then
                Balloon.Info(("Coefficient de vente par type client " & Typec), Cart)
                Tcoeff = Tresult!coeff
                artpu.Text = Val(.cpoint(Rarts!art_prvt)) * Val(.cpoint(Tcoeff))
                Artpu_LF()
              Endif
            Endif
            Try Rms[0, 0] = Str(Rarts!qte1)
            Try Rms[0, 1] = Str(Rarts!qte2)
            Try Rms[0, 2] = Str(Rarts!rem1)
            Try Rms[1, 0] = Str(Rarts!qte3)
            Try Rms[1, 1] = Str(Rarts!qte4)
            Try Rms[1, 2] = Str(Rarts!rem2)
            Try Rms[2, 0] = Str(Rarts!qte5)
            Try Rms[2, 1] = Str(Rarts!qte6)
            Try Rms[2, 2] = Str(Rarts!rem3)
            Try Rms[3, 0] = Str(Rarts!qte7)
            Try Rms[3, 1] = Str(Rarts!qte8)
            Try Rms[3, 2] = Str(Rarts!rem4)
            Try Rms[4, 0] = Str(Rarts!qte9)
            Try Rms[4, 1] = Str(Rarts!qte10)
            Try Rms[4, 2] = Str(Rarts!rem5)
            Try Rms[5, 0] = Str(Rarts!qte11)
            Try Rms[5, 1] = Str(Rarts!qte12)
            Try Rms[5, 2] = Str(Rarts!rem6)
            If Left$(Cart.Text, 1) = "*" And Settings["/Soc" & Start.Societe & "/Qt1"] And Qte_Cbarre <> "1" Then
              Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
              Button11_Click()
            Endif
            If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
            If Val(Artpu.text) = 0 Then
              Artdsg.SetFocus
              Artdsg.Select
            Else
              ArtQte.SetFocus
              ArtQte.Select
            Endif
          Endif
        Else
          If Son Then
            Music.Play
          Endif
          Try message.Warning("Vous ne pouvez pas saisir de matériel dans une facture entretien ! ")
          b = 1
          Cart.SetFocus
          Cart.Select
        Endif
      Else
        If Son Then
          Music.Play
        Endif
        Try message.Warning(" Le code article " & Cart.Text & " n'existe pas ! ")
        b = 1
        Cart.Clear
        Cart.SetFocus
      Endif
      Cart.Background = Color.TextBackground
      Artbrut.Background = Color.TextBackground
      Artrm.Background = Color.TextBackground
      Artpu.Background = Color.TextBackground
      Arttc.Background = Color.TextBackground
      Artqte.Background = Color.TextBackground
      qte_Cbarre = "0"
      'modif = "0"
    Else
      If Son Then
        Music.Play
      Endif
      Try Message.Warning(" La facture a été imprimée ! Ajout d'article impossible.")
      b = 1
      Cart.Clear
      Cart.SetFocus
      Cart.Select
    Endif
  End With
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub Arttx_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then arttx_LostFocus()
  
End

Public Sub arttx_LostFocus()
  
  Artqte_LF()
  Arttc.SetFocus
  Arttc.Select
  
End

'**********************************************************
'*           Affichage des quantites en stock             *
'**********************************************************
Public Sub Quantite()
  
  Tab = "Fiches_Art" 
  With utils
    rResult = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Cart.text)
    If rResult.Available Then
      Stk = rResult!art_stocke
      Qte.Text = .CPoint(rResult!art_qte)
      If IsNull(qte.Text) Then qte.Text = "0"
    Endif
    If Stk Then
      TextLabel60.Show
      Qte.Show
      If Dec.Text = "0" Then Qte.Text = Format$(Val(Qte.Text), "0")
      If Dec.Text = "2" Then Qte.Text = Format$(Val(Qte.Text), "0.00")
      If Dec.Text = "3" Then Qte.Text = Format$(Val(Qte.Text), "0.000")
      If Val(Qte.Text) < 1 Then
        Qte.Background = &HEF3E1A&
      Else
        Qte.Background = &HD4D0C8&
      Endif
    Else
      TextLabel60.Hide
      Qte.Hide
    Endif
  End With
  
End

'***************************************************
'*        On calcule le montant de la marge        *
'***************************************************
Public Sub Calc_Marge()
  
  Dim rMrg As Result
  
  If Pmp = 0 Then
    rMrg = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFam") & " WHERE code_fam = &1", ArtFam.Text)
    Try Marge.Text = Format$(Val(Artnet.Text) / Val(Utils.cpoint(rMrg!coef_fam)), "0.00")
  Else
    Try Marge.Text = Format$((Val(Artnet.Text)) - (Pmp * Val(Utils.cpoint(Artqte.Text))), "0.00")
  Endif
  
End

'****************************
'* Gestion du panel Art     *
'****************************
Public Sub Art_Mouseup()
  
  If Chkf = 1 Then
    Chkfocus = 0
  Else
    chkfocus = 1
  Endif
  
End

Public Sub Art_Change()
  
  Chkf = 1
  
End

Public Sub Art_KeyPress()
  
  T = 0
  If key.Code = key.F4 Then
    ChkFocus = 2
    Articles.ShowModal()
    Chkfocus = 0
  Endif
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        ChkFocus = 2
        If Cart.Text = "" Then
          If Son Then
            Music.Play
          Endif
          Try Message.Warning("Veuillez saisir un article SVP", "Ok")
          Cart.SetFocus
          Cart.Select
        Else
          If Lbarre = 1 Then
            Cart.text = "*" & Cart.Text
            Lbarre = 0
          Endif
          If Left$(Cart.Text) = "*" Then
            Artbarre = "1"
            Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
            Cart.Text = "*" & Utils.Find_Cbarre(Cart.Text)
            Wait 0.2
            Art_Man(Cart.Text)
          Else
            Artbarre = "0"
            Art_Man(Cart.Text)
          Endif
        Endif
        Stop Event
        
      Case 2
        ChkFocus = 2
        Artdsg.Text = Utils.Remplace(Artdsg.Text)
        If Not Cart.Text Then
          Try Message.Warning("Veuillez saisir un article SVP", "Ok")
          Cart.SetFocus
          Cart.Select
        Else
          If Not Artdsg.Text Then
            Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
            Artdsg.SetFocus
            Artdsg.Select
          Else
            Artpu.SetFocus
            Artpu.Select
          Endif
        Endif
        Stop Event
        
      Case 3
        ChkFocus = 2
        Artpu_LF()
        If b = 1 Then
          Artpu.SetFocus
          Artpu.Select
          B = 0
        Else
          Artqte.SetFocus
          Artqte.Select
        Endif
        Stop Event
        
      Case 4
        ChkFocus = 2
        Artqte_LF()
        If b = 1 Then
          Artqte.SetFocus
          Artqte.Select
          b = 0
        Else
          'Montante = Val(Artbrut.Text)
          Button11.SetFocus
        Endif
        Stop Event
        
      Case 5
        ChkFocus = 2
        Artbrut_LF()
        Arttc_LF()
        If b = 1 Then
          Artbrut.SetFocus
          Artbrut.Select
          b = 0
        Else
          Artrm.SetFocus
          Artrm.Select
        Endif
        Stop Event
        
      Case 6
        ChkFocus = 2
        Artrm_LF()
        If b = 1 Then
          Artrm.SetFocus
          Artrm.Select
          b = 0
        Else
          'Artnet_GF()
          Artnet.SetFocus
          Artnet.Select
        Endif
        Stop Event
        
      Case 7
        ChkFocus = 2
        Artnet_LF()
        Arttc_LF()
        If b = 1 Then
          Artnet.SetFocus
          Artnet.Select
          b = 0
        Else
          'Arttc_GF()
          Arttc.SetFocus
          Arttc.Select
        Endif
        Stop Event
        
      Case 8
        ChkFocus = 2
        Recup_Tva()
        Arttc_LF()
        If b = 1 Then
          Arttc.SetFocus
          Arttc.Select
          b = 0
        Else
          Button11.SetFocus
        Endif
        Stop Event
    End Select
  Endif
  
  If Key.code = Key.F2 Then
    Select Case Last.tag
        
      Case 1
        SelectionArt()
        Stop Event
      Case 2
        If Not IsNull($crst) Then Message.Info($crst)
        Stop Event
        
      Case 4
        If Not IsNull($crst) Then Message.Info($crst)
        Stop Event
    End Select
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
  Endif
  
  If key.code = key.F9 Then
    qte_Cbarre = "1"
  Endif
  
  '
  If Key.code = Key.F5 Then
    ChkFocus = 2
    hForm = New FCalc
    hForm.Showmodal()
    If Not IsNull(FCalc.Resultat) Then Last.Text = Format$(Val(FCalc.Resultat), "0.00")
    ChkFocus = 0
  Endif
  
End
'****************************
'* Gestion du panel Art     *
'****************************

Public Sub Art_Lostfocus()
  
  If chkfocus <> 2 Then
    Select Case Last.tag
        
      Case 1
        If chkfocus <> 1 Then
          If Cart.Text = "" Then
            If Not IsNull(Artdsg.text)
              'If start.son Then
              'Music.Play
              'Endif
              'Try Message.Warning("Veuillez saisir un article SVP", "Ok")
              CleanArt()
              Cart.SetFocus
              Cart.Select
            Endif
          Else
            If Left$(Cart.Text) = "*" Then
              Artbarre = "1"
              Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
              Cart.Text = "*" & Utils.Find_Cbarre(Cart.Text)
              Wait 0.2
              Art_Man(Cart.Text)
            Else
              Artbarre = "0"
              Art_Man(Cart.Text)
              Art_Equ()
              hcol.SetFocus
              Art_Rpl()
            Endif
          Endif
        Endif
        ChkFocus = 0
        Stop Event
        
      Case 2
        If chkfocus <> 1 Then
          Artdsg.Text = Utils.Remplace(Artdsg.Text)
          If Not Artdsg.Text Then
            If Not IsNull(Cart.Text) Then
              If start.son Then
                Music.Play
              Endif
              Try Message.Warning("Veuillez saisir une désignation SVP", "Ok")
              Artdsg.SetFocus
              Artdsg.Select
            Endif
            Stop Event
          Endif
        Endif
        ChkFocus = 0
        
      Case 3
        If chkfocus <> 1 Then
          Artpu_LF()
          If b = 1 Then
            Artpu.SetFocus
            Artpu.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 4
        If chkfocus <> 1 Then
          Artqte_LF()
          If b = 1 Then
            Artqte.SetFocus
            Artqte.Select
            b = 0
          Else
            If Pdxart.text Then Pdxart.Text = Format$((Val(Utils.cpoint(Artqte.Text)) * Val(Utils.cpoint(Pdx))), "0.000")
            Button11.SetFocus
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 5
        If chkfocus <> 1 Then
          Artbrut_LF()
          Arttc_LF()
          If b = 1 Then
            Artbrut.SetFocus
            Artbrut.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 6
        If chkfocus <> 1 Then
          Artrm_LF()
          If b = 1 Then
            Artrm.SetFocus
            Artrm.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 7
        If chkfocus <> 1 Then
          Artnet_LF()
          Arttc_LF()
          If b = 1 Then
            Artnet.SetFocus
            Artnet.Select
          Endif
          Stop Event
        Endif
        chkfocus = 0
        
      Case 8
        If chkfocus <> 1 Then
          Recup_Tva()
          Arttc_LF()
          Stop Event
        Endif
        chkfocus = 0
    End Select
  Endif
  
End

'**************************************
'* Gestion des actions  du panel Art  *
'**************************************

Public Sub Artpu_LF()
  
  With utils
    Artpu.Text = .CPoint(Artpu.Text)
    If Val(Artpu.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Val(Artpu.text) <> 0 Then
        If Nbdec Then Artpu.Text = Format$(Val(Artpu.Text), Nbdec)
        Artqte_LF()
        b = 0
      Else
        Artrm.text = "0,00"
        Artpu.Text = "0,00"
        Artnet.Text = "0,00"
        Arttc.Text = "0,00"
      Endif
    Endif
    T = 0
  End With
  
End

Public Sub Artqte_LF()
  
  With utils
    Artqte.Text = .CPoint(Artqte.Text)
    If Val(Artqte.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Decimal()
      If InStr(Artqte.text, ",") = 1 Or If InStr(Artqte.text, ",") = 1 And dec.Text = "0" Then
        Try message.Warning("Vous ne pouvez pas saisir de décimales sur ce produit ! \n Si vous avez besoin de décimales veuillez modifier la case Décimale")
        b = 1
      Else
        If Colvente <> 0 And Val(Artqte.Text) >= Colvente Then Artpu.Text = Format$(Val(Utils.CPoint(PVHT2)), Nbdec)
        If Val(Artbrut.Text) <> 0 Or If Val(Artpu.text) <> 0 Then
          Artbrut.Text = Artpu.Text
          If Apromo = False Then Remises_quantitatives()
          Decimal()
          If Nbdec Then Artbrut.Text = Format$(Val(.CPoint(Artpu.Text)) * Val(.CPoint(Artqte.Text)), Nbdec)
          If Val(Artrm.text) <> 0 Then
            Try Artnet.Text = Format$(Val(.CPoint(Artbrut.Text)) - (Val(.CPoint(Artbrut.Text)) * Val(.CPoint(Artrm.Text)) / 100), Nbdec)
          Else
            Artnet.Text = Format(Val(Artbrut.Text), Nbdec)
          Endif
          b = 0
          T = 1
          Calcttc()
          Arttc_LF()
          'Calc_Marge()
          Button11.SetFocus()
        Else
          Artrm.text = "0,00"
        Endif
      Endif
    Endif
  End With
  
End

'****************************************
'*        On récupère les remises       *
'****************************************
Public Sub Remises_quantitatives()
  
  Dim i As Integer
  
  With Utils
    If Val(Artrm.Text) = 0 Then
      If IsNull(Remtype) Then Remtype = 0
      For i = 0 To Rms.Bounds[0] - 1
        If IsNull(Rms[i, 2]) Then
          Try Artrm.Text = Val(Artrm.Text) + RemType
          If Error Then Artrm.Text = Val(Artrm.Text)
          Break
        Else
          If Val(Utils.cpoint(Artqte.Text)) >= Val(.Cpoint(rms[i, 0])) And Val(Utils.cpoint(Artqte.Text)) <= Val(.Cpoint(rms[i, 1])) Then
            Try Artrm.Text = Val(Txpieces.Text) + RemType + Val(.Cpoint(Rms[i, 2]))
            If Error Then Artrm.Text = Val(Artrm.Text)
            Break
          Endif
        Endif
      Next
    Endif
  End With
  Artrm_LF()
  
End

Public Sub Artbrut_LF()
  
  With utils
    Artbrut.Text = .CPoint(Artbrut.Text)
    If Val(Artbrut.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Nbdec Then Artbrut.Text = Format$(Val(Artbrut.Text), Nbdec)
      If .CPoint(Artbrut.text) <> ChangeB Then
        chkfocus = 1
        If Son Then
          Music.Play
        Endif
        If Val(Artbrut.Text) <> 0 And Val(Artpu.text) <> 0 Then
          If message.Question(" Vous venez de modifier le prix brut HT. Voulez-vous \n 1- Modifier la quantité \n 2- Modifier le prix unitaire ", " 1 ", " 2 ") = "1" Then
            Artqte.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artpu.Text)))
            Decimal()
            B = 0
          Else
            If Nbdec Then Artpu.Text = Format(Val(Artbrut.Text) / Val(Utils.cpoint(Artqte.Text)), Nbdec)
            Calc_Marge()
            b = 0
          Endif
          Artrm_LF()
        Endif
        If Val(Artbrut.Text) = 0 Then
          Artrm.text = "0,00"
          Artpu.Text = "0,00"
          Artnet.Text = "0,00"
          Arttc.Text = "0,00"
        Endif
      Endif
    Endif
  End With
Catch
  
End

Public Sub Artrm_LF()
  
  With utils
    If Artrm.Text = "N" Or Artrm.Text = "n" Then
      Artrm.text = "0,00"
      pNet = True
      Balloon.Warning(("La mention 'Net' apparaitra sur la facture"), Artrm)
    Endif
    If Retro.value = False Then
      If IsNull(Artrm.Text) Then Artrm.Text = "0,00"
      Artrm.Text = .CPoint(Artrm.Text)
      If Val(Artrm.Text) = Null Then
        If chkfocus <> 1 Then
          If Son Then
            Music.Play
          Endif
          Try message.Warning("Veuillez verifier votre saisie SVP !")
          b = 1
        Endif
      Else
        T = 1
        If Bdevis.Value = False Then
          If apromo = True Then
            If modif = "1" Then Balloon.Warning((" Remise impossible, article en promotion"), Artrm)
            Artrm.Text = "0,00"
          Endif
        Endif
        If Val(Artrm.text) <= 100 Then
          Artrm.Text = Format$(Val(Artrm.Text), "00.00")
          If Nbdec Then Try ArtNet.Text = Format$(Val(.CPoint(Artbrut.Text)) - (Val(.CPoint(Artbrut.Text)) * Val(.CPoint(Artrm.Text)) / 100), Nbdec)
          b = 0
          Calcttc()
          Calc_Marge()
        Else
          b = 1
          If Son Then
            Music.Play
          Endif
          Try message.Warning("Saisie impossible ! Vous avez une remise supérieure à 100 %", "OK")
        Endif
      Endif
    Else
      If Val(Artrm.text) <> 0 Then
        Balloon.Warning((" Remise impossible en saisie de document rétrocession !"), Artrm)
        Artrm.Text = "0,00"
        'ArtNet.Text = Artpu.Text
      Else
        ArtNet.Text = Artpu.Text
      Endif
    Endif
  End With
  
End

Public Sub Artnet_GF()
  
  With utils
    If Not IsNull(artnet.Text) Then
      Artnet.Text = .CPoint(Artnet.Text)
      Artrm.Text = .CPoint(Artrm.Text)
      If Val(Artrm.Text) = Null Then
        If chkfocus <> 1 Then
          If Son Then
            Music.Play
          Endif
          Try message.Warning("Veuillez verifier votre saisie SVP !")
          b = 1
        Endif
      Else
        Artrm.Text = Format$(Val(Artrm.Text), "00.00")
        If Nbdec Then Artnet.Text = Format$(Val(Artnet.Text), Nbdec)
        ChangeP = .CPoint(Artnet.Text)
        b = 0
      Endif
    Endif
  End With
  
End

Public Sub Artnet_LF()
  
  Dim Msg As String
  
  With utils
    b = 0
    Artnet.Text = .CPoint(Artnet.Text)
    If Val(Artnet.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Val(Artnet.Text) = 0 And Val(Artrm.text) <> 100 Then
        Artrm.text = "0,00"
        Artpu.Text = "0,00"
        Artbrut.Text = "0,00"
        Artnet.Text = "0,00"
        Arttc.Text = "0,00"
      Else
        If Val(Artnet.Text) < Val(.cpoint(Paht)) * Val(Utils.cpoint(Artqte.Text)) And Val(Artrm.text) <> 100 Then
          If Son Then
            Music.Play
          Endif
          Balloon.Warning(("Votre prix de vente est inférieur au Prix d'achat !"), Artnet)
          b = 1
          Artnet.SetFocus
          Artnet.Select
        Else
          If Nbdec Then Artnet.Text = Format$(Val(Artnet.Text), Nbdec)
          If .CPoint(Artnet.Text) <> ChangeP Then
            chkfocus = 1
            Artrm.Text = "0,00"
            If Son Then
              Music.Play
            Endif
            If Bdevis.Value = False Then
              If apromo = True Then T = 1
            Endif
            If T = 1 Then
              ' Msg = " Le produit est arrondi au : " & arr & " " & devises & "\n le prix net HT à été recalculé. Voulez-vous \n 1- Modifier la remise \n 2- Modifier le prix Brut et le prix unitaire "
              If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
                If Nbdec Then Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Nbdec)
              Else
                If Nbdec Then Artbrut.Text = Format$(Val(Artnet.Text), Nbdec)
              Endif
              If Nbdec Then Artpu.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artqte.Text)), Nbdec)
            Else
              Msg = " Le produit est arrondi au : " & arr & " " & devises & "\n Vous venez de modifier le prix net HT. Voulez-vous \n 1- Modifier le prix Brut et le prix unitaire \n 2- Modifier la remise "
              If message.Question(Msg, " 1 ", " 2 ") = "2" Then
                Artrm.Text = Format(Val(.CPoint(Artbrut.Text)) - Val(.CPoint(Artnet.Text)), "00.00")
                Try Artrm.Text = Format$((Val(.CPoint(Artrm.Text)) * 100) / Val(.CPoint(Artbrut.Text)), "00.00")
                Calcttc()
              Else
                'Balloon.Warning((" Le produit est arrondi au : " & arr & " " & devises & "\n le prix net HT à été recalculé."), Artnet)
                If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
                  If Nbdec Then Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Nbdec)
                Else
                  If Nbdec Then Artbrut.Text = Format$(Val(Artnet.Text), Nbdec)
                Endif
                If Nbdec Then Artpu.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artqte.Text)), Nbdec)
              Endif
            Endif
            b = 0
            Calcttc()
            tx = (1 + Ttva / 100)
            If retro.value = False Then Artnet.Text = Format$(Val(Utils.CPoint(Arttc.Text)) / Tx, "0.00")
            If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
              If Nbdec Then Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Nbdec)
            Else
              If Nbdec Then Artbrut.Text = Format$(Val(Artnet.Text), Nbdec)
            Endif
            If Nbdec Then Artpu.Text = Format(Val(.CPoint(Artbrut.Text)) / Val(.CPoint(Artqte.Text)), Nbdec)
            'Calc_Marge()
          Endif
          b = 0
        Endif
        If Val(Artrm.text) > 100 Then
          b = 1
          If Son Then
            Music.Play
          Endif
          Try message.Warning("Saisie impossible ! Vous avez une remise supérieure à 100 %", "OK")
        Endif
      Endif
    Endif
  End With
  
End

Public Sub Arttc_LF()
  
  ChangeP = Utils.CPoint(Artnet.Text)
  Arttc.Text = Utils.Cpoint(Arttc.Text)
  If Val(Arttc.Text) = Null Then
    If chkfocus <> 1 Then
      If Son Then
        Music.Play
      Endif
      Try message.Warning("Veuillez verifier votre saisie SVP !")
      b = 1
    Endif
  Else
    tx = (1 + Ttva / 100)
    If retro.value = False Then Artnet.Text = Format$(Val(Utils.CPoint(Arttc.Text)) / Tx, "0.00")
    Artnet_LF()
    Calc_Marge()
  Endif
  
End

Public Sub Art_GotFocus()
  
  With Utils
    .SetEditColor(Me, Last)
  End With
  Cdfam.Background = &HD4D0C8&
  Nlg.Background = &HD4D0C8&
  If Qte.Text Then
    If Val(Qte.Text) <= 0 Then
      Qte.Background = &D47C0A&
    Else
      Qte.Background = &HD4D0C8&
    Endif
  Endif
  If Val(Marge.Text) <= 0 Then
    Marge.Background = &HEF3E1A&
  Else
    Marge.Background = &HD4D0C8&
  Endif
  Select Case Last.Tag
    Case 3
      ChgArt()
    Case 5
      ChgArt()
      Stop Event
    Case 6
      ChgArt()
      Stop Event
    Case 7
      ChgArt()
      Stop Event
    Case 8
      ChgArt()
      Stop Event
  End Select
  
End

Public Sub ChgArt()
  
  With Utils
    Changepu = .CPoint(Artpu.Text)
    Changeb = .CPoint(ArtBrut.Text)
    Changer = .CPoint(ArtRm.Text)
    Changep = .CPoint(ArtNet.Text)
    Changet = .CPoint(arttc.Text)
  End With
  
End

Public Sub ToggleButton3_Click()
  
  SelectionArt()
  
End

Public Sub ToggleButton6_Click()
  
  SelectionFam()
  
End

'*********************************
'* On enregistre le produit      *
'*********************************
Public Sub Button11_Keypress()
  
  'Dsg1.SetFocus
  'Dsg2.SetFocus 'sert à gerer la perte de focus
  If Key.code = 66 Then 'B
    Artbrut.SetFocus
    Artbrut.Select
  Endif
  If Key.code = 68 Then 'D
    Dec.SetFocus
    Dec.Select
  Endif
  If Key.code = 72 Then 'H
    ArtNet.SetFocus
    ArtNet.Select
  Endif
  If Key.code = 81 Then 'Q
    Artqte.SetFocus
    Artqte.Select
  Endif
  If Key.code = 80 Then 'P
    Artpu.SetFocus
    Artpu.Select
  Endif
  If Key.code = 82 Then 'R
    Artrm.SetFocus
    Artrm.Select
  Endif
  If Key.code = 84 Then 'T
    Arttc.SetFocus
    Arttc.Select
  Endif
  If Key.code = 76 Then 'L
    Artdsg.SetFocus
    Artdsg.Select
  Endif
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Button11_Click()
    Stop Event
  Endif
  
End

'****************************************************************
'* On mouvemente le panel Coldetail apres validation du produit *
'****************************************************************
'Public Sub Button11_Click()

'Dsg1.SetFocus
'Dsg2.SetFocus 'sert à gerer la perte de focus
'Stop Event

'End

'*********************************
'* On enregistre le produit      *
'*********************************
Public Sub Button11_Click()
  
  If b = 1 Then
    Cart.SetFocus
    Cart.Select
    b = 0
  Else
    If Cart.Text <> "" Then
      If Val(Artpu.text) = 0 Then
        If Message.Question("Le prix de ce produit est égal à  zéro !\n Confirmez-vous votre saisie ? ", "Oui", "Non") = 1 Then
          MajColdetailArt()
        Endif
      Else
        MajColdetailArt()
      Endif
      If Panel7.Visible = False Then
        Cart.SetFocus
        Cart.Select
      Endif
    Else
      If typeL = "E" Or typeL = "P" Then
        MajColdetailEco()
      Endif
    Endif
  Endif
  
End

Public Sub MajColdetailArt()
  
  Dim DecMat As String = ""
  
  Nvart = "0"
  Codeart = "0"
  Artdsg.Text = Utils.Remplace(Artdsg.Text)
  Produit = Cart.text
  Mnetht = artnet.Text
  Mnettc = Arttc.Text
  DecMat = Dec.Text
  Blocnum = Nlgart.text & Cart.text & Round(Rnd(1000, 9999))
  Mrg.Text = Format$(Val(Utils.cpoint(Mrg.text)) + Val(Utils.cpoint(Marge.text)), "0.00")
  Mrgart = Mrgart + Val(Utils.cpoint(Marge.text))
  Enrg_Art()
  Bloc = ""
  
End

Public Sub Enrg_Art()
  
  Dim lg As Integer = 1
  Dim sline As String
  
  If Coldetail.Count <> 0 And Settings["/Soc" & Start.Societe & "/Cqte"] <> "0" And Val(Utils.cpoint(Artqte.Text)) >= 0 Or If modif = "1" Then
    If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    Coldetail.MoveFirst
    Repeat
      Coldetail.Item.Selected = True
      If modif = "1" And Coldetail.Item[0] = NlgModif Or If Coldetail.Item[1] = Cart.Text And modif = "0" And Val(Utils.cpoint(Artqte.Text)) >= 0 And Left$(Coldetail.Item[4], 1) <> "-" Then
        If Modif <> "1" Then
          Artqte.Text = Val(Coldetail.Item[4]) + Val(Utils.cpoint(Artqte.Text))
          Decimal()
          PdxArt.text = Format$(Val(Utils.cpoint(Pdx)) * Val(Utils.cpoint(Artqte.Text)), "0.000")
        Else
          Artqte.Text = Val(Utils.cpoint(Artqte.Text))
          Decimal()
          PdxArt.text = Format$(Val(Utils.cpoint(Pdx)) * Val(Utils.cpoint(Artqte.Text)), "0.000")
        Endif
        Coldetail.Item[4] = Artqte.Text
        If Len(Artnet.text) - InStr(Artnet.text, ",") = 2 Then Coldetail.Item[7] = Artnet.text & "  "
        Qteecot = Val(Utils.cpoint(Artqte.Text))
        If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
        Nlgart.Text = Coldetail.Item[0]
        Codeart = Nlgart.Text
        Bloc = Coldetail.Item[16]
        Enrg_Ligart()
        Cart.SetFocus
        Cart.Select
        Nvart = "1"
        Stop Event
        Break
      Endif
    Until Coldetail.MoveNext()
  Endif
  If Nvart = "0" And modif <> "1" Or If Settings["/Soc" & Start.Societe & "/Cqte"] = "0" And modif <> "1" Then
    If T = 0 Then Artqte_LF()
    If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    If N = 1 Then Coldetail.Add(Nlgart.text, Nlgart.text)
    Coldetail.Item[0] = Nlgart.text
    If Left$(Cart.Text, 1) = "*" Then Cart.Text = Mid$(Cart.Text, 2, Len(Cart.Text))
    Coldetail.Item[1] = Cart.text
    Coldetail.Item[2] = Artdsg.text
    If Len(Artpu.text) - InStr(Artpu.text, ",") = 2 Then Coldetail.Item[3] = Artpu.text & "  "
    Coldetail.Item[4] = Artqte.text
    Qteecot = Val(Utils.cpoint(Artqte.Text))
    If Len(Artbrut.text) - InStr(Artbrut.text, ",") = 2 Then Coldetail.Item[5] = Artbrut.text & "  "
    If pNet = True Then
      Coldetail.Item[6] = "Net"
    Else
      Coldetail.Item[6] = Artrm.text
    Endif
    If Len(Artnet.text) - InStr(Artnet.text, ",") = 2 Then Coldetail.Item[7] = Artnet.text & "  "
    Coldetail.Item[9] = typeL
    If Len(Arttc.text) - InStr(Arttc.text, ",") = 2 Then Coldetail.Item[8] = Arttc.text & "  "
    Coldetail.Item[12] = Arttx.text
    Coldetail.Item[13] = ArtFam.text
    Coldetail.Item[14] = Dec.text
    Bloc = Nlgart.text & Cart.text & Round(Rnd(1000, 9999))
    Coldetail.Item[16] = Bloc
    Coldetail.Item[17] = PdxArt.text
    Enrg_Ligart()
    Cart.SetFocus
    Cart.Select
    If artdsg2 And Modif <> "1" Then
      Coldetail.MoveLast()
      Try Coldetail.Item.Selected = True
      If Not Error Then
        Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
        Coldetail.Add(Nlgart.text, Nlgart.text)
        Coldetail.Item[2] = Artdsg2
        Coldetail.Item[9] = typeL
        Coldetail.Item[14] = Dec.text
        Coldetail.Item[16] = Bloc
        Enrg_Ligart2()
      Endif
    Endif
    If Impcar = True And Modif <> "1" Then
      Coldetail.MoveLast()
      Try Coldetail.Item.Selected = True
      If Not Error Then
        Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
        For Each sline In Split(Intit, "\n")
          Coldetail.Add(Nlgart.text & Lg, Nlgart.text & Lg)
          Coldetail.Item[0] = Nlgart.text
          Coldetail.Item[2] = sline
          Coldetail.Item[9] = "R"
          Coldetail.Item[16] = Bloc
          Inc lg
        Next
        Enrg_Ligcar()
      Endif
    Endif
    If Bdevis.Value = False Then
      If apromo = True Then
        Coldetail.MoveLast()
        Try Coldetail.Item.Selected = True
        If Not Error Then
          Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
          Coldetail.Add(Nlgart.text, Nlgart.text)
          Coldetail.Item[2] = "*** Article " & Cart.text & " en promotion ***"
          Coldetail.Item[9] = "T"
          Coldetail.Item[14] = Dec.text
          Coldetail.Item[16] = Bloc
          Enrg_Promo()
        Endif
      Endif
    Endif
  Endif
  If ecotaxe And Upper$(Left$(TvaCli, 2)) = "FR" Or If ecotaxe And IsNull(TvaCli) Then Ecot()
  If Taxepv Then Txpp()
  Numligbl2 = Num.Text
  init()
  Majnumserie = 1
  Intit = ""
  
End

Public Sub init()
  
  Cleanart()
  BArt_Click()
  N = 1
  Nvart = "1"
  Artqte.Text = "1,00"
  Dec.Text = "2"
  modif = "0"
  Artqte.ReadOnly = False
  
End

'**********************************************************
'*                 Gestion onglet Saisie Famille         *
'**********************************************************
Public Sub SelectionFam()
  
  Tab = "Fiches_Fam" 
  ColFam.Clear
  If Colmo.Visible Then
    Colmo.Clear
    Colmo.Visible = False
    HBox8.Visible = False
  Endif
  If Colcom.Visible Then
    Colcom.Clear
    Colcom.Visible = False
  Endif
  If ColFam.Visible Then
    ColFam.Clear
    ColFam.Visible = False
  Else
    ColFam.Visible = True
    With ColFam
      .Columns.count = 3
      .Columns[0].Width = 70
      .Columns[1].Width = 160
      .Columns[2].Width = 60
      .Columns[0].Text = "Code"
      .Columns[1].Text = "Intitulé"
      .Columns[2].Text = "Code Tva"
    End With
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by code_fam")
    If rResult.Available Then
      Repeat
        With utils
          ColFam.Add(rResult!code_fam, rResult!code_fam)
          ColFam.Item[0] = rResult!code_fam
          ColFam.Item[1] = rResult!libell_fam
          ColFam.Item[2] = rResult!cdtva_fam
        End With
      Until rResult.MoveNext()
    Else
      If Son Then
        Music.Play
      Endif
      Try Message.Warning("Il n'existe aucune famille\n veuillez d'abord créer vos familles SVP ! ")
      ColFam.Clear
      ColFam.visible = False
    Endif
    If ColFam.Count Then
      ColFam.MoveFirst
      ColFam.SetFocus
      ColFam.Item.Selected = True
    Endif
  Endif
  
End

'****************************************
'* On Selectionne la famille saisie     *
'****************************************
Public Sub fam_man()
  
  Dim Rarts As Result
  
  Tab = "Fiches_Fam" 
  With utils
    Rarts = Utils.db.Exec("SELECT * FROM " & Tab & " where code_fam = &1", Artfam.Text)
    If Rarts.Available Then
      Artfam.Text = Rarts!code_fam
      Arttx.text = Rarts!cdtva_fam
      Try Calcttc()
    Else
      If Son Then
        Music.Play
      Endif
      Try message.Warning(" La famille " & Artfam.Text & " n'existe pas ! ")
      Artfam.SetFocus
      Artfam.clear
    Endif
  End With
  
End

'********************************************
'*  Saisie d'une famille a la souris        *
'********************************************
Public Sub Colfam_Click()
  
  Tab = "Fiches_Fam" 
  Artfam.Text = ColFam.Current[0]
  fam_Man()
  ColFam.Clear
  ColFam.visible = False
  
End

'*******************************************
'* Saisie d'une famille manuellement       *
'*******************************************
Public Sub Colfam_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Artfam.Text = ColFam.Current[0]
    Colfam_Click()
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    ColFam.visible = False
    ColFam.clear
    Artfam.Select
    Artfam.SetFocus
    Stop Event
  Endif
  
End

'*******************************************
'*       Gestion de l'eco taxe             *
'*******************************************
Public Sub Ecot()
  
  Dim Ect As String
  
  With Utils
    Artqte.Text = qteecot
    Decimal()
    Ect = "0"
    If Val(Artrm.Text) <> 100 Then
      Artrm.Text = "0,00"
      If Modif = "1" Then Ect = "1"
      Coldetail.MoveFirst()
      Repeat
        Coldetail.Item.Selected = True
        If Coldetail.Item[16] = Bloc And Coldetail.Item[9] = "E" Then
          Coldetail.Item[4] = Artqte.Text
          If Nbdec Then Coldetail.Item[5] = Format$(Val(Coldetail.Item[3]) * Val(Coldetail.Item[4]), Nbdec)
          If Len(Coldetail.Item[5]) - InStr(Coldetail.Item[5], ",") = 2 Then Coldetail.Item[5] = Coldetail.Item[5] & "  "
          Coldetail.Item[7] = Coldetail.Item[5]
          Ect = "1"
          N = 1
          Nlgart.Text = Format$(Coldetail.Item[0], "0000")
          Artdsg.Text = "Eco-participation"
          Artpu.text = Coldetail.Item[3]
          Artbrut.Text = Coldetail.Item[5]
          Artnet.Text = Coldetail.Item[7]
          Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
          typeL = "E"
          Enrg_Ligart()
          Cart.SetFocus
          Cart.Select
          Cleanart()
          BArt_Click()
          N = 1
          Break
        Endif
      Until Coldetail.MoveNext()
      If Ect <> "1" Then
        Coldetail.MoveLast()
        Coldetail.Item.Selected = True
        Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
        Artdsg.Text = "Eco-participation"
        Artpu.text = Format$(Valeur_Ecotaxe, Nbdec)
        Artbrut.Text = Artpu.Text
        If Nbdec Then Artnet.Text = Format$(Valeur_Ecotaxe * Val(.CPoint(Artqte.Text)), Nbdec)
        Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
        typeL = "E"
        N = 1
        MajColdetailEco()
        Ect = "0"
      Endif
    Endif
  End With
  
End

'*******************************************
'*       Gestion de la taxe copie privée   *
'*******************************************
Public Sub Txpp()
  
  Dim tcpp As String
  
  With Utils
    Artqte.Text = qteecot
    Decimal()
    tcpp = "0"
    If Val(Artrm.Text) <> 100 Then
      Artrm.Text = "0,00"
      If Modif = "1" Then Tcpp = "1"
      Coldetail.MoveFirst()
      Repeat
        Coldetail.Item.Selected = True
        If Coldetail.Item[16] = Bloc And Coldetail.Item[9] = "P" Then
          Coldetail.Item[4] = Artqte.Text
          If Nbdec Then Coldetail.Item[5] = Format$(Val(Coldetail.Item[3]) * Val(Coldetail.Item[4]), Nbdec)
          If Len(Coldetail.Item[5]) - InStr(Coldetail.Item[5], ",") = 2 Then Coldetail.Item[5] = Coldetail.Item[5] & "  "
          Coldetail.Item[7] = Coldetail.Item[5]
          Tcpp = "1"
          N = 1
          Nlgart.Text = Format$(Coldetail.Item[0], "0000")
          Artdsg.Text = "Taxe copie privée"
          Artpu.text = Coldetail.Item[3]
          Artbrut.Text = Coldetail.Item[5]
          Artnet.Text = Coldetail.Item[7]
          Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
          typeL = "P"
          Enrg_Ligart()
          Cart.SetFocus
          Cart.Select
          Cleanart()
          BArt_Click()
          Break
        Endif
      Until Coldetail.MoveNext()
      If Tcpp <> "1" Then
        Coldetail.MoveLast()
        Coldetail.Item.Selected = True
        Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
        Artdsg.Text = "Taxe copie privée"
        Artpu.text = Format$(Valeur_Copp, Nbdec)
        Artbrut.Text = Artpu.Text
        If Nbdec Then Artnet.Text = Format$(Valeur_Copp * Val(.CPoint(Artqte.Text)), Nbdec)
        Arttc.Text = Format$(Val(.CPoint(Artnet.Text)) + (Val(.CPoint(Artnet.Text)) * Ttva / 100), "0.00")
        typeL = "P"
        N = 1
        MajColdetailEco()
        Tcpp = "0"
      Endif
    Endif
  End With
  
End

Public Sub MajColdetailEco()
  
  Coldetail.Add(Nlgart.text, Nlgart.text)
  Coldetail.Item[0] = Nlgart.text
  Coldetail.Item[2] = Artdsg.text
  Coldetail.Item[3] = Artpu.text
  Coldetail.Item[4] = Artqte.text
  Coldetail.Item[5] = Artbrut.text
  Coldetail.Item[7] = Artnet.text
  Coldetail.Item[9] = typeL
  Coldetail.Item[8] = Arttc.text
  Coldetail.Item[12] = Arttx.text
  Coldetail.Item[14] = Dec.text
  Coldetail.Item[16] = Bloc
  Enrg_Ligart()
  Cart.SetFocus
  Cart.Select
  Cleanart()
  BArt_Click()
  N = 1
  Cart.Background = Color.TextBackground
  Artqte.Background = Color.TextBackground
  Artbrut.Background = Color.TextBackground
  Artrm.Background = Color.TextBackground
  Artpu.Background = Color.TextBackground
  Arttc.Background = Color.TextBackground
  
End

'***************************************************
'*    Maj de la quantite du stock en plus          *
'***************************************************
Public Sub Maj_Qte()
  
  Tab = "Fiches_Art" 
  With utils
    If Qte.Visible Then
      Decimal()
      'Qte.text = .CPoint(Qte.text)
      Qte.text = Val(.CPoint(Qte.text)) - Val(.CPoint(ArtQte.text))
    Endif
    Utils.db.Exec("UPDATE  " & tab & "  SET art_qte = &2 WHERE art_code = &1", Cart.Text, Qte.Text)
  End With
  
End

'***************************************************
'*    Maj de la quantite du stock en moins         *
'***************************************************
Public Sub Maj_Qtem()
  
  Tab = "Fiches_Art" 
  With utils
    If Qte.Visible Then
      Decimal()
      'Qte.text = .CPoint(Qte.text)
      Qte.text = Val(.CPoint(Qte.text)) + Val(.CPoint(ArtQte.text))
    Endif
    Utils.db.Exec("UPDATE  " & tab & "  SET art_qte = &2 WHERE art_code = &1", Cart.Text, Qte.Text)
  End With
  
End

Public Sub Cleanart()
  
  Cart.Text = ""
  Artdsg.Text = ""
  Artfam.Text = ""
  'Arttx.Text = ""
  Artpu.Text = "0,00"
  'Dec.Text = "2"
  'Artqte.Text = "1.00"
  Decimal()
  Artbrut.Text = "0,00"
  Artrm.Text = "0,00"
  Artnet.Text = "0,00"
  Arttc.Text = "0,00"
  Colvente = 0
  PVHT2 = 0
  Coldetail.MoveLast()
  Try Coldetail.Item.Selected = True
  If Not Error Then
    Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Else
    Nlgart.Text = Format$(Coldetail.count + 1, "0000")
  Endif
  Marge.Text = "0,00"
  Pdxart.Clear
  RemType = 0
  
End

'*********************************
'* Calcul du nombre de decimal   *
'*********************************
Public Sub Decimal()
  
  With Utils
    Artqte.Text = .CPoint(Artqte.Text)
    If IsNull(Val(Artqte.text)) Then Artqte.Text = "1"
    If DEC.text = "0" Then
      Artqte.Text = Format$(Val(Utils.cpoint(Artqte.Text)), "0")
    Else
      If DEC.text = "2" Then
        Artqte.Text = Format$(Val(Utils.cpoint(Artqte.Text)), "0.00")
      Else
        If dec.Text = "3" Then
          Artqte.Text = Format$(Val(Utils.cpoint(Artqte.Text)), "0.000")
        Endif
      Endif
    Endif
  End With
  
End

'*********************************
'* Gestion du bouton "Dec"       *
'*********************************
Public Sub Dec_Click()
  
  decimal()
  Artqte.SetFocus
  Artqte.Select
  
End

'*********************************
'* Calcul du Ht du produit       *
'*********************************
Public Sub CalcHt()
  
  With Utils
    tx = 1 + (Ttva / 100)
    Try Artrm.Text = .CPoint(Artrm.Text)
    If Val(Artrm.Text) = Null Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      Artrm.Text = Format$(Val(Artrm.Text), "00.00")
    Endif
    Arttc.Text = .CPoint(Arttc.Text)
    If Val(Arttc.Text) = Null Or Val(Arttc.Text) = 0 Then
      If chkfocus <> 1 Then
        If Son Then
          Music.Play
        Endif
        Try message.Warning("Veuillez verifier votre saisie SVP !")
        b = 1
      Endif
    Else
      If Apromo = False Then arrondi()
      Arttc.Text = Format$(Val(Arttc.Text), "0.00")
    Endif
    If Nbdec Then Artnet.Text = Format$(Val(.CPoint(Arttc.Text)) / Tx, Nbdec)
    If Val(Artrm.Text) <> 0 And Val(Artrm.Text) <> Null Then
      If Nbdec Then Artbrut.Text = Format$(Val(.CPoint(Artnet.Text)) / (1 - (Val(.CPoint(Artrm.Text)) / 100)), Nbdec)
    Else
      If Nbdec Then Artbrut.Text = Format(Val(Artnet.Text), Nbdec)
    Endif
    If Nbdec Then Artpu.Text = Format$(Val(.CPoint(Artbrut.Text)) / (Val(.CPoint(Artqte.Text))), Nbdec)
    If Nbdec Then Artpu.Text = Format$(Val(Artpu.Text), Nbdec)
  End With
  
End

'*********************************
'* Calcul du TTC du produit      *
'*********************************
Public Sub CalcTTC()
  
  Recup_Tva()
  Arttc.Text = Val(Utils.CPoint(Artnet.Text)) + (Val(Utils.CPoint(Artnet.Text)) * Ttva / 100)
  If Apromo = False Then arrondi()
  tx = 1 + (Ttva / 100)
  If Nbdec Then Artnet.Text = Format$(Val(Utils.CPoint(Arttc.Text)) / Tx, Nbdec)
  If Val(Artrm.text) = 0 Then Artnet.Text = Artbrut.Text
  If retro.value = True Then
    Artbrut.Text = Artnet.Text
    If Nbdec Then Artpu.Text = Format$(Val(Utils.CPoint(Artbrut.Text)) / (Val(Utils.CPoint(Artqte.Text))), Nbdec)
    If Nbdec Then Artpu.Text = Format$(Val(Artpu.Text), Nbdec)
  Endif
  
End

'************************
'* Recup de la Tva      *
'************************
Public Sub Recup_Tva()
  
  If Not exo.value Then
    Ttva = CPrix.CTva(Arttx.Text)
  Else
    Arttx.Text = ""
  Endif
  
End

'***********************************
'*        On gère l' arrondi       *
'***********************************
Public Sub arrondi()
  
  Try Arttc.Text = Utils.CPoint(Arttc.Text)
  If Not ArTTc.Text Then ArTTc.Text = "0,00"
  'IF arr = "0,01" THEN ArTTC.Text = Format$(ArTTC.Text, Nbdec)
  Arttc.Text = Format$(Val(Arttc.Text), "0.00")
  If retro.value = False Then
    If arr = "0,05" Then
      If Right$(ArTTc.Text) Like "[34567]*" Then
        ArTTC.Text = Left$(ArTTC.Text, (Len(ArTTC.Text) - 1)) & "5"
      Else
        ArTTC.Text = Round(Val(ArTTC.Text), -1)
        ArTTC.Text = Format$(ArTTC.Text, "0.00")
      Endif
    Endif
    
    If arr = "0,10" Then
      ArTTC.Text = Round(Val(ArTTC.Text), -1)
      ArTTC.Text = Format$(ArTTC.Text, "0.00")
    Endif
    
    If arr = "0,50" Then
      If Abs(Val(ArTTc.Text)) <= Abs(Val(Left$(ArTTc.Text, (Len(ArTTc.Text) - 2)) & 25)) Then
        ArTTC.Text = Left$(ArTTC.Text, (Len(ArTTC.Text) - 2)) & "00"
      Else
        If Abs(Val(ArTTc.Text)) <= Abs(Val(Left$(ArTTc.Text, (Len(ArTTc.Text) - 2)) & 75)) Then
          ArTTC.Text = Left$(ArTTC.Text, (Len(ArTTC.Text) - 2)) & "50"
        Endif
        If Abs(Val(ArTTc.Text)) >= Abs(Val(Left$(ArTTc.Text, (Len(ArTTc.Text) - 2)) & 76)) Then
          ArTTC.Text = Round(Val(ArTTC.Text))
          ArTTC.Text = Format$(ArTTC.Text, "0.00")
        Endif
      Endif
    Endif
    
    If arr = "1,00" Then
      ArTTC.Text = Round(Val(ArTTC.Text))
      ArTTC.Text = Format$(ArTTC.Text, "0.00")
    Endif
  Endif
  
End

'**********************************************************
'*           Gestion onglet Saisie Commentaires           *
'**********************************************************
Public Sub SelectionCom()
  
  Dim sline As String
  
  Tab = "Fiches_Commentaires" 
  With Colcom
    Colcom.Clear
    If Colmo.Visible Then
      Colmo.Clear
      Colmo.Visible = False
      HBox8.Visible = False
    Endif
    If ColFam.Visible Then
      ColFam.Clear
      ColFam.Visible = False
    Endif
    If Colcom.Visible Then
      Colcom.Clear
      Colcom.Visible = False
    Else
      ColCom.Visible = True
      .Columns.count = 2
      .Columns[0].Width = 70
      .Columns[1].Alignment = Align.TopLeft
      .Columns[1].Width = 350
      
      .Columns[0].Text = "Code"
      .Columns[1].Text = "Intitulé"
      rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by numcom")
      
      If rResult.Available Then
        Repeat
          Try .Add(rResult!numcom, rResult!numcom)
          If Not Error Then
            If Not Error Then
              For Each sline In Split(rResult!intitule, "\n")
                Colcom.Item[1] = sline
                Break
              Next
            Endif
          Endif
        Until rResult.MoveNext()
      Else
        If Son Then
          Music.Play
        Endif
        Try Message.Warning("Il n'existe aucun commentaire\n veuillez d'abord créer vos Textes SVP ! ")
        Colcom.Clear
        Colcom.visible = False
        
      Endif
      If Colcom.Count Then
        Colcom.MoveFirst
        Colcom.SetFocus
        Colcom.Item.Selected = True
      Endif
    Endif
  End With
  
End

'**********************************************
'* Selection d'un commentaire a la souris     *
'**********************************************
Public Sub Colcom_Click()
  
  Tab = "Fiches_Commentaires" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numcom = &1", Colcom.Current[0])
  Comcode.Text = Colcom.Current[0]
  intitule.Text = rResult!intitule
  Colcom.Visible = False
  intitule.setfocus
  intitule.select
  
End

'***********************************************
'* Saisie d'un commentaire manuellement        *
'***********************************************
Public Sub Colcom_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colcom_click()
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.Code = Key.Escape Or Key.Code = Key.F2 Then
    Colcom.visible = False
    Colcom.clear
    Comcode.Select
    Comcode.SetFocus
    Stop Event
  Endif
  
End

'*********************************
'* Gestion du panel "Com"        *
'*********************************
Public Sub com_KeyPress()
  
  If key.Code = key.F4 Then Comment.ShowModal()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        com_man()
        If b <> 1 Then
          intitule.SetFocus
          intitule.Select
        Endif
        b = 0
        Stop Event
        
      Case 2
        intitule.Text = Utils.Remplace(intitule.Text)
        Button12.SetFocus
    End Select
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If key.Code = key.F2 Then
    Select Case Last.tag
        
      Case 1
        SelectionCom()
    End Select
    Stop Event
  Endif
  
End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub com_GotFocus()
  
  With Utils
    .SetEditColor(Me, Last)
  End With
  Nlg.Background = &HD4D0C8&
  
End

Public Sub ToggleButton4_Click()
  
  Selectioncom()
  
End

Public Sub Button12_keypress()
  
  Button12_Click()
  
End

Public Sub Button12_Click()
  
  Dim sline As String
  Dim Lg As Integer = 1
  
  intitule.Text = Utils.ReplaceLb(intitule.Text)
  If IsNull(Comcode.Text) Then Comcode.text = " "
  If N = 1 Then
    For Each sline In Split(Intitule.Text, "\n")
      Coldetail.Add(Nlgcom.text & Lg, Nlgcom.text & Lg)
      Coldetail.Item[0] = Nlgcom.text
      Coldetail.Item[1] = Comcode.Text
      Coldetail.Item[2] = sline
      Coldetail.Item[9] = typeL
      Coldetail.Item[16] = Nlgcom.text & Comcode.Text
      Inc Lg
    Next
  Else
    Coldetail.MoveFirst()
    Repeat
      Coldetail.Item.Selected = True
      If Coldetail.Item[0] = NlgModif Then
        For Each sline In Split(Intitule.Text, "\n")
          Coldetail.Item[0] = Nlgcom.text
          Coldetail.Item[1] = Comcode.Text
          Coldetail.Item[2] = sline
          Coldetail.Item[9] = typeL
          Coldetail.Item[16] = Nlgcom.text & Comcode.Text
        Next
      Endif
      Break
    Until Coldetail.MoveNext()
  Endif
  Enrg_Ligcom()
  Comcode.Text = ""
  Nlgcom.Text = ""
  intitule.Text = ""
  Colcom.clear
  Coldetail.MoveLast()
  Coldetail.Item.Selected = True
  Nlgcom.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  Comcode.SetFocus
  Comcode.Select
  Comclick = 1
  com_Click()
  N = 1
  modif = "0"
  
End

Public Sub Button25_Click()
  
  Dim Tabresult As Result
  Dim Tabcom As String
  Dim Erg As Integer = 0
  
  Tabcom = "Fiches_Commentaires" 
  If IsNull(Comcode.Text) Then
    If Son Then
      Music.Play
    Endif
    Balloon.Warning(("Veuillez saisir un code commentaire SVP"), Comcode)
    Erg = 1
    Comcode.SetFocus
    Comcode.Select
  Endif
  Tabresult = Utils.db.Exec("SELECT * FROM " & Tabcom & " where numcom = &1", Comcode.Text)
  If TabResult.Available Then
    If Son Then
      Music.Play
    Endif
    Balloon.Warning(("Ce code est déjà attribué !"), Button25)
    Erg = 1
  Endif
  If Erg = 0 Then
    Utils.db.Exec("INSERT INTO " & tabcom & "(numcom, intitule) VALUES (&1, &2)", Comcode.Text, Intitule.Text)
    Balloon.Info(("Ce commentaire a été ajouté à la table des commentaires !"), Button25)
  Endif
  Erg = 1
  
End

'**********************************************************
'*                     Commentaire manuel                 *
'**********************************************************
Public Sub com_man()
  
  Tab = "Fiches_Commentaires" 
  If Comcode.Text <> "" Then
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numcom = &1", Comcode.Text)
    If rResult.Available Then
      Comcode.Text = rResult!numcom
      intitule.text = rResult!intitule
    Else
      If Son Then
        Music.Play
      Endif
      Try Message.Warning("Le commentaire " & Comcode.text & " n'existe pas !", "OK")
      Comcode.SetFocus
      Comcode.clear
      b = 1
    Endif
  Endif
  
End

'**********************************************************
'*                 Rappel des lignes validées             *
'**********************************************************
Public Sub Coldetail_Activate()
  
  Dim rrResult As Result
  Dim Lg As Integer = 0 'sert à gerer le saut de ligne des lignes de commentaire
  Dim l As String = ""
  Dim nlgc As String = ""
  
  Tab = "Fiches_LigblM" 
  Tab2 = "Fiches_Art" 
  Tab3 = "Fiches_Mo" 
  chkfocus = 1
  With utils
    If key.Code <> "4100" And If key.code <> "4101" Then
    Finally
      If Not Coldetail.Available Then
        Coldetail.clear
      Else
        Nlgapp = Coldetail.Item[0]
        typeL = Coldetail.Item[9]
        Bloc = Coldetail.Current[16]
        Nlgc = Coldetail.Current[0]
        NlgModif = Coldetail.Current[0]
        Nlgn = Nlgcom.text
        Txhr.ReadOnly = False
        Tmont.ReadOnly = False
        Tmont.Background = Color.TextBackground
        Txhr.Background = Color.TextBackground
        l = Left$(coldetail.Key, 4)
        
        '* On rappelle les lignes de main d'oeuvre
        If typel = "M" Then
          If Impfac <> "1" Then
            Motm.Value = True
            Panel2.visible = True
            Panel3.Visible = False
            Panel4.visible = False
            Nlg.text = Coldetail.Current[0]
            Cmo.text = Coldetail.Current[1]
            libelle.text = Coldetail.Current[2]
            Txhr.text = Coldetail.Current[3]
            Tmont.text = Coldetail.Current[4]
            Brutht.text = Coldetail.Current[5]
            rem.text = Coldetail.Current[6]
            Netht.text = Coldetail.Current[7]
            Tm.text = Coldetail.Current[10]
            Nettc.Text = Coldetail.Current[8]
            Tmo.Text = Coldetail.Current[12]
            Cdfam.Text = Coldetail.Current[13]
            rem.Text = Format$(Val(.CPoint(rem.Text)), "00.00")
            Nlgn = Nlg.text
            Brutht.Text = Format(Val(.CPoint(Tmont.Text)) * Val(.CPoint(Txhr.Text)), "0.00")
            rrResult = Utils.db.Exec("select * from " & Tab3 & " where mo_code = &1", Cmo.text)
            If rrResult.Available Then
              Arr = rrResult!mo_cdarr
            Endif
            Calc_Net()
            Calc_Tc()
            libelle.Select
            libelle.SetFocus
            If Not tvar.Value Then
              Tmo.readonly = True
            Else
              Tmo.readonly = False
            Endif
            Calc_MargeMo()
          Else
            Try Message.Warning("Modification impossible, la facture a été imprimée ?")
          Endif
        Endif
        
        '* On rappelle les lignes de produits
        If typel = "A" Then
          If Impfac <> "1" Then
            Panel2.visible = False
            Panel3.Visible = True
            Panel4.visible = False
            BArt.Value = True
            TextLabel60.Hide
            Qte.Hide
            Qte.Text = "0"
            Nlgart.text = Coldetail.Current[0]
            Cart.text = Coldetail.Current[1]
            Artdsg.text = Coldetail.Current[2]
            Artpu.text = Coldetail.Current[3]
            Dec.Text = Coldetail.Current[14]
            Artqte.text = Coldetail.Current[4]
            Artbrut.text = Coldetail.Current[5]
            If Coldetail.Current[6] = "Net" Then
              Artrm.Text = "0,00"
              pNet = True
            Else
              Artrm.text = Coldetail.Current[6]
              pNet = False
            Endif
            Artnet.text = Coldetail.Current[7]
            Arttc.Text = Coldetail.Current[8]
            Arttx.Text = Coldetail.Current[12]
            Artfam.Text = Coldetail.Current[13]
            Qte.Text = Coldetail.Current[15]
            PdxArt.Text = Coldetail.Current[17]
            Nlgn = Nlgart.text
            Artdsg.Select
            Artdsg.SetFocus
            rrResult = Utils.db.Exec("select * from " & Tab2 & " where art_code = &1", Cart.text)
            If rrResult.Available Then
              Materiel = rrResult!art_mat
              If Materiel Then Artqte.ReadOnly = True
              Nbdec = .Find_Nbdec(rrResult!art_nbd)
              Arr = rrResult!art_cdarr
              Paht = rrResult!art_paht
              Pmp = rrResult!art_pmp
              Pdx = rrResult!art_poids2
              If IsNull(Pdx) Then Pdx = "0,000"
              Try Ecotaxe = rrResult!art_ect
              Taxepv = rrResult!art_cpp
              Try Valeur_Copp = rrResult!art_copp
            Endif
            Calc_Marge()
            If Not tvar.Value Then
              Arttx.ReadOnly = True
            Else
              Arttx.ReadOnly = False
            Endif
            If Promo Then Apromo = ArtPromo.art_Promo(Cart.text, Cpromo)
          Else
            Try Message.Warning("Modification impossible, la facture a été imprimée ?")
          Endif
        Endif
        '* On rappelle les lignes de commentaires
        If typel = "C" Then
          Panel2.visible = False
          Panel3.Visible = False
          Panel4.Visible = True
          Com.Value = True
          Nlgcom.Text = Nlgc
          Comcode.Text = Coldetail.Current[1]
          Intitule.Clear
          Coldetail.MoveFirst()
          Repeat
            Try Coldetail.Item.Selected = True
            If Coldetail.Current[16] = Bloc Then
              If lg = 1 Then intitule.Insert("\n")
              intitule.Insert(Coldetail.Current[2])
              lg = 1
            Endif
          Until Coldetail.MoveNext()
          Coldetail.MoveFirst()
          Coldetail.Item.Selected = True
          While Left$(Coldetail.Key, 4) <> (Format$(Val(l), "0000"))
            Coldetail.MoveNext()
            Try Coldetail.Item.Selected = True
            If (Format$(Val(Left$(Coldetail.key, 4)), "0000")) = (Format$(Val(l), "0000")) Then Break
          Wend
        Endif
      Endif
      N = 0
      t = 0
      Modif = "1"
      'NlgModif = Coldetail.Current[0]
    Endif
  End With
  
End

Public Sub Coldetail_Click()
  
  chkfocus = 2
  
End

'**********************************************************
'*    Rappel, Suppression et déplacement de ligne         *
'**********************************************************
Public Sub Coldetail_Keypress()
  
  Dim l As String = ""
  Dim l3 As String = ""
  Dim l4 As String = "" ' valeur de la derniere ligne
  Dim l6 As String = "" ' valeur de la première ligne
  Dim nbl As Integer = 0
  Dim nbla As Integer = 1
  Dim np As Integer = 0
  Dim Blocp As String = ""
  Dim Type_Ligne As String = ""
  Dim Type_LigneR As String = ""
  Dim materiel As Result
  Dim Tabmat As String
  Dim Prod As Boolean = False
  Dim skey As String
  
  Tabmat = "Fiches_Materiels"
  If Coldetail.count > 0 Then
    'Coldetail.Item.Selected = True
    l = Left$(Coldetail.Key, 4)
    Type_Ligne = Coldetail.current[9] 'type de la ligne selectionnée
    Coldetail.MoveLast()
    Coldetail.item.Selected = True
    l4 = Coldetail.current[0] ' dernier numéro de ligne
    Coldetail.MoveFirst()
    Coldetail.item.Selected = True
    l6 = Coldetail.current[0] ' premier numéro de ligne
    If key.code = 42 Then
      Lbarre = 1
      Cart.SetFocus
    Endif
    Coldetail.MoveFirst()
    While Left$(Coldetail.Key, 4) <> (Format$(Val(l), "0000"))
      Coldetail.item.Selected = True
      Coldetail.MoveNext()
    Wend
    If Key.code = Key.Delete And Coldetail.Count <> 0 Then
      If Coldetail.current[9] = "M" Or Coldetail.current[9] = "A" Or Coldetail.current[9] = "C" Or Coldetail.current[9] = "O" Or Coldetail.current[9] = "R" Or If Coldetail.current[9] = "T" Or Coldetail.current[9] = "P" Or Coldetail.current[9] = "O" Or Coldetail.current[9] = "R" Or If Coldetail.current[9] = "T" Or Coldetail.current[9] = "E" Then
        If Impfac <> 1 Or If Coldetail.current[9] = "C" Then
          If start.son Then
            Music.Play
          Endif
          If Message.Question("Etes-vous sur de vouloir supprimer cette ligne ?", "Oui", "Non") = 1 Then
            l = Left$(Coldetail.Key, 4)
            Bloc = Coldetail.current[16]
            If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "O" Or If Coldetail.current[9] = "R" Then
              'Coldetail.MoveFirst()
              'For numl = 1 To Coldetail.count
              'Coldetail.item.Selected = True
              'Try l2 = Coldetail.current[16]
              'If Not Error Then
              'If Bloc = Coldetail.current[16] Then
              If Coldetail.current[9] = "T" And Left$(Coldetail.current[2], 17) = "Numéro de série" Then
                Materiel = Utils.db.Exec("SELECT * FROM " & tabmat & " WHERE mat_serie = &1", Coldetail.current[1])
                If Materiel.Available Then Utils.db.Exec("Update " & tabmat & " set mat_vendu = &1, mat_cli = &3 where mat_serie = &2", 0, Coldetail.current[1], "")
              Endif
              If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "O" Or If Coldetail.current[9] = "R" Then
                Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigblM") & " where block_ligbl = &1 and num_ligbl = &2", bloc, num2.Text)
              Else
                Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigblM") & " where numlig_ligbl = &1 and num_ligbl = &2", Coldetail.current[0], Num2.Text)
              Endif
              'Else
              'Coldetail.MoveNext()
              'Endif
              'Coldetail.MoveNext()
              'Endif
              'Next
            Else
              Utils.db.Exec("DELETE FROM " & Cbase.Table("TabLigblM") & " where numlig_ligbl = &1 and num_ligbl = &2", Coldetail.current[0], Num2.Text)
            Endif
            Modif = "0"
            Cleanart()
            Coldetail.Clear
            N = 1
            Recup_Ligbl()
            Ren_Ligbl()
            Maj_Base()
            Coldetail.Clear
            Recup_Ligbl()
            If Coldetail.count > 1 Then
              While Left$(Coldetail.Key, 4) <> (Format$(Val(l) - np, "0000"))
                Coldetail.MoveNext()
                Try Coldetail.item.Selected = True
                Coldetail.current.EnsureVisible
                If Error Then Break
              Wend
            Endif
          Endif
        Else
          If start.son Then
            Music.Play
          Endif
          If Coldetail.current[9] = "A"
            If start.son Then
              Music.Play
            Endif
            Try Message.Warning(" La facture a été imprimée ! Suppression d'une ligne d'article impossible.")
          Else
            If Coldetail.current[9] = "M"
              If start.son Then
                Music.Play
              Endif
              Try Message.Warning(" La facture a été imprimée ! Suppression d'une ligne de MO impossible.")
            Endif
          Endif
        Endif
        If Panel3.Visible = True Then
          Cart.SetFocus
        Else
          If Panel2.Visible = True Then
            Cmo.SetFocus
          Else
            If Panel4.Visible = True Then
              Comcode.SetFocus
            Endif
          Endif
        Endif
      Endif
    Endif
    If Key.code = Key.enter Or Key.code = Key.return Then
      If Coldetail.current[9] = "M" Or If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "C" Then
        Coldetail_Activate()
      Endif
    Endif
    
    ' On appuie sur la touche - pour faire remonter
    If key.code = 45 Then
      skey = Coldetail.Key
      l = Left$(Coldetail.Key, 4)
      l5 = l
      Bloc = Coldetail.current[16]
      blocp = l
      Prod = Rprodcomposes(Prod)
      If Prod = False Then
        Coldetail.MoveTo(skey)
        Try Coldetail.item.Selected = True
        If Val(l) > 1 Then
          ' On recupere le numero du bloc précédent ainsi que le type de ligne
          Do While Coldetail.current[16] = Bloc
            Coldetail.MovePrevious()
            Try Coldetail.item.Selected = True
            If Not Error Then
              If Coldetail.current[16] <> Bloc Then
                l3 = Coldetail.current[16]
                blocp = Coldetail.current[0]
                TypeL = Coldetail.current[9]
              Endif
            Else
              Break
            Endif
          Loop
          ' On compte le nombre de lignes du bloc précédent
          Repeat
            Try Coldetail.item.Selected = True
            If Not Error Then
              If Coldetail.current[16] = l3 Then
                np = np + 1
                If Coldetail.current[9] = "R" Then np = 1
              Else
                Break
              Endif
            Else
              Break
            Endif
          Until Coldetail.MovePrevious()
          If np = 0 Then np = 1
          If TypeL = "C" Then np = 1
          ' On renumerote les lignes du bloc séléctionné
          If Val(l) > Val(blocp) Then
            Coldetail.Movefirst()
            If Val(l) <= Val(L4) Then
              Repeat
                Try Coldetail.item.Selected = True
                If Error Then
                  Break
                Else
                  If Coldetail.current[16] = Bloc Then
                    Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) - np, "0000")
                    nbl = nbl + 1
                    If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "M" Or If Coldetail.current[9] = "T" Then nbla = nbla + 1
                    If Coldetail.current[9] = "R" Then nbl = nbla
                  Endif
                Endif
              Until Coldetail.MoveNext()
            Endif
            If Type_ligne = "C" Then nbl = 1
            ' On renumerote les lignes du bloc précédent
            Coldetail.Movefirst()
            If Val(l) > Val(l6) Then
              Repeat
                Try Coldetail.item.Selected = True
                If Error Then
                  Break
                Else
                  If Coldetail.current[16] = l3 Then
                    Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) + nbl, "0000")
                  Endif
                Endif
              Until Coldetail.MoveNext()
            Endif
            Maj_Base()
            Coldetail.Clear
            Recup_Ligbl()
            nbl = 0
            Coldetail.MoveFirst()
            Coldetail.item.Selected = True
            While Left$(Coldetail.Key, 4) <> (Format$(Val(l) - np, "0000"))
              Try Coldetail.item.Selected = True
              Coldetail.MoveNext()
            Wend
            Coldetail.current.EnsureVisible
            np = 0
            nbl = 0
          Endif
        Endif
      Else
        If start.son Then
          Music.Play
        Endif
        Message.Warning("Déplacement de ligne impossible avec des produits composés !")
      Endif
    Endif
    
    ' On appuie sur la touche + pour faire descendre
    If Key.Code = 43 Then
      skey = Coldetail.Key
      l = Left$(Coldetail.Key, 4)
      l5 = l
      Bloc = Coldetail.current[16]
      Prod = Rprodcomposes(Prod)
      If Prod = False Then
        Coldetail.MoveTo(skey)
        Try Coldetail.item.Selected = True
        ' On recupere le numero du bloc suivant ainsi que le type de ligne
        Do While Coldetail.current[16] = Bloc
          Coldetail.Movenext()
          Try Coldetail.item.Selected = True
          If Not Error Then
            If Coldetail.current[16] = Bloc Then l5 = Left$(Coldetail.Key, 4)
            If Coldetail.current[16] <> Bloc Then
              l3 = Coldetail.current[16]
              TypeL = Coldetail.current[9]
            Endif
          Else
            Break
          Endif
        Loop
        ' On compte le nombre de lignes du bloc suivant
        Repeat
          Try Coldetail.item.Selected = True
          If Not Error Then
            If Coldetail.current[16] <> Bloc Then
              If Coldetail.current[16] = l3 Then
                If Coldetail.current[9] <> "R" Then np = np + 1
                If Coldetail.current[9] = "R" Then Type_LigneR = "R"
              Endif
            Endif
          Else
            Break
          Endif
        Until Coldetail.MoveNext()
        If TypeL = "C" Then np = 1
        If Type_LigneR = "R" Then np = np + 1
        If np = 0 Then np = 1
        ' On renumerote les lignes du bloc séléctionné
        If Val(l5) < Val(l4) Then
          Coldetail.Movefirst()
          Repeat
            If Val(l) <= Val(L4) Then
              Try Coldetail.item.Selected = True
              If Error Then
                Break
              Else
                If Coldetail.current[16] = Bloc Then
                  Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) + np, "0000")
                  nbl = nbl + 1
                  If Coldetail.current[9] = "A" Or If Coldetail.current[9] = "M" Or If Coldetail.current[9] = "T" Then nbla = nbla + 1
                  Type_ligne = Coldetail.current[9]
                Endif
              Endif
            Endif
          Until Coldetail.MoveNext()
          If Type_ligne = "C" Then nbl = 1
          If Type_ligne = "R" Then nbl = nbla
          
          ' On renumerote les lignes du bloc suivant
          Coldetail.Movefirst()
          Repeat
            Try Coldetail.item.Selected = True
            If Error Then
              Break
            Else
              If Coldetail.current[16] = l3 Then Coldetail.current[0] = Format$(Val(Left$(Coldetail.Key, 4)) - nbl, "0000")
            Endif
          Until Coldetail.MoveNext()
          Maj_Base()
          Coldetail.Clear
          Recup_Ligbl()
          Coldetail.MoveFirst()
          Coldetail.item.Selected = True
          While Left$(Coldetail.Key, 4) <> Format$(Val(l) + np, "0000")
            Try Coldetail.item.Selected = True
            Coldetail.MoveNext()
          Wend
          Coldetail.current.EnsureVisible
          np = 0
          nbl = 0
        Endif
      Else
        If start.son Then
          Music.Play
        Endif
        Message.Warning("Déplacement de ligne impossible avec des produits composés !")
      Endif
    Endif
    Colbl.refresh
    If Bart.Value = True Then typeL = "A"
    If B2art.Value = True Then typeL = "A"
    If Motm.Value = True Then typeL = "M"
    If Com.Value = True Then typeL = "C"
  Endif
Catch
  If start.son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub Rprodcomposes(Prod As Boolean) As Boolean
  
  Prod = False
  Coldetail.MoveFirst()
  Repeat
    Try Coldetail.item.Selected = True
    If Not Error Then
      If Coldetail.current[9] = "O" Then
        Prod = True
        Break
      Endif
    Endif
  Until Coldetail.MoveNext()
  Return prod
  
End

'**********************************************************
'*                 Enregistrement lignes Bl               *
'**********************************************************

'* Pour la MO.
Public Sub Enrg_LigMo()
  
  Tab = "Fiches_LigblM" 
  With Utils
    If Cmo.Text <> "" Then
      'IF Tm.Text = "M" THEN Txhr.Text = Brutht.Text
      rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlg.text)
      If rResult.Available Then
        Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , code_ligbl = &3, libel_ligbl = &4, fam_ligbl = &5, pu_ligbl = &6, qte_ligbl = &7, brut_ligbl = &8, rem_ligbl = &9, netht_ligbl = &{10}, tx_ligbl = &{11}, nettc_ligbl = &{12}, typel_ligbl = &{13}, tm_ligbl = &{14}, mrgmo_ligbl = &{15}  WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlg.Text, Cmo.Text, libelle.Text, CdFam.Text, Txhr.Text, Tmont.Text, Brutht.Text, Rem.Text, Netht.Text, Tmo.Text, Nettc.Text, typeL, Tm.Text, .PointBase(MargeMo.text))
      Else
        Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, tm_ligbl, block_ligbl, mrgmo_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", num.Text, Nlg.Text, Cmo.Text, libelle.Text, CdFam.Text, Txhr.Text, Tmont.Text, Brutht.Text, Rem.Text, Netht.Text, Tmo.Text, Nettc.Text, typeL, Tm.Text, Bloc, .PointBase(MargeMo.text))
      Endif
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour les articles.
Public Sub Enrg_LigArt()
  
  Dim rm As String
  
  Tab = "Fiches_LigblM" 
  'IF typeL = "A" THEN Bloc = Nlgart.Text
  With Utils
    If pNet = True Then
      rm = "Net"
      pNet = False
    Else
      rm = Artrm.Text
    Endif
    If Cart.Text <> "" Or typeL = "E" Or typeL = "P" Then
      rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
      If rResult.Available Then
        Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , code_ligbl = &3, libel_ligbl = &4, fam_ligbl = &5, pu_ligbl = &6, qte_ligbl = &7, brut_ligbl = &8, rem_ligbl = &9, netht_ligbl = &{10}, tx_ligbl = &{11}, nettc_ligbl = &{12}, typel_ligbl = &{13}, dec_ligbl = &{14}, pdstotal_ligbl = &{15}, mrgart_ligbl = &{16}  WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Cart.Text, Artdsg.Text, ArtFam.Text, Artpu.Text, Artqte.Text, Artbrut.Text, Artrm.Text, Artnet.Text, Arttx.Text, Arttc.Text, typeL, Dec.Text, Val(Pdxart.text), .PointBase(Marge.Text))
      Else
        Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl, pdstotal_ligbl, mrgart_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", num.Text, Nlgart.Text, Cart.Text, Artdsg.Text, ArtFam.Text, Artpu.Text, Artqte.Text, Artbrut.Text, Artrm.Text, Artnet.Text, Arttx.Text, Arttc.Text, typeL, Dec.Text, Bloc, Val(Pdxart.text), .PointBase(Marge.Text))
      Endif
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour la mention promo.
Public Sub Enrg_Promo()
  
  Tab = "Fiches_LigblM" 
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , libel_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, "*** Article " & Cart.text & " en promotion ***", "T", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, libel_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlgart.Text, "*** Article " & Cart.text & " en promotion ***", "T", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour la deuxieme ligne de designation des articles.
Public Sub Enrg_LigArt2()
  
  Tab = "Fiches_LigblM" 
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , libel_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Artdsg2, "T", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, libel_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlgart.Text, Artdsg2, "T", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour les caractéristiques.
Public Sub Enrg_Ligcar()
  
  Tab = "Fiches_LigblM" 
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgart.text)
    If rResult.Available Then
      Utils.db.Exec("UPDATE  " & tab & "  SET  num_ligbl = &1 , numlig_ligbl = &2 , com_ligbl = &3, typel_ligbl = &4 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgart.Text, Intit, "R", Bloc)
    Else
      Utils.db.Exec("INSERT INTO " & tab & "(num_ligbl, numlig_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5)", num.Text, Nlgart.Text, Intit, "R", Bloc)
    Endif
    Coldetail.Clear
    Recup_ligbl()
  End With
  
End

'* Pour les commentaires
Public Sub Enrg_Ligcom()
  
  Tab = "Fiches_LigblM" 
  rResult = Utils.db.Exec("SELECT * FROM " & tab & " WHERE num_ligbl = &1 and numlig_ligbl = &2", num.text, Nlgcom.text)
  If rResult.Available Then
    Utils.db.Exec("UPDATE  " & tab & "  SET num_ligbl = &1, numlig_ligbl = &2, code_ligbl =&3, com_ligbl = &4, typel_ligbl = &5 WHERE num_ligbl = &1 and numlig_ligbl = &2", num.Text, Nlgcom.Text, Comcode.Text, intitule.Text, typeL)
  Else
    Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", num.Text, Nlgcom.Text, Comcode.Text, intitule.Text, typeL, Nlgcom.text)
  Endif
  Coldetail.Clear
  Recup_ligbl()
  
End

'**********************************************************
'*    Renumerotation lignes Bl apres suppression          *
'**********************************************************
Public Sub Ren_ligbl()
  
  Dim Bloc2 As String
  Dim Bloc3 As String
  Dim T As Integer = 1 ' variable pour init ligne
  
  If Coldetail.Count <> 0 Then
    Coldetail.MoveFirst
    Nlg.Text = "0001"
    Repeat
      Coldetail.Item.Selected = True
      If Coldetail.Item[9] = "C" Or If TypeL = "R" Then
        Coldetail.Item[0] = Nlg.Text
        Bloc3 = Nlg.Text
        If Coldetail.Item[16] = bloc Then
          'Coldetail.Item[16] = Bloc2
        Else
          Bloc2 = Nlg.Text
          Bloc = Coldetail.Item[16]
          If T <> 1 Then Nlg.Text = Format$(Val(Nlg.Text) + 1, "0000")
          Coldetail.Item[0] = Format$(Val(Nlg.Text), "0000")
          T = 0
        Endif
      Else
        If T <> 1 Then Nlg.Text = Format$(Val(Nlg.Text) + 1, "0000")
        Coldetail.Item[0] = Format$(Val(Nlg.Text), "0000")
        T = 0
      Endif
    Until Coldetail.MoveNext()
    If BArt.Value Then Nlgart.Text = Nlg.Text
    If Motm.value Then Nlg.Text = Nlg.Text
    If Com.value Then Nlgcom.Text = Nlg.Text
  Else
    Nlg.Text = "0001"
    NlgArt.Text = "0001"
    NlgCom.Text = "0001"
  Endif
  
End

'**********************************************************
'*                       Maj Base                         *
'**********************************************************
Public Sub Maj_Base()
  
  Dim Intit As String = ""
  Dim lg As Integer = 0
  Dim l3 As String
  Dim l4 As String ' on recupere le numero de la derniere ligne du commentaire
  Dim Colitem0 As String
  Dim Colitem1 As String
  Dim Colitem9 As String
  Dim Colitem16 As String
  
  Tab = "Fiches_LigblM" 
  Utils.db.Exec("DELETE FROM " & tab & " where num_ligbl = &1", num.Text)
  Coldetail.MoveLast()
  Try l5 = Coldetail.Item[0]
  If Not Error Then
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
    Endif
    Repeat
      Coldetail.Item.Selected = True
      Bloc = Coldetail.Item[16]
      l3 = Bloc
      Colitem0 = Coldetail.Item[0]
      Colitem1 = Coldetail.Item[1]
      Colitem9 = Coldetail.Item[9]
      Colitem16 = Coldetail.Item[16]
      If Coldetail.Item[9] <> "C" And If Coldetail.Item[9] <> "R" Then
        Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl,  libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl, mrgart_ligbl, mrgmo_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", num.Text, Coldetail.Item[0], Coldetail.Item[1], Coldetail.Item[2], Coldetail.Item[13], Coldetail.Item[3], Coldetail.Item[4], Coldetail.Item[5], Coldetail.Item[6], Coldetail.Item[7], Coldetail.Item[12], Coldetail.Item[8], Coldetail.Item[9], Coldetail.Item[14], Coldetail.Item[16], Coldetail.Item[18], Coldetail.Item[19])
      Else
        Repeat
          If bloc <> Coldetail.Item[16] Then Break
          If Coldetail.Item[9] = "C" Or If Coldetail.Item[9] = "R" Then
            If lg = 1 Then intit = Intit & ("\n")
            intit = Intit & (Coldetail.Item[2])
            lg = 1
            Bloc = Coldetail.Item[16]
            l4 = Left$(Coldetail.Item[0], 4)
          Else
            Break
          Endif
        Until Coldetail.Movenext()
        Utils.db.Exec("INSERT INTO " & Tab & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl)VALUES (&1, &2, &3, &4, &5, &6)", num.Text, ColItem0, ColItem1, Intit, ColItem9, ColItem16)
        Intit = ""
        lg = 0
        If Val(l4) <> Val(l5) Then Coldetail.MovePrevious()
      Endif
    Until Coldetail.Movenext()
  Endif
  
End

'*****************************************
'* Maj de la quantite en stock en moins  *
'*****************************************
Public Sub Maj_Quantite()
  
  Dim Qstock As Float
  Dim Qline As Float
  Dim Tabmat As String
  Dim mat As Boolean
  
  Tab = "Fiches_Art" 
  Tabmat = "Fiches_Materiels" 
  With utils
    Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabArt") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE ")
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      Repeat
        Coldetail.Item.Selected = True
        If Coldetail.Item[9] = "A" Then
          rResult = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Coldetail.Item[1])
          If rResult.Available Then
            Stk = rResult!art_stocke
            Mat = rResult!art_mat
            If Stk Then
              Qline = Val(Coldetail.Item[4])
              Try Qstock = rResult!art_qte
              If Error Then Qstock = 0
              If qline < 0 Then
                Qstock = Qstock + Abs(Qline)
              Else
                Qstock = Qstock - Qline
              Endif
              Utils.db.Exec("UPDATE  " & tab & "  SET art_qte = &2 WHERE art_code = &1", Coldetail.Item[1], Qstock)
              If Mat Then Utils.db.Exec("UPDATE  " & tabmat & "  SET mat_vendu = &3 WHERE mat_code = &1 and mat_bl = &2", Coldetail.Item[1], Num.text, 1)
              If Promo Then Apromo = ArtPromo.art_Promo(Coldetail.Item[1], Cpromo)
              If Apromo = True Then ArtPromo.Maj_qteplus(Coldetail.Item[1], Cpromo, Qline)
            Endif
          Endif
        Endif
      Until Coldetail.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")
  
End

'**********************************************************
'*        Maj de la quantite en stock en plus            *
'**********************************************************
Public Sub Maj_Quantite2()
  
  Dim Qstock As Float
  Dim Qline As Float
  Dim Tabmat As String
  Dim mat As Boolean
  
  Tab = "Fiches_Art" 
  Tabmat = "Fiches_Materiels" 
  Utils.db.Exec("LOCK TABLES " & Cbase.Table("TabArt") & " WRITE, " & Cbase.Table("TabArtPromo") & " WRITE ")
  With utils
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      Repeat
        Coldetail.Item.Selected = True
        If Coldetail.Item[9] = "A" Then
          rResult = Utils.db.Exec("select * from " & Tab & " where art_code = &1", Coldetail.Item[1])
          If rResult.Available Then
            Stk = rResult!art_stocke
            Mat = rResult!art_mat
            If Stk Then
              Qline = Val(Coldetail.Item[4])
              Try Qstock = rResult!art_qte
              If Error Then Qstock = 0
              If qline < 0 Then
                Qstock = Qstock - Abs(Qline)
              Else
                Qstock = Qstock + Qline
              Endif
              Utils.db.Exec("UPDATE  " & tab & "  SET art_qte = &2 WHERE art_code = &1", Coldetail.Item[1], Qstock)
              If Mat Then Utils.db.Exec("UPDATE  " & tabmat & "  SET mat_vendu = &3 WHERE mat_code = &1 and mat_bl = &2", Coldetail.Item[1], Num.text, 0)
              If Promo Then Apromo = ArtPromo.art_Promo(Coldetail.Item[1], Cpromo)
              If Apromo = True Then ArtPromo.Maj_qteplus(Coldetail.Item[1], Cpromo, Qline)
            Endif
          Endif
        Endif
      Until Coldetail.Movenext()
    Endif
    Qline = 0
    Qstock = 0
  End With
  Utils.db.Exec("UNLOCK TABLES")
  
End

'**********************************************************
'*                    Suppression Bon                     *
'**********************************************************
Public Sub Bl_Suppr()
  
  Dim Blrslt As Result
  
  Tab2 = "Fiches_LigblM" 
  Tab = "Fiches_BlM" 
  If Not IsNull(num.text)
    If Son Then
      Music.Play
    Endif
    Blrslt = Utils.db.Exec("SELECT * FROM " & tab & " where numbl = &1", num.Text)
    If Blrslt!imp = "1" Then
      If Son Then
        Music.Play
      Endif
      Try Message.Warning("Suppression impossible, la facture a été imprimée !")
    Else
      If Message.Question("Etes-vous sur de vouloir supprimer ce bon ?", "Oui", "Non") = 1 Then
        Utils.db.Exec("DELETE FROM " & tab & " where numbl = &1", num.Text)
        Utils.db.Exec("DELETE FROM " & tab2 & " where num_ligbl = &1", num.Text)
        If Tp = "B" Or Tp = "F" Then Maj_Quantite2()
        CleanChamps()
        CleanChampsMat()
        Coldetail.Clear
        Form_Open()
      Endif
    Endif
    code.Background = Color.TextBackground
    Button8.Visible = False
    Button6.Visible = True
  Endif
Catch
  
End

'**********************************************************
'*   Activation de l'écran d'édition des documents        *
'**********************************************************
Public Sub Bl_Edit()
  
  Dim Blent As Result
  Dim rParam As Result
  Dim jnal As String
  Dim Vic As String
  Dim Vichq As String
  Dim Viautre As String
  Dim modreg As String
  
  Tab = "Fiches_Bl"
  Blent = Utils.db.Exec("SELECT cli_reg, cli_expl, cli_cdech FROM " & Cbase.Table("TabCli") & " where cli_code = &1", code.Text)
  modreg = Blent!cli_reg
  Nbexpl.text = Blent!cli_expl
  ech = Blent!cli_cdech
  Tab = "Fiches_BlM" 
  Nbexpl.text = "1"
  Blent = Utils.db.Exec("SELECT * FROM " & tab & " where numbl = &1", num.Text)
  If Rgmt.value Then
    Regmt.text = Blent!reg
    If IsNull(Regmt.Text) Then Regmt.Text = Modreg
  Else
    Regmt.text = ""
  Endif
  Imp = Blent!imp
  Dfac = Utils.Cdate_Aff(Blent!dtefac)
  Nmfac = Blent!numfac
  rParam = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
  If rParam.Available Then
    Jnal = rParam!jrnal2
    Vic = rParam!viremc
    Vichq = rParam!viremchq
    Viautre = rParam!virema
  Endif
  If Jnal = "" Or If Vic = "" Or If Vichq = "" Or If Viautre = "" Then
    Message.Error("Vous devez completer les données relatives au journal de caisse \net aux comptes de virements internes avant d'imprimer vos documents !")
  Else
    Edit.Visible = True
    If Bbon.value = True Then Gest_AdrBL()
    If Imp <> "1" And BFac.value Then
      Rglt.text = Tottc.Text
      If Settings["/Soc" & Start.Societe & "/Rglt"] Then
        Rgmt.Value = True
        HBox5.Visible = True
      Else
        HBox5.Visible = False
        Label1.visible = True
        Regmt.Visible = True
      Endif
      Rglt.ReadOnly = False
      Regmt.Enabled = True
      Rgmt.Enabled = True
    Else
      Rglt.Text = Blent!mtreg
      HBox5.Visible = True
      Rglt.ReadOnly = True
      Regmt.Enabled = False
      Rgmt.Enabled = False
    Endif
    Try Recap.Value = Settings["/Soc" & Start.Societe & "/Recap"]
    Try Impttc.Value = Settings["/Soc" & Start.Societe & "/Impttc"]
    Try Entete.Value = Settings["/Soc" & Start.Societe & "/Entete"]
    Try Reserve.Value = Settings["/Soc" & Start.Societe & "/Conditions"]
    Try Pied.Value = Settings["/Soc" & Start.Societe & "/Pied"]
    Try ChxImp.value = Settings["/Soc" & Start.Societe & "/ChxImp"]
    If Settings["/Soc" & Start.Societe & "/AutoEnt"] Then Impttc.Enabled = False
    If Not Error Then
      If Imp = "1" Then
        dtef.Text = Utils.Cdate_Aff(Blent!dtefac)
        dtef.ReadOnly = True
        Dtech.ReadOnly = True
        Regmt.text = Blent!reg
      Else
        dtef.Text = Format$(Now, "dd.mm.yyyy")
        dtef.ReadOnly = False
        Dtech.ReadOnly = False
      Endif
      If Imp = "1" Then
        Dtech.text = Utils.Cdate_Aff(Blent!ech)
      Else
        Dtech.text = dateEcheance(Ech)
      Endif
      If Dtech.text = ".." Then Dtech.text = Dtef.Text
      Edt_gotfocus()
    Else
      If Son Then
        Music.Play
      Endif
      Try Message.Warning("Veuillez completer vos références SVP !", "OK")
    Endif
  Endif
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  
End

Public Sub Gest_AdrBL()
  
  Dim rcli As Result
  
  rCli = Utils.db.Exec("select * from " & Cbase.Table("TabCli") & " where cli_code = &1", Code.Text)
  If Not IsNull(rCli!cli_nom2) Then
    Nombl.Text = rcli!cli_rs_soc2 & " " & rCli!cli_nom2 & " " & rCli!cli_pnm2
    Adr1bl.Text = rCli!cli_adr12
    Adr2bl.Text = rCli!cli_adr22
    cpbl.Text = rCli!cli_cd_ptl2
    Villebl.text = rCli!cli_ville2
    Edit2.Visible = True
    AffBledit2.value = True
    Blch.value = False
    Nombl.SetFocus
    Nombl.Select
  Else
    Edit2.Visible = False
    AffBledit2.value = False
    Blch.Value = True
  Endif
  
End

Public Sub Edt_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        dtef.Text = Quittedate2(dtef.Text, Imp)
        Dtech.text = dateEcheance(Ech)
        If B = "1" Then
          dtef.SetFocus
          Dtef.Select
        Else
          dtef.Background = Color.TextBackground
          Dtech.SetFocus
          Dtech.Select
        Endif
        Stop Event
        
      Case 2
        Dtech.Text = Quittedate2(Dtech.Text, Imp)
        If B = "1" Then
          Dtech.SetFocus
          Dtech.Select
        Else
          Dtech.Background = Color.TextBackground
          Button14.SetFocus
        Endif
        Stop Event
        
    End Select
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
End

Public Sub Edt_gotfocus()
  
  Select Case Last.tag
    Case 1
      Try Utils.ObsGotf(dtef)
      Try Utils.ObsLstf(Dtech)
    Case 2
      Try Utils.ObsLstf(Dtef)
      Try Utils.ObsGotf(Dtech)
  End Select
  
End

'**********************************************************
'*             On controle la date d'échéance             *
'**********************************************************
Public Sub QuitteDateEch()
  
  Dtech.text = Utils.CDate_calc(Dtech.Text)
  Dtech.Text = Utils.Cdate_aff(Dtech.Text)
  If Dtech.Text = "00.00.0:00" Then
    Dtech.Text = Format$(Now, "dd.mm.yyyy")
    Dtech.SetFocus
    b = 1
  Else
    b = 0
  Endif
  
End

'**********************************************************
'*  On controle si la date du bon est dans les bornes     *
'**********************************************************
Public Sub QuitteDate()
  
  Tab = "Fiches_Parametres" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  dte = rResult!dtepc
  dte3 = Right$(dte, 4) & Left$(dte, 2)
  dte2 = rResult!dteclec
  ye2 = Right$(dte2, 4)
  If Not Settings["/Soc" & Start.Societe & "/Gestion"] Then Inc Ye2
  With utils
    Datej.text = .CDate_calc(datej.Text)
    Datej.Text = .Cdate_aff(Datej.Text)
    If Datej.Text = "00.00.0:00" Then
      Datej.Text = Format$(Now, "dd.mm.yyyy")
      Datej.SetFocus
    Else
      If Right$(Datej.text, 4) & Mid$(Datej.text, 4, 2) <= dte3 Then
        If Son Then
          Music.Play
        Endif
        If Message.Warning("Attention ! La date saisie est inférieure au début de la période en cours.", "Ok") = 1 Then
          Datej.SetFocus
          B = 1
        Endif
      Else
        If Right$(Datej.text, 4) & Mid$(Datej.text, 4, 2) & Left$(Datej.text, 2) > Ye2 & Left$(dte2, 2) & Mid$(dte2, 4, 2) Then
          If Son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! La date saisie est supérieure à  la date de fin d'exercice.", "Ok") = 1 Then
            Datej.SetFocus
            B = 1
          Endif
        Else
        Endif
      Endif
    Endif
  End With
  
End

Public Function QuitteDate2(dteco As String, imp As String) As String
  
  Dim dte4 As String
  
  Tab = "Fiches_Parametres" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
  dte = rResult!dtepp
  dte2 = Right$(dte, 4) & Left$(dte, 2)
  dte3 = rResult!dtepec
  If rResult!dtepec = "" Then
    Dte3 = Format$(Now, "mm.yyyy")
  Else
    'Dte3 = rResult!dtepec
    dte3 = Right$(dte3, 4) & Left$(dte3, 2)
  Endif
  If rResult!dtepp = "" Then
    Dte2 = Format$(Now, "mm.yyyy")
  Else
    Dte2 = rResult!dtepp
    dte2 = Right$(dte, 4) & Left$(dte, 2)
  Endif
  With utils
    dteco = .CDate_calc(dteco)
    dteco = .Cdate_aff(dteco)
    dte4 = rResult!dteclec
    If dteco = "00.00.0:00" Then
      dteco = Format$(Now, "dd.mm.yyyy")
      Editfac = "0"
    Else
      If Bfac.value = True Then
        If Right$(dteco, 4) & Mid$(dteco, 4, 2) < dte2 Then
          If Son Then
            Music.Play
          Endif
          If Message.Warning("Attention ! Impression de facture impossible. \n La date saisie est inférieure à la période précédente. \n Veuillez faire vos clotures SVP !", "Ok") = 1 Then
            Editfac = "0"
            Dtef.SetFocus
            Dtef.Select
            B = "1"
          Endif
        Else
          If Right$(dteco, 4) & Mid$(dteco, 4, 2) > dte3 Then
            If Son Then
              Music.Play
            Endif
            If Message.Warning("Attention ! Impression de facture impossible. \n La date saisie est supérieure à  la période en cours. \n Veuillez faire vos clotures mensuelles en facturation SVP", "Ok") = 1 Then
              Editfac = "0"
              Dtef.SetFocus
              Dtef.Select
              B = "1"
            Endif
          Else
            Editfac = "1"
            B = "0"
          Endif
        Endif
      Else
        b = "0"
      Endif
    Endif
  End With
  Return dteco
  
End

'**********************************************************
'*                Edition des documents                   *
'**********************************************************
Public Sub Button16_Click()
  
  Settings["/Soc" & Start.Societe & "/Recap"] = Recap.Value
  Settings["/Soc" & Start.Societe & "/Impttc"] = Impttc.Value
  Settings["/Soc" & Start.Societe & "/Entete"] = Entete.Value
  Settings["/Soc" & Start.Societe & "/Conditions"] = Reserve.Value
  Settings["/Soc" & Start.Societe & "/Pied"] = Pied.Value
  Settings["/Soc" & Start.Societe & "/ChxImp"] = ChxImp.Value
  Edit.Visible = False
  Edit2.Visible = False
  Visudoc = False
  
End

Public Sub Button21_Click()
  
  Visudoc = True
  QuitteDateEch()
  If b = 0 Then
    If Coldetail.count > 0 Or If Tp = "A" Then
      Impression("")
    Else
      If Tp <> "A" Then Message.Info("Visualisation impossible, vous n'avez saisi aucune ligne de détail !")
    Endif
  Endif
  b = 0
  
End

Public Sub Button14_Click()
  
  If visudoc = False Then Button14.Enabled = False
  Visudoc = False
  QuitteDateEch()
  If Val(Tottc.text) <> 0 Or If Val(Tottc.text) = 0 And Not BFac.value Then
    If Rgmt.Value = True And IsNull(regmt.Text) And Bfac.value Then
      Try Message.Warning("Vous n'avez pas saisi le mode de règlement!")
      If visudoc = False Then Button14.Enabled = True
      Regmt.SetFocus
    Else
      If b = 0 Then
        If Coldetail.count > 0 Then
          Impression("")
        Else
          Message.Info("Impression impossible, vous n'avez saisi aucune ligne de détail !")
        Endif
      Endif
      b = 0
    Endif
  Else
    If Bfac.value
      Try Message.Info("Vous ne pouvez pas imprimer une facture à zéro Euro!")
    Endif
  Endif
  
End

Public Function dateEcheance(Ech As String) As String
  
  Dim rech As Result
  Dim dureech As String
  Dim Jours As String
  Dim finmois As Boolean
  Dim Datef As String
  
  Tab4 = "Fiches_Echeances" 
  If ech Then
    rech = Utils.db.Exec("SELECT * FROM " & tab4 & " where num = &1", Ech)
    If rech.available Then
      dureech = rech!duree
      Jours = rech!jours
      finmois = rech!finmois
      Ech = "1"
    Else
      Ech = "0"
    Endif
  Else
    Ech = "0"
  Endif
  If Ech = "1" Then
    Datef = dtef.Text
    dateech = Utils.Calcech(dureech, Jours, Finmois, Datef)
  Else
    dateech = dtef.Text
  Endif
  Return dateech
  
End

Public Sub Impression(Org As String)
  
  Dim Tab1 As String
  Dim Tab5 As String
  Dim Tab6 As String
  Dim Tab7 As String
  Dim Tab8 As String
  Dim Tab9 As String
  Dim BlRslt As Result
  Dim Adr11 As String
  Dim Adr22 As String
  Dim Adr211 As String
  Dim Adr222 As String
  Dim Ville As String
  Dim Ville2 As String
  Dim Rs As String
  Dim Libre As String
  Dim Cde As String
  Dim Mail As String
  Dim Site As String
  Dim Rcs As String
  Dim Siret As String
  Dim Tvaintra As String
  Dim Cap As String
  Dim Ape As String
  Dim Iban As String
  Dim Tel, Tel2 As String
  Dim portable, portable2 As String
  Dim Fax As String
  Dim Ty As String
  Dim Code As String
  Dim intitule As String
  Dim Txtva As String 
  Dim Pu As String
  Dim Qte As String
  Dim Puttc As String
  Dim brutht As String
  Dim bruttc As String
  Dim rem As String
  Dim Totht As String
  Dim Totttc As String
  Dim Cptlig As Integer = 0
  Dim Txtbf As String
  Dim P As Integer 'Flag pour lignes si pied de facture
  Dim Npage As Float ' Flag pour calcul nombre de pageê
  Dim Pge As Integer ' numero de page
  Dim Page As String
  Dim Ech As String
  Dim Teco As Float
  Dim Toteco As String
  Dim Tmo As String
  Dim Tart As String
  Dim Trem As String
  Dim ye As Integer
  Dim mo As String
  Dim da As String
  Dim ArtRslt As Result
  Dim Logo As Image
  Dim Imagewidth As Integer
  Dim Imageheight As Integer
  Dim Tvarslt As Result
  Dim Pays As String
  Dim sline As String
  Dim nbline As Integer = 0
  Dim Cfac As Boolean = False
  
  Editfac = "1"
  b = "0"
  Pge = 1
  Totht = "0,00"
  Totttc = "0.00"
  Teco = 0
  Imagewidth = 1000
  Imageheight = 500
  Tab1 = "Fiches_BlM" 
  Tab2 = "Fiches_Societes"
  Tab3 = "Fiches_LibelFac" 
  Tab4 = "Fiches_Echeances" 
  Tab5 = "Fiches_Cli" 
  Tab6 = "Fiches_Art" 
  Tab7 = "Fiches_Mo" 
  Tab8 = "Fiches_Tvaav" 
  Tab9 = "Fiches_Parametres" 
  If Settings["/Soc" & Start.Societe & "/glogo"] Then Try Logo = Image.Load(Settings["/Soc" & Start.Societe & "/Logo"])
  Shell "cd " & User.Home & ""
  Filename = User.home & "/FactureMat.pdf"
  pdf = New Cdocuments("Portrait", "mm", "A4")
  pdf.Open()
  pdf.AliasNbPages()
  With Utils
    'Quittedate()
    ye = Right$(dtef.Text, 4)
    mo = Mid$(dtef.Text, 4, 2)
    da = Left$(dtef.Text, 2)
    Dtef.Text = Quittedate2(Dtef.Text, Imp)
    If b <> "1" Then 'test si la date est bonne
      If Editfac = "1" Then
        rResult = Utils.db.Exec("SELECT * FROM " & tab5 & " where cli_code = &1", Code3.Text)
        Ech = rResult!cli_cdech
        Cfac = rResult!cli_copie
        Tel2 = rResult!cli_tel_bur
        If IsNull(Tel2) Then tel2 = rResult!cli_tel_dom
        Portable2 = rResult!cli_pble
        If IsNull(Dtech.text) Then
          dateech = dateEcheance(Ech)
        Else
          dateech = Dtech.Text
        Endif
        Pays = rResult!cli_pays
        If Pays = "France" Then Pays = ""
        If Not IsNull(rResult!cli_id_tva) Then
          TvaCli = "Tva intracommunautaire " & rResult!cli_id_tva
        Else
          Tvacli = ""
        Endif
        Tmo = "0"
        Tart = "0"
        Trem = "0"
        Txtleg = ""
        Txtleg2 = ""
        If Not Regmt.Text Then
          Txtleg = "Règlement au " & dateech
        Else
          Txtleg = "Règlement par " & Regmt.Text & " au " & dateech
        Endif
        If Tp = "D" Then Txtleg = Settings["/Soc" & Start.Societe & "/Devis"]
        rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTleg") & "")
        If rResult.Available Then Txtleg2 = rResult!intitule
        If Bfat.value = True Then
          Cptlig = 1
        Else
          Coldetail.MoveFirst
          Repeat
            Coldetail.item.Selected = True
            If Coldetail.Current[9] = "C" Or If Coldetail.Item[9] = "R" Then
              intitule = Coldetail.Current[2]
              For Each sline In Split(Intitule, "\n")
                Inc Cptlig
              Next
            Else
              Inc Cptlig
            Endif
          Until Coldetail.MoveNext()
        Endif
        P = 32
        If Recap.Value = False And Pied.Value = False Then p = 36
        'If Val(Acpt.Text) > 0 Then p = p - 1
        Npage = Cptlig / p
        If Npage = 0 Then Npage = 1
        If Cptlig < p Then Npage = 1
        If Cptlig > p Then
          Npage = Cptlig / 21
          Npage = Val(Format$(Npage, "##.##"))
          If Val(Right$(Str(Npage), 2)) > 42 Then Npage = Round(Npage) + 1
        Endif
        If Cptlig > p And Cptlig <= 42 Then Npage = 2
        Npage = Round(Npage)
        Page = "Page " & Pge
        rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & "")
        If rResult.Available Then Txtbf = rResult!txtfac
        Ventilation()
        Me.Mouse = Mouse.Wait
        Utils.db.Exec("LOCK TABLES " & Tab9 & " read")
        Parametres()
        If Visudoc = False And Bfac.value And Imp = "0" Then Maj_Parametres()
        Utils.db.Exec("UNLOCK TABLES")
        If Jnl Then
          numecr = "numecriture"
          numr = Ecritures(numecr)
          numr = numr + 1
          numecr = "numecriture2"
          numr2 = Ecritures(numecr)
          numr2 = numr2 + 1
          rResult = Utils.db.Exec("SELECT * FROM " & tab2 & " where cd_sc = &1", Start.Societe)
          Rs = rResult!type_sc & " " & rResult!int_sc
          Adr11 = rResult!adr1_sc
          Adr22 = rResult!adr2_sc
          Ville = rResult!cp_sc & "  " & rResult!burdis_sc
          If rResult!villerc_sc Then Rcs = "Rcs : " & rResult!rcs_sc & " " & rResult!villerc_sc
          If rResult!siret_sc Then Siret = "Siret : " & rResult!siret_sc
          If rResult!tvaintra_sc Then Tvaintra = "Tva intra : " & rResult!tvaintra_sc
          If rResult!cap_sc Then Cap = "Capital : " & rResult!cap_sc
          If rResult!ape_sc Then Ape = "Naf : " & rResult!ape_sc
          If rResult!tel_sc Then Tel = "Tel : " & rResult!tel_sc
          If rResult!port_sc Then Portable = "Portable : " & rResult!port_sc
          If rResult!fax_sc Then Fax = "Fax : " & rResult!fax_sc
          If rResult!email_sc Then Mail = "Courriel : " & rResult!email_sc
          If rResult!site Then Site = "Site : " & rResult!site
          If rResult!banq Then Iban = "Iban : " & rResult!banq & " Bic : " & rResult!bic
          If Tp = "A" Then ty = "Fiche atelier N° "
          If Tp = "B" Then ty = "Bon réparation N° "
          If Tp = "D" Then ty = "Estimation N° "
          If Tp = "P" Then ty = "Proforma réparation N° "
          If Bfac.value And Val(Tottc.Text) > 0 Then
            ty = "Facture N° "
          Endif
          If Bfac.value And Val(Tottc.Text) < 0 Then
            ty = "Avoir N° "
            Txtleg = ""
          Endif
          If Bfac.value And imp = "0" And Visudoc = True Then
            ty = "Bon N° "
          Endif
          If dtef.Text = "" Then
            If Son Then
              Music.Play
            Endif
            Try Message.Warning(" veuillez saisir une date d'édition Svp !", "Ok")
          Else
            If Bfac.value And Imp = "0" Then
              Jour = ty & Nmfac & " du " & Dfac
            Else
              If Bfac.value And Imp = "1" Then
                Jour = ty & Nmfac & " du " & Dfac
              Else
                Jour = ty & " " & num.Text & " " & " du " & dtef.Text
              Endif
            Endif
            If Bfac.value And imp = "0" And Visudoc = True Then Jour = ty & Format$(Now, "yyyy") & num.Text & " du " & dtef.Text
            If Bbon.value And Edit2.Visible = True And Not IsNull(Nombl.Text) Then
              Rs2 = Nombl.text
              Adr211 = Adr1Bl.Text
              Adr222 = Adr2Bl.Text
              Ville2 = CpBl.Text & " " & Villebl.Text
            Else
              Rs2 = Cv.Text & " " & Nm.Text & " " & Pnm.Text
              Adr211 = Adr1.Text
              Adr222 = Adr2.Text
              Ville2 = Cp.Text & " " & Burd.Text
            Endif
            Cde = "Code client " & Code3.text
            If Entete.Value Or If Org = "Mail" Then
              pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, Coln.Value, Libre)
              If Tp = "A"
                pdf.Entete3(rs2, adr211, adr222, ville2, Pays, tel2, portable2, Coln.Value, False)
              Else
                pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.Value, False)
              Endif
            Else
              If Tp = "A"
                pdf.Entete3(rs2, adr211, adr222, ville2, Pays, Tel2, portable2, Coln.Value, True)
              Else
                pdf.Entete2(rs2, adr211, adr222, ville2, Pays, Coln.Value, True)
              Endif
            Endif
            pdf.Level1F(Jour, Cde, Page, TvaCli)
            PosY = 104
            pdf.LevelM(Marque.Text, Numserie.text, Desg.Text, Desg2.Text, Typemat.Text, Coulfond, Tp)
            PosY = 108
            If Tp <> "A" Then pdf.Level2F(Coulfond, Impttc.Value, PosY)
            PosY = 114
            Nbl = 0
            If Not IsNull(LibelleMat.text) Then
              For Each sline In Split(LibelleMat.Text, "\n")
                pdf.Level2M(sline, PosY)
                PosY = PosY + 4
                Inc nbline
              Next
              nbline = nbline / 2
              Nbl = Nbl + nbline
            Endif
            If Tp <> "A" Then
              If Coldetail.Count <> 0 Then
                Coldetail.MoveFirst
                Repeat
                  Coldetail.Item.Selected = True
                  Code = Coldetail.Current[1]
                  intitule = Coldetail.Current[2]
                  Txtva = Coldetail.Current[12]
                  Pu = Coldetail.Current[3]
                  If Len(pu) - InStr(pu, ",") = 2 Then pu = pu & " "
                  Qte = Coldetail.Current[4]
                  Brutht = Coldetail.Current[5]
                  If Len(Brutht) - InStr(Brutht, ",") = 2 Then Brutht = Brutht & " "
                  Rem = Coldetail.Current[6]
                  Totalht = Coldetail.Current[7]
                  typeL = Coldetail.Current[9]
                  Totttc = Coldetail.Current[8]
                  If Remmo = "" Then Remmo = "0"
                  If Remart = "" Then Remart = "0"
                  If Rem = "" Then Rem = "0"
                  If rem <> "0" And Impttc.Value = False Then Trem = Trem + Val(brutht) - Val(totalht)
                  If totalht = "" Then totalht = "0,00"
                  If Brutht = "" Then Brutht = "0,00"
                  If Remmo = "" Then Remmo = "0,00"
                  If typeL = "M" Then Remmo = Val(.CPoint(Remmo)) + Val(.CPoint(Brutht)) - Val(.CPoint(Totalht))
                  If typeL = "A" Then Remart = Val(.CPoint(Remart)) + Val(Brutht) - Val(Totalht)
                  If typeL = "E" Or typeL = "P" Then
                    Qte = ""
                    Pu = ""
                    Brutht = ""
                  Endif
                  If Val(.cpoint(Rem)) = 0 Then Rem = ""
                  If typeL <> "C" And typeL <> "T" And typeL <> "E" And TypeL <> "P" Then
                    If Impttc.Value = True Then
                      If typeL = "A" Then
                        ArtRslt = Utils.db.Exec("SELECT * FROM " & tab6 & " where art_code = &1", Code)
                        Ardi = ArtRslt!art_cdarr
                        Nbdec = ArtRslt!art_nbd
                        Nbdec = .Find_Nbdec(Nbdec)
                        'Txtva = ArtRslt!art_tva
                        Tvarslt = Utils.db.Exec("select * from " & Tab8 & " where code_tva = &1", Txtva)
                        If Tvarslt.Available Then
                          Ttva = Tvarslt!taux_tva
                        Endif
                        'Puttc = Format$(Val(Pu) * 1.196, "0.00")
                        If Ttva = 0 Or If exo.Value Then
                          Puttc = pu
                        Else
                          Puttc = Format$(Val(pu) + (Val(pu) * Ttva / 100))
                        Endif
                        Puttc = Format$(Val(Puttc), "0.00")
                        Puttc = Ard(Puttc)
                        If Len(puttc) - InStr(puttc, ",") = 2 Then puttc = puttc & "  "
                        'Bruttc = Format$(Val(Brutht) * 1.196, "0.00")
                        If Ttva = 0 Or If exo.Value Then
                          Bruttc = brutht
                        Else
                          Bruttc = Format$(Val(Brutht) + (Val(Brutht) * Ttva / 100))
                        Endif
                        Bruttc = Format$(Val(Bruttc), "0.00")
                        Bruttc = Ard(Bruttc)
                        If Len(Bruttc) - InStr(Bruttc, ",") = 2 Then Bruttc = Bruttc & "  "
                        If Ttva = 0 Or If exo.Value Then
                          Totttc = Totalht
                        Else
                          Totttc = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                        Endif
                        If rem <> "0" Then Trem = Val(Trem) + Val(bruttc) - Val(totttc)
                        Totttc = Format$(Val(Totttc), "0.00")
                        Totttc = Ard(Totttc)
                        Tart = Format$(Val(Tart) + Val(Totttc), "0.00")
                      Else
                        If typeL = "M" Then
                          Nbdec = 2
                          Nbdec = .Find_Nbdec(Nbdec)
                          ArtRslt = Utils.db.Exec("SELECT * FROM " & tab7 & " where mo_code = &1", Code)
                          Try Ardi = ArtRslt!mo_cdarr
                          If Error Then
                            Me.mouse = Mouse.Default
                            Message.Error("Il y a un souci avec le code " & code & " Impression impossible !")
                            Return
                          Endif
                          Tvarslt = Utils.db.Exec("select * from " & Tab8 & " where code_tva = &1", Txtva)
                          If Tvarslt.Available Then
                            Ttva = Tvarslt!taux_tva
                          Endif
                          If Ttva = 0 Or If exo.Value Then
                            Puttc = pu
                          Else
                            Puttc = Format$(Val(pu) + (Val(pu) * Ttva / 100))
                          Endif
                          Puttc = Format$(Val(Puttc), Nbdec)
                          Puttc = Ard(Puttc)
                          Puttc = Format$(Val(.cpoint(Puttc)), Nbdec)
                          If Len(puttc) - InStr(puttc, ",") = 2 Then puttc = puttc & "  "
                          If Ttva = 0 Or If exo.Value Then
                            Bruttc = brutht
                          Else
                            Bruttc = Format$(Val(Brutht) + (Val(Brutht) * Ttva / 100))
                          Endif
                          Bruttc = Format$(Val(Bruttc), Nbdec)
                          Bruttc = Ard(Bruttc)
                          Bruttc = Format$(Val(Bruttc), Nbdec)
                          If Len(Bruttc) - InStr(Bruttc, ",") = 2 Then Bruttc = Bruttc & "  "
                          If Ttva = 0 Or If exo.Value Then
                            Totttc = Totalht
                          Else
                            Totttc = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                          Endif
                          If Val(rem) <> "0" Or If Not IsNull(rem) Then Trem = Val(Trem) + Val(bruttc) - Val(totttc)
                          Totttc = .cpoint(Ard(Totttc))
                          Totttc = Format$(Val(Totttc), Nbdec)
                          Tmo = Format$(Val(Tmo) + Val(Totttc), Nbdec)
                        Endif
                      Endif
                      Trem = Format$(Val(.cpoint(Trem)), "0.00")
                      totht = Format$(Val(totht) + Val(totttc), "0.00")
                      pdf.Level3F(code, intitule, Puttc, qte, Bruttc, Rem, Totttc, Txtva, PosY)
                      PosY = PosY + 4
                    Else
                      If typeL = "A" Then Tart = Format$(Val(Tart) + Val(totalht), "0.00")
                      If typeL = "M" Then Tmo = Format$(Val(Tmo) + Val(totalht), "0.00")
                      totht = Format$(Val(totht) + Val(totalht), "0.00")
                      pdf.Level3F(code, intitule, Pu, qte, Format$(Val(Brutht), "0.00"), Rem, Format$(Val(Totalht), "0.00"), Txtva, PosY)
                      PosY = PosY + 4
                    Endif
                    Maj_Totalisation()
                  Endif
                  If typeL = "T" Then
                    pdf.Level4aF(intitule, PosY)
                    PosY = PosY + 4
                  Endif
                  If typeL = "C" Or If Coldetail.Item[9] = "R" Then
                    pdf.Level4aF(intitule, PosY)
                    PosY = PosY + 4
                  Endif
                  If typeL = "E" Then
                    If Impttc.Value = True Then
                      If Ttva = 0 Or If exo.Value Then
                      Else
                        Totalht = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                      Endif
                      intitule = "Dont " & Totalht & " " & devises & " TTC d' Eco-participation"
                    Else
                      intitule = "Dont " & Totalht & " " & devises & "  HT d' Eco-participation"
                    Endif
                    Teco = Teco + Val(Totalht)
                    Coldetail.MoveNext()
                    Try Coldetail.item.Selected = True
                    If Not Error Then
                      If Coldetail.Item[9] = "P" Then
                        Totalht = Coldetail.Current[7]
                        If Impttc.Value = True Then
                          If Ttva = 0 Or If exo.Value Then
                          Else
                            Totalht = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                          Endif
                          Intitule = Intitule & " et " & Totalht & " " & devises & " TTC de taxe copie privée."
                        Else
                          Intitule = Intitule & " et " & Totalht & " " & devises & " HT de taxe copie privée."
                        Endif
                      Else
                        Coldetail.MovePrevious()
                        Coldetail.Item.Selected = True
                      Endif
                    Endif
                    pdf.Level4F(intitule, PosY)
                    PosY = PosY + 4
                  Endif
                  If typeL = "P" Then
                    If Impttc.Value = True Then
                      If Ttva = 0 Or If exo.Value Then
                      Else
                        Totalht = Format$(Val(Totalht) + (Val(Totalht) * Ttva / 100))
                      Endif
                      intitule = "Dont " & Totalht & " " & devises & " TTC de taxe copie privée."
                    Else
                      intitule = "Dont " & Totalht & " " & devises & " HT de taxe copie privée."
                    Endif
                    pdf.Level4F(intitule, PosY)
                    PosY = PosY + 4
                  Endif
                  Nbl = Nbl + 1
                  If Npage > 1 Then
                    If Nbl >= 25 Then
                      Inc Pge
                      Page = "Page " & Pge
                      pdf.Level12F(Totht, PosY, Devises)
                      If Entete.Value Or If Org = "Mail" Then
                        pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, False, Libre)
                        pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
                      Else
                        pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", True)
                      Endif
                      pdf.Level1F(Jour, Cde, Page, TvaCli)
                      PosY = 104
                      pdf.LevelM(Marque.Text, Numserie.text, Desg.Text, Desg2.Text, Typemat.Text, Coulfond, Tp)
                      PosY = 108
                      If Tp <> "A" Then
                        If Blch.value = True Then
                          pdf.Level2F(Coulfond, Impttc.Value, PosY)
                        Else
                          pdf.Level2Fa(Coulfond, PosY)
                        Endif
                      Endif
                      PosY = 114
                      Nbl = 0
                    Endif
                  Endif
                Until Coldetail.MoveNext()
              Endif
            Endif
          Endif
          If Nbl > P Then
            Inc Pge
            Page = "Page " & Pge
            pdf.Level12F(Totht, PosY, Devises)
            If Entete.Value Or If Org = "Mail" Then
              pdf.Entete(rs, adr11, adr22, ville, cap, rcs, siret, ape, Tvaintra, Tel, portable, fax, mail, site, Visudoc, Pays, Iban, False, Libre)
              pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", False)
            Else
              pdf.Entete2(rs2, adr211, adr222, ville2, Pays, "", True)
            Endif
            pdf.Level1F(Jour, Cde, Page, TvaCli)
            PosY = 104
            pdf.LevelM(Marque.Text, Numserie.text, Desg.Text, Desg2.Text, Typemat.Text, Coulfond, Tp)
            PosY = 108
            If Tp <> "A" Then
              If Blch.value = True Then
                pdf.Level2F(Coulfond, Impttc.Value, PosY)
              Else
                pdf.Level2Fa(Coulfond, PosY)
              Endif
            Endif
            PosY = 114
            Nbl = 0
          Endif
          Posy = 240
          If Teco <> 0 Then
            Toteco = Format$(Teco, "0.00")
            If Impttc.Value = True Then
              Toteco = "  Total Eco-participation : " & Toteco & " " & devises & " TTC."
            Else
              Toteco = "  Total Eco-participation : " & Toteco & " " & devises & " HT."
            Endif
            pdf.Level5F(TotEco, PosY)
          Endif
          Nbl = Nbl + 1
          If Impttc.Value Then
            If Val(Trem) <> 0 Then
              Trem = "Total remise : " & Trem & " TTC"
            Else
              Trem = ""
            Endif
            If Val(Tart) <> 0 Then
              Tart = "Total article : " & Tart & " TTC"
            Else
              Tart = ""
            Endif
            If Val(Tmo) <> 0 Then
              Tmo = "Total MO : " & Tmo & " TTC"
            Else
              Tmo = ""
            Endif
          Else
            If Val(Totrem.text) <> 0 Then
              Trem = "Total remise : " & Totrem.Text & " ht"
            Else
              Trem = ""
            Endif
            If Val(Tart) <> 0 Then
              Tart = "Total article : " & Tart & " ht"
            Else
              Tart = ""
            Endif
            If Val(Tmo) <> 0 Then
              Tmo = "Total MO : " & Tmo & " ht"
            Else
              Tmo = ""
            Endif
          Endif
          Posy = 240
          If Pied.Value And Recap.Value Then
            pdf.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
            PosY = PosY + 4
          Endif
          If Recap.Value And Not Pied.Value Then
            Txtbf = ""
            pdf.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
            PosY = PosY + 4
          Endif
          If Not Recap.Value And Pied.Value Then
            Tmo = ""
            Tart = ""
            Trem = ""
            pdf.Level6F(Tmo, Tart, Trem, Txtbf, PosY)
            PosY = PosY + 4
          Endif
          PosY = 258
          If Tp <> "A" Then pdf.Level7F(Coulfond, PosY, "", "", Exo.value)
          PosY = PosY + 5
          If Tp <> "A" Then Calc_tva()
          If Tp = "A" Then pdf.Level14F()
          pdf.Output(Filename, False)
          If Tp = "C" Then ty = "Commande"
          If Tp = "B" Then ty = "Bon"
          If Tp = "D" Then ty = "Devis"
          If Tp = "P" Then ty = "Proforma"
          If Tp = "A" Then ty = "Atelier"
          If Tp = "B" Then Ty = "Reparation"
          If Bfac.value And Val(Tottc.Text) > 0 Then
            ty = "Facture"
          Endif
          If Bfac.value And Val(Tottc.Text) < 0 Then
            ty = "Avoir"
            Txtleg = ""
          Endif
          If Bfac.value And imp = "0" And Visudoc = True Then
            ty = "Bon"
          Endif
          Copie.Dupli("FactureMat.pdf", "/Impressions", ty, dtef.Text)
          If Org <> "M" Then
            If Visudoc = True Then
              Visualiseur.Prog_Editeur(Filename)
              Visudoc = False
            Else
              Impressfac.Prog_Editeur(Filename, Val(Nbexpl.text), ChxImp.value)
            Endif
          Endif
          sPiece = User.home & "/Impressions/" & Ty & ".pdf"
          If Cfac Then
            Nom.Text = Replace$(Nom.Text, " ", "")
            Nom.Text = Replace$(Nom.Text, "/", "")
            Nom.Text = Replace$(Nom.Text, "'", "")
            If Bfac.value And Visudoc = False Then
              ty = Left$(ty, 1) & Nmfac & Nom.Text
            Else
              TY = Left$(ty, 1) & num.Text & Nom.Text
            Endif
            Copie.Dupli2("FactureMat.pdf", User.home & "/Impressions", ty, dtef.Text, Code3.text, "Facs")
          Endif
          If Visudoc = False And Bfac.value And Imp = "0" Then
            Edit.Visible = False
            BlRslt = Utils.db.Exec("SELECT * FROM " & tab1 & " where numbl = &1", num.Text)
            Nfac = Right$(Dtef.text, 4) & Nfac
            Utils.db.Exec("UPDATE  " & Tab1 & "  SET  imp = &2, numfac = &3, reg = &4, ech = &5 , dtefac = &6, mtreg =&7, type = &8 WHERE numbl = &1", num.Text, "1", Nfac, regmt.Text, .Cdate_Dbase(dateech), .Cdate_Dbase(dtef.Text), Rglt.Text, "F")
            Verif_solde()
            Maj_Compta()
            If Regmt.Text = "Traite" Or If Regmt.Text = "Lcr" Then Maj_Traite()
            Majnum()
            Form_Open()
          Else
            If Visudoc = False Then Utils.db.Exec("UPDATE  " & Tab1 & "  SET  ech = &2 WHERE numbl = &1", num.Text, .Cdate_Dbase(dateech))
          Endif
        Else
          If Son Then
            Music.Play
          Endif
          Try Message.Warning(" Impression impossible ! Veuillez saisir un code journal dans les parametres Svp !", "Ok")
        Endif
      Endif
    Endif
  End With
  Me.Mouse = Mouse.Arrow
  Visudoc = False
  Colbl_Click()
Catch
  If son Then
    Music.Play
  Endif
  Try message.Error(Error.Text & " " & Error.where)
  Me.Mouse = Mouse.Default
  
End

Public Sub Maj_Traite()
  
  Dim Accept As Boolean = False
  Dim Traite As String
  
  If Regmt.Text = "Traite" Then
    Accept = True
  Else
    Accept = False
  Endif
  Traite = "Fiches_Traites" 
  Utils.db.Exec("insert into  " & Traite & "  (code, nom, numfac, montant, datech, date, acceptee, ecartee) value (&1, &2, &3, &4, &5, &6, &7, &8)", Code3.Text, Nom.text, Nfac, rglt.Text, Utils.Cdate_Dbase(dateech), Utils.Cdate_Dbase(dtef.Text), Accept, 0)
  
End

'***********************************
'*        On gère l' arrondi       *
'***********************************
Public Function ard(Puttc As String) As String
  
  If Not PuTTc Then PuTTc = "0,00"
  If ardi = "0,05" Then
    If Right$(Puttc) Like "[34567]*" Then
      Puttc = Left$(Puttc, (Len(Puttc) - 1)) & "5"
    Else
      Puttc = Round(Val(Puttc), -1)
      If typeL = "A" Then Puttc = Format$(Puttc, Nbdec)
    Endif
  Endif
  
  If ardi = "0,10" Then
    Puttc = Round(Val(Puttc), -1)
    If typeL = "A" Then Puttc = Format$(Puttc, Nbdec)
  Endif
  
  If ardi = "0,50" Then
    If Abs(Val(Puttc)) <= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 25)) Then
      Puttc = Left$(Puttc, (Len(Puttc) - 2)) & "00"
    Else
      If Abs(Val(Puttc)) <= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 75)) Then
        Puttc = Left$(Puttc, (Len(Puttc) - 2)) & "50"
      Endif
      If Abs(Val(Puttc)) >= Abs(Val(Left$(Puttc, (Len(Puttc) - 2)) & 76)) Then
        Puttc = Round(Val(Puttc))
        If typeL = "A" Then Puttc = Format$(Puttc, Nbdec)
      Endif
    Endif
  Endif
  
  If ardi = "1,00" Then
    Puttc = Round(Val(Puttc))
    If typeL = "A" Then Puttc = Format$(Puttc, Nbdec)
  Endif
  Return Puttc
  
End

'**********************************************************
'*                   Recup parametres                     *
'**********************************************************
Public Sub Parametres()
  
  Tab = "Fiches_Parametres" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  If rResult.Available Then
    Nfac = rResult!dnfac
    Jnl = rResult!jrnal
  Endif
  Nfac = Format$(Val(Nfac) + 1, "000000")
  
End

'**********************************************************
'*                   Maj parametres                     *
'**********************************************************
Public Sub Maj_Parametres()
  
  Tab = "Fiches_Parametres" 
  With Utils
    Nfac = Val(Nfac)
    Nfac = Format$(Nfac, "000000")
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    Utils.db.Exec("UPDATE  " & Tab & "  SET  dnfac = &1", Nfac)
  End With
  
End

'**********************************************************
'*      Creation table temporaire pour totalisation       *
'**********************************************************
Public Sub Ventilation()
  
  Tab5 = "Totalisation"
  Utils.db.Exec("DROP TABLE IF EXISTS  Totalisation ")
  Utils.db.Exec("CREATE TABLE " & Tab5 & 
    "(compte Char(8) NOT NULL," &
    "intitule Char(25)," &
    "totalht Char(25)," &
    "totaltva Char(25)," &
    "codetva Char(1)," &
    "PRIMARY KEY (compte,codetva))" & "ENGINE = MYISAM")
  Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht) VALUES (&1, &2, &3)", Code.Text, Nom.Text, Tottc.Text)
  
End
'**********************************************************
'*                   Maj Totalisation                     *
'**********************************************************

Public Sub Maj_Totalisation()
  
  Dim Mtva As String
  Dim Totht As String
  Dim Tottva As String
  Dim Remise As String
  Dim rrResult As Result
  
  Tab = "Fiches_Fam" 
  Tab5 = "Totalisation"
  Tab3 = "Fiches_Comptes" 
  Tab4 = "Fiches_Tvaav" 
  TotTva = "O.OO"
  With utils
    Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE, " & Cbase.Table("TabComptes") & " WRITE")
    ' On recupere le compte vente et le code TVa de la famille
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " Where code_fam = &1", Coldetail.Item[13])
    If rResult.Available Then
      If tvar Then
        Cpt = rResult!compt2_fam
      Else
        Cpt = rResult!compt_fam
      Endif
      Ctva = Coldetail.Item[12]
      CptRem = rResult!cptrem_fam
    Endif
    ' On recupere les données du compte vente de la famille
    rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", Cpt)
    If rResult.Available Then
      Intit = rResult!intitule_cc
    Endif
    'On recupere le compte de TVA et son taux de TVA
    rResult = Utils.db.Exec("SELECT * FROM " & Tab4 & " Where code_tva = &1", Ctva)
    If rResult.Available Then
      Cpttva = rResult!cc_tva
      Ttva = rResult!taux_tva
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", Cpttva)
    If rResult.Available Then
      IntitTva = rResult!intitule_cc
    Endif
    'On calcule le montant de la TVA
    Mtva = Format$(Val(.CPoint(Coldetail.Item[8])) - (Val(.CPoint(Coldetail.Item[7]))), "0.000")
    'Si ce n'est pas un compte TVA regarde si le compte existe deja dans la table temporaire
    If Left$(Cpt, 4) <> "4457" Then
      rrResult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 AND Codetva = &2", Cpt, 0)
    Else
      'Sinon on recupere le compte TVA correspondant au taux
      rrResult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 and Codetva = &2", Cpt, Ctva)
    Endif
    'Si le compte existe dans la table temporaire
    If rrResult.Available Then
      'Si ce n'est pas un client on calcule le HT et le montant de la TVA
      Totht = Format$(Val(.CPoint(rrResult!totalht)) + Val(.CPoint(Coldetail.Item[7])), "0.000")
      TotTva = Format$(Val(.CPoint(rrResult!totaltva)) + Val(.CPoint(Mtva)), "0.000")
      'Si ce n'est pas un compte TVA on met a jour sans le code TVA
      If Left$(Cpt, 4) <> "4457" Then
        Utils.db.Exec("UPDATE " & Tab5 & " set compte = &1, intitule = &2, totalht = &3, totaltva = &4 Where compte = &1 and codetva = &5", Cpt, Intit, Totht, TotTva, 0)
      Else
        'Si c'est un compte TVA on met a jour avec le code TVA
        Utils.db.Exec("UPDATE " & Tab5 & " set compte = &1, intitule = &2, totalht = &3, totaltva =&4 Where compte = &1 and codetva = &5", Cpt, Intit, Totht, TotTva, Ctva)
      Endif
      'ENDIF
    Else
      'Si le compte n'existe pas dans la table temporaire
      Totht = Format$(Val(.CPoint(Coldetail.Item[7])), "0.000")
      'Si ce n'est pas un compte TVA on crée avec un code TVA a zéro
      If Left$(Cpt, 4) <> "4457" Then
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht, totaltva, codetva) VALUES (&1, &2, &3, &4, &5)", Cpt, Intit, Totht, Mtva, 0)
      Else
        'Sinon on crée avec le code TVA
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totalht, totaltva, codetva) VALUES (&1, &2, &3, &4, &5)", Cpt, Intit, Totht, Mtva, Ctva)
      Endif
    Endif
    If Not IsNull(Cpttva) Then
      rrResult = Utils.db.Exec("SELECT * FROM " & Tab5 & " Where compte = &1 and codetva = &2", Cpttva, Ctva)
      If rrResult.Available Then
        TotTva = Format$(Val(.CPoint(rrResult!totaltva)) + Val(.CPoint(Mtva)), "0.000")
        Utils.db.Exec("UPDATE " & Tab5 & " set compte = &1, intitule =&2, totaltva =&3, codetva = &4 Where compte = &1 and codeTva = &4", Cpttva, Intittva, Tottva, Ctva)
      Else
        Utils.db.Exec("INSERT INTO " & Tab5 & "(compte, intitule, totaltva, codetva) VALUES (&1, &2, &3, &4)", Cpttva, Intittva, Mtva, Ctva)
      Endif
    Endif
    Totht = 0
    Remise = 0
    Utils.db.Exec("UNLOCK TABLES")
  End With
  
End

Public Sub Verif_solde()
  
  Dim hResult As Result
  Dim sCompte As String
  Dim sTotalD As String = "0"
  Dim sTotalC As String = "0"
  Dim sdif As Float
  
  With utils
    hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("Totalisation") & " order by compte")
    If hResult.Available Then
      Repeat
        If Left$(hResult!compte, 3) = "411" Then
          sTotalD = hResult!totalht
        Else
          If Left$(hResult!compte, 3) = "445" Then
            sTotalC = Val(.cpoint(sTotalC)) + Val(.cpoint(hResult!totaltva))
          Else
            sTotalC = Val(.cpoint(sTotalC)) + Val(.cpoint(hResult!totalht))
          Endif
          sCompte = hResult!compte
        Endif
      Until hResult.MoveNext()
      hResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("Totalisation") & " Where compte = &1", sCompte)
      If Val(.cpoint(sTotalD)) < Val(.cpoint(sTotalC)) Then
        sDif = Val(.cpoint(sTotalC)) - Val(.cpoint(sTotalD))
        sDif = Val(.cpoint(hResult!totalht)) - sDif
        Utils.db.Exec("UPDATE " & Cbase.Table("Totalisation") & " set totalht = &2 Where compte = &1 ", sCompte, sDif)
      Else
        If Val(.cpoint(sTotalD)) > Val(.cpoint(sTotalC)) Then
          sDif = Val(.cpoint(sTotalD)) - Val(.cpoint(sTotalC))
          sDif = Val(.cpoint(hResult!totalht)) + sDif
          Utils.db.Exec("UPDATE " & Cbase.Table("Totalisation") & " set totalht = &2 Where compte = &1 ", sCompte, sDif)
        Endif
      Endif
    Endif
  End With
  
End

'**********************************************************
'*                   Maj comptabilité                     *
'**********************************************************
Public Sub Maj_Compta()
  
  Dim Cpt As String
  Dim coll As String
  Dim collectif As String
  Dim Libel As String
  Dim Mtc As Float
  Dim Mtd As Float
  Dim Sld As Float
  Dim Valid As Integer
  Dim Prov As Integer
  Dim Tresor As Integer
  Dim Pointee As Integer
  Dim Lettree As Integer
  Dim Cloturee As Integer
  Dim Relance As Integer
  Dim hResult As Result
  Dim Param As Result
  Dim jnal As String
  Dim Vic As String
  Dim Vichq As String
  Dim Viautre As String
  Dim Cptreglt As String
  
  Tab = "Fiches_Mvt" 
  Tab2 = "Totalisation"
  Tab3 = "Fiches_Comptes" 
  Tab4 = "Fiches_Parametres" 
  Tab5 = "Fiches_Journaux" 
  Tab6 = "Fiches_Cli" 
  Valid = 1
  Prov = 0
  Tresor = 0
  Pointee = 0
  If rglt.Text = Tottc.text And Rgmt.Value = True Then
    Lettree = 1
  Else
    Lettree = 0
  Endif
  Cloturee = 1
  Relance = 0
  With Utils
    'Utils.db.Exec("LOCK TABLES " & Tab & " WRITE, " & Tab2 & " WRITE, " & Tab3 & " WRITE, " & Tab4 & " WRITE, " & Tab5 & " WRITE , " & Tab6 & " WRITE")
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabParam") & "")
    If rResult.Available Then
      Jnal = rResult!jrnal2
      Vic = rResult!viremc
      Vichq = rResult!viremchq
      Viautre = rResult!virema
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Tab2 & "")
    If rResult.Available Then
      Repeat
        collectif = ""
        Cpt = rResult!compte
        Intit = rResult!intitule
        If Left$(Cpt, 3) = "411" Then
          hresult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", Cpt)
          coll = hresult!coll_cc
          collectif = "1"
          If Val(Tottc.Text) > 0 Then
            Libel = "Facture " & Intit
          Else
            Libel = "Avoir " & Intit
          Endif
          If rResult!totalht <> "" And Val(.cpoint(rResult!totalht)) > 0 Then
            Mtd = Val(.cpoint(rResult!totalht))
            Mtc = 0
          Else
            Mtc = Abs(Val(.cpoint(rResult!totalht)))
            Mtd = 0
          Endif
          Mtd = Abs(mtd)
          Mtc = Abs(Mtc)
          Utils.db.Exec("INSERT INTO " & Tab & "(jour, numero, compte, collectif, intitule, dte, dateech, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef, dteval) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18}, &{19}, &{20})", Jnl, numr, coll, collectif, Intit, .Cdate_Dbase(dtef.Text), .Cdate_Dbase(dtech.Text), Nfac, Libel, Mtd, Mtc, Valid, Prov, Tresor, Pointee, lettree, Cloturee, Relance, numr2, Format$(Now, "yyyymmdd"))
          hresult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Tab3 & " set solde = &2 Where compte_cc = &1", coll, Sld)
          collectif = ""
        Endif
        If Left$(Cpt, 3) <> "411" And Left$(Cpt, 3) <> "445" And Not IsNull(cpt) Then
          If Left$(rResult!compte, 3) <> "709" Then
            If Val(.cpoint(rResult!totalht)) > 0 Then
              Mtc = Val(.cpoint(rResult!totalht))
              Mtd = 0
            Else
              Mtd = Val(.cpoint(rResult!totalht))
              Mtc = 0
            Endif
          Endif
        Endif
        If Left$(Cpt, 3) = "445" Then
          If rResult!totaltva <> "" And Val(rResult!totaltva) > 0 Then
            Mtc = Val(rResult!totaltva)
            Mtd = 0
          Else
            Mtd = Abs(Val(rResult!totaltva))
            Mtc = 0
          Endif
        Endif
        If Mtd = 0 And Mtc = 0 Then
        Else
          Utils.db.Exec("INSERT INTO " & Tab & "(jour, numero, compte, intitule, dte, dateech, numdoc, numlot, libelle, montantd, montantc, validee, provisoire, tresorerie, pointee, lettree, cloturee, relance, numerodef) VALUES (&1, &2, &3, &4, &5, &6, &7, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17}, &{18})", Jnl, numr, Cpt, Intit, .Cdate_Dbase(dtef.Text), .Cdate_Dbase(dtech.Text), Nfac, Libel, Mtd, Mtc, Valid, Prov, Tresor, Pointee, lettree, Cloturee, Relance, numr2)
          hresult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", Cpt)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Tab3 & " set solde = &2 Where compte_cc = &1", Cpt, Sld)
          Mtd = 0
          Mtc = 0
        Endif
      Until rResult.MoveNext()
      If Regmt.text = "Espèces" Or If Regmt.text = "Carte" Or If Regmt.text = "Chèque" Then
        If Not IsNull(Rglt.Text) And Rgmt.value = True Then
          Param = Utils.db.Exec("SELECT * FROM " & Tab5 & " where code_jo = &1", jnal)
          Numr = numr + 1
          cloturee = 1
          Mtc = Val(rglt.Text)
          If Regmt.text = "Espèces" Then
            Cptreglt = Param!cde_banque
          Else
            If Regmt.text = "Carte" Then
              Cptreglt = Vic
            Else
              If Regmt.text = "Chèque" Then
                Cptreglt = Vichq
              Else
                Cptreglt = Viautre
              Endif
            Endif
          Endif
          Libel = "Règlement par " & Regmt.Text
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Code3.Text, rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text))
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee, collectif) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16}, &{17})", Jnal, numr, coll, rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, lettree, cloturee, .Cdate_Dbase(Dtef.Text), 1)
          Mtd = Mtc
          Mtc = 0
          Utils.db.Exec("INSERT INTO " & Tab & "(jour,numero,compte,intitule,dte,numdoc, numlot, libelle, montantd, montantc,validee, provisoire,tresorerie,lettree,Cloturee, datee) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Jnal, numr, Cptreglt, Regmt.text & " " & rs2, .Cdate_Dbase(Dtef.Text), Nfac, Nfac, Libel, mtd, mtc, 1, 0, 1, 0, cloturee, .Cdate_Dbase(Dtef.Text))
          '*******************************On recalcule les soldes des comptes************************************
          Mtd = 0
          Mtc = Val(rglt.Text)
          'Pour le compte client
          hresult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", Code3.Text)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Tab3 & " set solde = &2 Where compte_cc = &1", Code3.Text, Sld)
          Mtd = 0
          'Pour le collectif
          hresult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", coll)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Tab3 & " set solde = &2 Where compte_cc = &1", coll, Sld)
          Mtd = 0
          Mtc = 0
          'Pour le compte de trésorerie
          Mtd = Val(rglt.Text)
          hresult = Utils.db.Exec("SELECT * FROM " & Tab3 & " Where compte_cc = &1", Cptreglt)
          If hresult!solde = "" Then
            Sld = Mtd - Mtc
          Else
            Sld = hresult!solde + Mtd - Mtc
          Endif
          Utils.db.Exec("UPDATE " & Tab3 & " set solde = &2 Where compte_cc = &1", Cptreglt, Sld)
          Mtd = 0
          Mtc = 0
        Endif
      Endif
    Endif
    'Utils.db.Exec("UNLOCK TABLES")
  End With
  
End

'**********************************************************
'*       Calcul de la Tva pour le bas de facture          *
'**********************************************************
Public Sub Calc_tva()
  
  Dim Cpt As String
  Dim Mtva As String
  Dim Mtva2 As String
  Dim Mht As String
  Dim Mttc As String
  Dim Ttx As String
  Dim CResult As Result
  Dim Cptrst As Result
  Dim TotEuros As String
  Dim NbTx As Integer ' flag pour calcul du nombre de taux de tva utilisé dans la facture
  Dim ImpAuto As Boolean = False
  
  Tab = "Fiches_Tvaav" 
  Tab2 = "Totalisation"
  Nbtx = 1
  If Settings["/Soc" & Start.Societe & "/AutoEnt"] <> 0 Then
    ImpAuto = True
  Else
    ImpAuto = False
  Endif
  If IsNull(Settings["/Soc" & Start.Societe & "/AutoEnt"]) Then ImpAuto = False
  With Utils
    Cptrst = Utils.db.Exec("SELECT * FROM " & Tab & "")
    If Cptrst.Available Then
      Repeat
        Ttx = Format$(Cptrst!taux_tva, "0.00")
        Ctx = Cptrst!code_tva
        Cresult = Utils.db.Exec("SELECT * FROM " & Tab2 & " Where codetva = &1", Ctx)
        If Cresult.Available Then
          Repeat
            Cpt = CResult!compte
            If Left$(Cpt, 3) = "445" Then
              Mtva2 = Format$(Val(CResult!totaltva), "0.000")
              If IsNull(Mtva2) Then Mtva2 = "0,00"
              If Val(Mtva2) <> 0 Then
                Mtva = Mtva2 & " " & " " & devises
                If ImpAuto = False Then pdf.Level9F(Ctx, Mht, Ttx, Mtva, Mttc, PosY)
                PosY = PosY + 4
                Inc Nbtx
              Endif
            Endif
          Until Cresult.MoveNext()
        Else
          Mtva = "0,00"
        Endif
      Until Cptrst.MoveNext()
    Endif
    For Nbtx = Nbtx To 3
      PosY = PosY + 3
    Next
    If Not Reserve.Value Then
      Txtleg2 = ""
    Endif
    Toteuros = Tottc1.Text & " " & devises
    pdf.Level10F(Totht1.Text, Tottva.Text, Toteuros, Txtleg, PosY - 6, "", Exo.Value, "")
    PosY = PosY + 8
    If Bfac.value Then
      If Settings["/Soc" & Start.Societe & "/Coupon"] Then
        If Bfac.value And imp = "0" And Visudoc = True Then
        Else
          pdf.Level15F(Code3.Text, Nmfac, Toteuros, PosY, Devises)
        Endif
      Endif
    Endif
    pdf.Level11F(Txtleg2, PosY)
  End With
  
End

' Archivage des factures pour faire un avoir.

'**********************************************************
'*                   Archivage d'une facture              *
'**********************************************************
Public Sub Colbl_Activate()
  
  Dim Blarch As Result
  Dim Fbl As String
  'Utils.db.Exec("UNLOCK TABLES")
  Fbl = "Fiches_BlM" 
  Try Blarch = Utils.db.Exec("select * from " & Fbl & " where numbl = &1", colbl[colbl.row, 2].Text)
  If Not Error Then
    If Blarch.Available Then
      Numfac = Blarch!numfac
      Impfac = Blarch!imp
      Dtefac = utils.Cdate_Aff(Blarch!dtefac)
      Ech = utils.Cdate_Aff(Blarch!ech)
    Endif
    If Impfac = "1" And colbl[colbl.row, 7].Text Then
      If Message.Question(" Attention ! Vous allez archiver cette facture pour faire un avoir. Etes-vous d'accord ?", "Non", "Oui") = 2 Then
        Tot_Remises()
        Ent_Archives()
        Lig_Archives()
        Bl_Sup()
      Endif
    Endif
  Endif
  
End

'**********************************************
'*            calcul des remises              *
'**********************************************
Public Sub Tot_Remises()
  
  Dim Blarch As Result
  Dim Fbl As String
  
  Fbl = "Fiches_LigblM" 
  Remmo = "0"
  Remart = "0"
  With Utils
    Try Blarch = Utils.db.Exec("select * from " & Fbl & " where num_ligbl = &1", colbl[colbl.row, 2].Text)
    If Not Error Then
      If Blarch.Available Then
        Repeat
          Typel = Blarch!typel_ligbl
          If typeL = "M" Then Remmo = Val(.CPoint(Remmo)) + Val(.CPoint(Blarch!brut_ligbl)) - Val(.CPoint(Blarch!netht_ligbl))
          If typeL = "A" Then Remart = Val(.CPoint(Remart)) + Val(.CPoint(Blarch!brut_ligbl)) - Val(.CPoint(Blarch!netht_ligbl))
        Until Blarch.MoveNext()
      Endif
    Endif
  End With
  
End

'**********************************************************
'*                   Maj Entetes Archives                 *
'**********************************************************
Public Sub Ent_Archives()
  
  Dim rmat As Result
  Dim Tmat As String = "Fiches_EntMat" 
  
  Tab = "Fiches_HistoFacM" 
  With Utils
    Utils.db.Exec("INSERT INTO " & Tab & "(numfac,datefac,cdclifac, nmclifac, rmofac, rartfac, pnmclifac, adr1fac, adr2fac, cpfac, villefac, Exofac, cvclifac, remmofac, remartfac, totfac, reg, ech, numerobl, acpt, mreg, marge_art, marge_mo, numserie, codep, totfacttc) VALUES (&1,&2,&3,&4,&5,&6,&8,&9,&{10},&{11},&{12},&{13},&{14},&{15},&{16},&{17}, &{18}, &{19}, &{20}, &{21}, &{22}, &{23}, &{24}, &{25}, &{26}, &{27})", Numfac, .Cdate_Dbase(Dtefac), code.Text, nom.Text, Txmo.Text, Txpieces.Text, Tp, Pnm.Text, adr1.Text, adr2.Text, cp.Text, Burd.Text, Exo.Value, Cv.Text, .PointBase(Remmo), .PointBase(Remart), .PointBase(Totht.Text), regmt.Text, .Cdate_Dbase(ech), num.Text, acpt.Text, mrgt.Text, .PointBase(mrg.text), .PointBase(Mrgmo), Numserie.Text, CodeP.text, .PointBase(Tottc1.Text))
    Tab = "Fiches_HisentMat" 
    rmat = Utils.db.Exec("select * from " & Tmat & " where numserie = &1 and codep = &2 and numbl = &3", Numserie.Text, codep.Text, num.Text)
    If rmat.Available Then
      Utils.db.Exec("INSERT INTO " & Tab & "(numserie, codep, marque, type, design, design2, libelle, numfac) VALUES (&1,&2,&3,&4,&5,&6,&7,&8)", Numserie.Text, codep.text, marque.Text, typeMat.Text, desg.Text, desg2.Text, LibelleMat.Text, numfac)
    Endif
  End With
  
End

'**********************************************************
'*                   Maj Lignes  Archives                 *
'**********************************************************
Public Sub Lig_Archives()
  
  Dim Intit As String
  Dim lg, Nbligne As Integer = 0
  Dim l3 As String
  Dim Colitem0 As String
  Dim Colitem1 As String
  Dim Colitem9 As String
  Dim Colitem16 As String
  Dim Dlg As String
  Dim rmat As Result
  Dim Tmat As String = "Fiches_Materiels" 
  Dim TauxTva As String
  
  Tab = "Fiches_HistoLigfacM" 
  Try Gmateriel = Settings["/Soc" & Start.Societe & "/Materiel"]
  If Error Then Gmateriel = False
  Nbligne = 1
  With Utils
    Coldetail.MoveLast()
    Coldetail.Item.Selected = True
    Dlg = Format$(Val(Coldetail.Current[0]) + 1, "0000")
    If Coldetail.Count <> 0 Then
      Coldetail.MoveFirst
      If Settings["/Soc" & Start.Societe & "/Impbl"] Then
        intit = "Bon n° " & num.Text & " du " & Dtefac
        Utils.db.Exec("INSERT INTO " & Tab & "(num_ligfac, numlig_ligfac, code_ligfac, com_ligfac, typel_ligfac, bloc)VALUES (&1, &2, &3, &4, &5, &6)", numfac, Format$(Nbligne, "0000"), "", Intit, "C", Format$(Nbligne, "0000"))
        Inc nbligne
        intit = ""
      Endif
      Repeat
        Coldetail.Item.Selected = True
        Bloc = Coldetail.Item[16]
        l3 = Bloc
        Colitem0 = Coldetail.Item[0]
        Colitem1 = Coldetail.Item[1]
        Colitem9 = Coldetail.Item[9]
        Colitem16 = Coldetail.Item[16]
        If Coldetail.Item[9] <> "C" And If Coldetail.Item[9] <> "R" Then
          Try rMat = Utils.db.Exec("select * from " & Cbase.Table("TabTvav") & " where code_tva = &1", Coldetail.current[12])
          If rMat.available Then TauxTva = rMat!taux_tva
          Utils.db.Exec("INSERT INTO " & Tab & "(num_ligfac, numlig_ligfac, code_ligfac,  libel_ligfac, fam_ligfac, pu_ligfac, qte_ligfac, brut_ligfac, rem_ligfac, netht_ligfac, tx_ligfac, nettc_ligfac, typel_ligfac, tm_ligfac, bloc, mtx_ligfac) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15}, &{16})", Numfac, Format$(Nbligne, "0000"), Coldetail.Item[1], Coldetail.Item[2], Coldetail.Item[13], Coldetail.Item[3], Coldetail.Item[4], Coldetail.Item[5], Coldetail.Item[6], Coldetail.Item[7], Coldetail.Item[12], Coldetail.Item[8], Coldetail.Item[9], Coldetail.Item[10], Format$(Nbligne, "0000"), TauxTva)
        Else
          Repeat
            Coldetail.Item.Selected = True
            If Coldetail.current[9] = "C" Or If Coldetail.current[9] = "R" Then
              If Coldetail.current[16] <> l3 Then Break
              If lg = 1 Then intit = Intit & ("\n")
              intit = Intit & (Coldetail.Current[2])
              lg = 1
              Bloc = Coldetail.Item[16]
              If bloc <> l3 Then Break
            Else
              Break
            Endif
          Until Coldetail.Movenext()
          Utils.db.Exec("INSERT INTO " & Tab & "(num_ligfac, numlig_ligfac, code_ligfac, com_ligfac, typel_ligfac, bloc)VALUES (&1, &2, &3, &4, &5, &6)", numfac, Format$(Nbligne, "0000"), ColItem1, Intit, ColItem9, Format$(Nbligne, "0000"))
          Intit = ""
          lg = 0
          If Colitem0 <> Dlg Then Coldetail.MovePrevious()
        Endif
        If Gmateriel Then
          Try rmat = Utils.db.Exec("select * from " & Tmat & " where mat_bl = &1 and mat_code = &2", num.text, Coldetail.Item[1])
          If Not Error Then
            If rmat.Available Then
              Utils.db.Exec("UPdate  " & Tmat & "  SET mat_bl = &3 where mat_bl = &1 and mat_code = &2", num.text, Coldetail.Item[1], numfac)
            Endif
          Endif
        Endif
        Inc Nbligne
      Until Coldetail.Movenext()
    Endif
  End With
  
End

'**********************************************************
'*          Suppression du Bon à la demande               *
'**********************************************************
Public Sub Bl_Sup()
  
  Tab2 = "Fiches_LigblM" 
  Tab = "Fiches_BlM" 
  Utils.db.Exec("DELETE FROM " & tab & " where numbl = &1", num.Text)
  Utils.db.Exec("DELETE FROM " & tab2 & " where num_ligbl = &1", num.Text)
  CleanChamps()
  CleanChampsMat()
  Coldetail.Clear
  Bbon.Value = True
  Form_Open()
  
End

'*****************************************************
'*  Récuperation du dernier numéro d'écriture        *
'*****************************************************
Public Function Ecritures(numecr As String) As String
  
  Dim Params As Result
  Dim Tab As String
  Dim nro As String
  
  Tab = "Fiches_Parametres" 
  Params = Utils.db.Exec("SELECT " & numecr & " FROM " & Tab & " ")
  If Params.Available Then
    If IsNull(Params["" & numecr & ""]) Then
      nro = 0
    Else
      nro = Params["" & numecr & ""]
    Endif
  Endif
  Return nro
  
End

'************************************************
'*  Mise a jour du dernier numéro d'écriture    *
'************************************************
Public Sub Majnum()
  
  Dim Tab As String
  
  Tab = "Fiches_Parametres" 
  Utils.db.Exec("UPDATE " & Tab & " set numecriture = &1, numecriture2 = &2", numr, numr2)
  
End

'************************************************************************
'* Gestion des avoirs a partir d'une facture existante par le bouton    *
'************************************************************************
Public Sub ToggleButton5_Click()
  
  Nvc = 0
  Tab = "Fiches_HistoFacM" 
  ColFac.Clear
  Coldetail.clear
  If ColFac.Visible Then
    ColFac.Visible = False
  Else
    If Not IsNull(num.Text) And If Tottc.Text = "0,00" Then
      ColFac.Visible = True
      ColFac.Columns.count = 5
      ColFac.Columns[0].Width = 100
      ColFac.Columns[1].Width = 100
      ColFac.Columns[2].Width = 100
      ColFac.Columns[3].Width = 300
      ColFac.Columns[4].Width = 230
      ColFac.Columns[0].Text = "N° Fac"
      ColFac.Columns[0].Alignment = 2
      ColFac.Columns[1].Text = "Date"
      ColFac.Columns[1].Alignment = 2
      ColFac.Columns[2].Text = "Code"
      ColFac.Columns[2].Alignment = 4
      ColFac.Columns[3].Text = "Nom"
      ColFac.Columns[4].Alignment = 4
      ColFac.Columns[4].Text = "Montant"
      Coldetail3.Columns.count = 9
      Coldetail3.Columns[0].Width = 50
      Coldetail3.Columns[2].Alignment = Align.TopLeft
      Coldetail3.Columns[1].Width = 110
      Coldetail3.Columns[2].Width = 160
      Coldetail3.Columns[3].Width = 92
      Coldetail3.Columns[4].Width = 60
      Coldetail3.Columns[5].Width = 92
      Coldetail3.Columns[6].Width = 55
      Coldetail3.Columns[7].Width = 92
      Coldetail3.Columns[8].Width = 30
      Coldetail3.Columns[0].Text = "N° Lig"
      Coldetail3.Columns[1].Text = "Code"
      Coldetail3.Columns[2].Text = "Désignation"
      Coldetail3.Columns[3].Alignment = 2
      Coldetail3.Columns[3].Text = "Px Unitaire"
      Coldetail3.Columns[4].Alignment = 2
      Coldetail3.Columns[4].Text = "Qté/Tps"
      Coldetail3.Columns[5].Alignment = 2
      Coldetail3.Columns[5].Text = "Px brut"
      Coldetail3.Columns[6].Alignment = 2
      Coldetail3.Columns[6].Text = "Remise"
      Coldetail3.Columns[7].Alignment = 2
      Coldetail3.Columns[7].Text = "Px net"
      Coldetail3.Columns[8].Alignment = 4
      Coldetail3.Columns[8].Text = " TL "
      With utils
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where numfac order by numfac DESC")
        If rResult.Available Then
          Repeat
            ColFac.Add(rResult!numfac, rResult!numfac)
            ColFac.Item[0] = rResult!numfac
            ColFac.Item[1] = .Cdate_Aff(rResult!datefac)
            ColFac.Item[2] = rResult!cdclifac
            ColFac.Item[3] = rResult!nmclifac
            ColFac.Item[4] = rResult!totfac
          Until rResult.MoveNext()
          ColFac.MoveFirst
          ColFac.SetFocus
          ColFac.Item.Selected = True
        Endif
      End With
    Else
      Balloon.Warning(("Veuillez cliquer sur le bouton nouveau avant de saisir un avoir SVP "), Button2)
    Endif
  Endif
  
End

'*******************************************************
'* On récupère l'entete de la facture sélectionnée     *
'*******************************************************
Public Sub ColFac_Click()
  
  Tab = "Fiches_Parametres" 
  'CleanChamps()
  'rResult = Utils.db.Exec("SELECT * FROM " & Tab & " ")
  'IF rResult.Available THEN
  '  num.Text = rResult!dnbon
  'ENDIF
  'IF num.Text = "" THEN num.Text = "000000"
  'num.Text = Val(num.Text) + 1
  'num.Text = Format$(num.Text, "000000")
  'Utils.db.Exec("UPDATE  " & Tab & "  SET  dnbon = &1", num.Text)
  'Button2_Click()
  num2.Text = num.Text
  num3.Text = num.Text
  Tab = "Fiches_HistoFacM" 
  Tab2 = "Fiches_Cli" 
  Tab3 = "Fiches_Comptes" 
  numeroFac = ColFac.Current[0]
  With utils
    rResult = Utils.db.Exec("select * from " & Tab & " where numfac = &1", ColFac.Current[0])
    If rResult.Available Then
      'Datej.Text = .Cdate_Aff(rResult!datefac)
      'num.text = rResult!numfac
      Code.text = rResult!cdclifac
      Code3.Text = Code.Text
      Code4.Text = Code.Text
      Cv.Text = rResult!cvclifac
      Nom.text = rResult!nmclifac
      Nm.Text = Nom.Text
      Nm3.Text = Nom.Text
      Pnm.text = rResult!pnmclifac
      Adr1.text = rResult!adr1fac
      Adr2.text = rResult!adr2fac
      Cp.text = rResult!cpfac
      Burd.text = rResult!villefac
      Txmo.Text = Format$(Val(rResult!rmofac), "00.00")
      Txpieces.Text = Format$(Val(rResult!rartfac), "00.00")
    Endif
  End With
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Coldetail3.Clear
  Recup_ligfac()
  
End
'*******************************************************
'*  On Affiche les lignes de la facture sélectionnée   *
'*******************************************************

Public Sub Recup_ligfac()
  
  Dim rrResult As Result
  
  Tab2 = "Fiches_HistoLigfacM" 
  Tab3 = "Fiches_LigblM" 
  Totalmo = "0,00"
  Totalart = "0,00"
  Totalrem = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  Totmo.Text = "0,00"
  Totart.Text = "0,00"
  Totrem.Text = "0,00"
  Totht.Text = "0,00"
  Tottc.Text = "0,00"
  Tottva.Text = "0,00"
  Coldetail3.visible = True
  With utils
    rrResult = Utils.db.Exec("select * from " & Tab2 & " where num_ligfac = &1", numeroFac)
    If rrResult.Available Then
      Repeat
        Coldetail3.Add(rrResult!numlig_ligfac, rrResult!numlig_ligfac)
        Coldetail3.Item[0] = rrResult!numlig_ligfac
        Coldetail3.Item[1] = rrResult!code_ligfac
        If rrResult!typel_ligfac = "M" Then
          Totalmo = Format$(Val(Totalmo) + Val(.CPoint(rrResult!netht_ligfac)), "0.00")
        Endif
        If rrResult!typel_ligfac = "A" Then
          Totalart = Format$(Val(Totalart) + Val(.CPoint(rrResult!netht_ligfac)), "0.00")
        Endif
        If rrResult!typel_ligfac = "C" Or If Coldetail.Item[9] = "R" Then
          Coldetail3.Item[2] = rrResult!com_ligfac
          Coldetail3.Item[8] = rrResult!typel_ligfac
          Coldetail3.Item[17] = rrResult!bloc
        Else
          Coldetail3.Item[2] = rrResult!libel_ligfac
          Coldetail3.Item[3] = rrResult!pu_ligfac
          Coldetail3.Item[4] = rrResult!qte_ligfac
          Coldetail3.Item[5] = rrResult!brut_ligfac
          Coldetail3.Item[6] = rrResult!rem_ligfac
          Coldetail3.Item[7] = rrResult!netht_ligfac
          Coldetail3.Item[8] = rrResult!typel_ligfac
          Coldetail3.Item[10] = rrResult!tm_ligfac
          Coldetail3.Item[11] = rrResult!nettc_ligfac
          Coldetail3.Item[12] = rrResult!tx_ligfac
          Coldetail3.Item[13] = rrResult!fam_ligfac
          Coldetail3.Item[16] = rrResult!numlig_ligfac
          Coldetail3.Item[17] = rrResult!bloc
          ColFac.Visible = False
          With Utils
            If rrResult!typel_ligfac <> "E" And rrResult!typel_ligfac <> "T" Then
              Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(rrResult!brut_ligfac)) - Val(.CPoint(rrResult!netht_ligfac))), "0.00")
              Totalht = Format$(Val(.CPoint(Totalht)) + Val(.CPoint(rrResult!netht_ligfac)), "0.00")
              Totalttc = Format$(Val(.CPoint(Totalttc)) + Val(.CPoint(rrResult!nettc_ligfac)), "0.00")
            Endif
          End With
        Endif
      Until rrResult.MoveNext()
    Endif
    Totmo3.Text = Totalmo
    Totart3.Text = Totalart
    Totrem3.Text = Totalrem
    Totht3.Text = Totalht
    Tottc3.Text = Totalttc
    Tottva3.Text = Format$(Val(.CPoint(Tottc3.Text)) - Val(.CPoint(Totht3.Text)), "0.00")
  End With
  Coldetail3.Sorted = 0
  Panel6.Visible = True
  
End

'******************************************
'* On récupère les lignes sélectionnées   *
'******************************************
Public Sub Button20_Click()
  'Nligne AS String
  
  Nlgn = "0000"
  Coldetail.Clear
  Totalart = "0,00"
  Totalmo = "0,00"
  Totalrem = "0,00"
  Totalht = "0,00"
  Totalttc = "0,00"
  With Utils
    If Coldetail3.Available Then
      Coldetail3.MoveFirst()
      Repeat
        If Seltot.Value Or If Selpart.Value And Coldetail3.Item.Selected Then
          Importlig()
          Majligbl()
        Endif
      Until Coldetail3.MoveNext()
    Endif
    Totmo.Text = Totalmo
    Totart.Text = Totalart
    Totrem.Text = Totalrem
    Totht.Text = Totalht
    Tottc.Text = Totalttc
    Tottva.Text = Format$(Val(.CPoint(Tottc.Text)) - Val(.CPoint(Totht.Text)), "0.00")
    Panel6.Visible = False
    Panel5.Visible = True
    Nv = 1 'Permet de mettre a jour les parametres lors de l'appel de Button4_Click()
  End With
  Colbl_Click()
  If Panel8.visible = False Then
    Maj_Quantite2()
    'Else
    'Maj_QteDep2()
  Endif
  Button4_Click()
  
End

'*****************************************************************
'*     Calcul bas de facture et mise a jour table lignes de bl   *
'*****************************************************************
Public Sub Majligbl()
  
  With Utils
    If Coldetail3.Item[8] = "M" Then
      Totalmo = Format$(Val(Totalmo) + Val(.CPoint(Coldetail.Item[7])), "0.00")
      Utils.db.Exec("INSERT INTO " & tab3 & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, tm_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15})", num.Text, Coldetail.Item[0], Coldetail.Item[1], Coldetail.Item[2], Coldetail.Item[13], Coldetail.Item[3], Coldetail.Item[4], Coldetail.Item[5], Coldetail.Item[6], Coldetail.Item[7], Coldetail.Item[12], Coldetail.Item[8], Coldetail3.Item[8], Tm.Text, Coldetail3.Item[17])
    Endif
    If Coldetail3.Item[8] = "A" Or If Coldetail3.Item[8] = "E" Or If Coldetail3.Item[8] = "P" Then
      Totalart = Format$(Val(Totalart) + Val(.CPoint(Coldetail.Item[7])), "0.00")
      Utils.db.Exec("INSERT INTO " & tab3 & "(num_ligbl, numlig_ligbl,code_ligbl, libel_ligbl, fam_ligbl, pu_ligbl, qte_ligbl, brut_ligbl, rem_ligbl, netht_ligbl, tx_ligbl, nettc_ligbl, typel_ligbl, dec_ligbl, block_ligbl) VALUES (&1, &2, &3, &4, &5, &6, &7, &8, &9, &{10}, &{11}, &{12}, &{13}, &{14}, &{15})", num.Text, Coldetail.Item[0], Coldetail.Item[1], Coldetail.Item[2], Coldetail.Item[13], Coldetail.Item[3], Coldetail.Item[4], Coldetail.Item[5], Coldetail.Item[6], Coldetail.Item[7], Coldetail.Item[12], Coldetail.Item[8], Coldetail3.Item[8], Dec.Text, Coldetail3.Item[17])
    Endif
    If Coldetail3.Item[8] = "T" Then
      Utils.db.Exec("INSERT INTO " & Tab3 & "(num_ligbl, numlig_ligbl, code_ligbl, libel_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", num.Text, Coldetail.Item[0], Coldetail.Item[1], Coldetail.Item[2], Coldetail3.Item[8], Coldetail3.Item[17])
    Endif
    If Coldetail3.Item[8] = "C" Or If Coldetail.Item[9] = "R" Then
      Utils.db.Exec("INSERT INTO " & Tab3 & "(num_ligbl, numlig_ligbl, code_ligbl, com_ligbl, typel_ligbl, block_ligbl) VALUES (&1,&2,&3,&4, &5, &6)", num.Text, Coldetail.Item[0], Coldetail.Item[1], Coldetail.Item[2], Coldetail3.Item[8], Coldetail3.Item[17])
    Endif
    If Coldetail.Item[9] <> "C" And Coldetail.Item[9] <> "T" Then
      Totalrem = Format$(Val(.CPoint(Totalrem)) + (Val(.CPoint(Coldetail.Item[5])) - Val(.CPoint(Coldetail.Item[7]))), "0.00")
      Totalht = Format$(Val(Totalht) + Val(.CPoint(Coldetail.Item[7])), "0.00")
      Totalttc = Format$(Val(Totalttc) + Val(.CPoint(Coldetail.Item[8])), "0.00")
    Endif
  End With
  
End

'**********************************************************
'*     Importation des lignes de factures dans l'avoir    *
'**********************************************************
Public Sub Importlig()
  
  With utils
    Nlgn = Format$(Val(Nlgn) + 1, "0000")
    Coldetail.Add(Nlgn, Nlgn)
    Coldetail.Item[0] = Nlgn
    Coldetail.Item[1] = Coldetail3.Item[1]
    Coldetail.Item[2] = Coldetail3.Item[2]
    Coldetail.Item[3] = Coldetail3.Item[3]
    If Coldetail3.Item[4] <> "" And Left$(Coldetail3.Item[4]) <> "-" Then
      Coldetail.Item[4] = "-" & Format$(Val(Coldetail3.Item[4]), "0.00")
    Else
      If Coldetail3.Item[4] <> "" Then
        Coldetail.Item[4] = - Val(Coldetail3.Item[4])
        Coldetail.Item[4] = Format$(Coldetail.Item[4], "0.00")
      Endif
    Endif
    If Coldetail3.Item[5] <> "" And Left$(Coldetail3.Item[5]) <> "-" Then
      Coldetail.Item[5] = "-" & Format$(Val(Coldetail3.Item[5]), "0.00")
    Else
      If Coldetail3.Item[5] <> "" Then
        Coldetail.Item[5] = - Val(Coldetail3.Item[5])
        Coldetail.Item[5] = Format$(Coldetail.Item[5], "0.00")
      Endif
    Endif
    Coldetail.Item[6] = Coldetail3.Item[6]
    If Coldetail3.Item[7] <> "" And Left$(Coldetail3.Item[7]) <> "-" Then
      Coldetail.Item[7] = "-" & Format$(Val(Coldetail3.Item[7]), "0.00")
    Else
      If Coldetail3.Item[7] <> "" Then
        Coldetail.Item[7] = - Val(Coldetail3.Item[7])
        Coldetail.Item[7] = Format$(Coldetail.Item[7], "0.00")
      Endif
    Endif
    Coldetail.Item[9] = Coldetail3.Item[8]
    Coldetail.Item[10] = Coldetail3.Item[10]
    If Coldetail3.Item[11] <> "" And Left$(Coldetail3.Item[11]) <> "-" Then
      Coldetail.Item[8] = "-" & Format$(Val(Coldetail3.Item[11]), "0.00")
    Else
      If Coldetail3.Item[11] <> "" Then
        Coldetail.Item[8] = - Val(Coldetail3.Item[11])
        Coldetail.Item[8] = Format$(Coldetail.Item[8], "0.00")
      Endif
    Endif
    Coldetail.Item[16] = Coldetail3.Item[16]
    Coldetail.Item[12] = Coldetail3.Item[12]
    Coldetail.Item[13] = Coldetail3.Item[13]
    Coldetail.Item[17] = Coldetail3.Item[17]
    
  End With
  'Ren_ligbl()
  Coldetail.MoveLast()
  Coldetail.Item.Selected = True
  Nlgart.Text = Format$(Val(Coldetail.Current[0]) + 1, "0000")
  
End

'*******************************************************
'* On ferme la fenetre des avoirs avec Escape ou F2    *
'*******************************************************
Public Sub ColFac_Keypress()
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    ColFac.Clear
    ColFac.Visible = False
    TextBox1.SetFocus
    TextBox1.Select
    Stop Event
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
End
'**********************************************************
'* On ferme la fenetre des avoirs avec bouton Quitter     *
'**********************************************************

Public Sub Button17_Click()
  
  ColFac.Clear
  ColFac.Visible = False
  Coldetail3.clear
  Coldetail3.Visible = False
  Panel6.Visible = False
  TextBox1.SetFocus
  TextBox1.Select
  
End

Public Sub OBS_KeyPress()
  'IF Key.Code = Key.F5 THEN Calc.run()
  
End

'PUBLIC FUNCTION IsValidKey() AS Boolean

'  IF Key.Code = Key.F1 THEN Button5_Click()
'  RETURN key.code = key.Return OR key.code = key.Enter OR key.code = key.Tab OR key.code = key.BackTab OR $bForceKey

'END

Public Sub SetObservers(hClass As Object, hCont As Container)
  
  Dim hCtrl As Object
  Dim hOBS As Observer
  
  For Each hCtrl In hCont.Children
    If hCtrl Is TextBox Then
      hOBS = New Observer(hCtrl) As "OBS"
    Endif
    If hCtrl Is Container Then SetObservers(hClass, hCtrl)
  Next
  
End

'******************************************* Gestion des clients *************************************************
'**********************************************************
'*      Le bouton sert a rechercher les clients           *
'**********************************************************
Public Sub ToggleButton1_click()
  
  If Impfac = "0" Then
    SelectionClient()
  Else
    Balloon.Warning(("La facture a été imprimée ! Modification de client impossible."), Code)
  Endif
  
End

'**********************************************************
'*       On recupere les données du compte saisi          *
'**********************************************************
Public Sub compteMan()
  
  Tab = "Fiches_Cli" 
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where cli_code = &1", Code.Text)
  With Utils
    If rResult.available Then
      Code3.Text = Code.Text
      Nom.Text = rResult!cli_nom
      Pnm.Text = rResult!cli_pnm
      Adr1.Text = rResult!cli_adr1
      Adr2.Text = rResult!cli_adr2
      Cp.Text = rResult!cli_cd_ptl
      Burd.Text = rResult!cli_ville
      Telbur.Text = rResult!cli_tel_bur
      TelDom.Text = rResult!cli_tel_dom
      Telport.Text = rResult!cli_pble
      Divers.Text = rResult!cli_obs
      Txmo.Text = rResult!cli_rmo
      Txpieces.Text = rResult!cli_rart
      Exo.Value = rResult!cli_exo
      Encours = rResult!cli_plaf_ecrs
      If Settings["/Soc" & Start.Societe & "/AutoEnt"] Then Exo.Value = True
      Cv.Text = rResult!cli_rs_soc
      If Not IsNull(rResult!cli_cdech) Then
        Ech = rResult!cli_cdech
        dtef.Text = Format$(Now, "dd.mm.yyyy")
        Dtech.text = dateEcheance(Ech)
      Endif
    Else
      If Son Then
        Music.Play
      Endif
      Try Message.Warning("Attention ! Veuillez saisir un compte existant SVP.", "Ok")
      b = 1
    Endif
    Tab = "Fiches_Comptes" 
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & " where compte_cc = &1", Code.text)
    If rResult.Available Then
      Try solde.text = Format$(rResult!solde, "0.00")
      If Val(solde.Text) > 0 Then
        code.Background = &HF51B03&
      Else
        Code.Background = Color.TextBackground
      Endif
      Soldecompte = Val(Utils.cpoint(solde.text))
    Endif
    If IsNull(Encours) Then encours = "0"
    Verif_Encours()
  End With
  
End

'******************************************
'*      Selection du  code client         *
'******************************************
Public Sub Cli_man()
  
  Dim Clitab As Result
  Dim Tabcli As String
  Dim Comptab As Result
  Dim Tabcompt As String
  Dim skey As Integer = 0
  
  Tabcli = "Fiches_Cli" 
  Tabcompt = "Fiches_Comptes" 
  Tribl = "numbl"
  Try Clitab = Utils.db.Exec("SELECT * FROM " & tabcli & " where cli_code = &1", code.Text)
  If Not Error Then
    Code.Text = Clitab!cli_code
    Code3.Text = Code.Text
    Nom.Text = Clitab!cli_nom
    Pnm.Text = Clitab!cli_pnm
    num2.Text = num.Text
    Nm.Text = Nom.Text
    Adr1.Text = Clitab!cli_adr1
    Adr2.Text = Clitab!cli_adr2
    Cp.Text = Clitab!cli_cd_ptl
    Burd.Text = Clitab!cli_ville
    Telbur.Text = Clitab!cli_tel_bur
    Teldom.Text = Clitab!cli_tel_dom
    Telport.Text = Clitab!cli_pble
    Divers.Text = Clitab!cli_obs
    Txmo.Text = Clitab!cli_rmo
    Txpieces.Text = Clitab!cli_rart
    Courriel.Text = Clitab!cli_email
    Typec = Clitab!cli_typec
    Cdivers = Clitab!cli_div
    TvaCli = Clitab!cli_id_tva
    If Not IsNull(Clitab!cli_cdech) Then
      Ech = Clitab!cli_cdech
      dtef.Text = Format$(Now, "dd.mm.yyyy")
      Dtech.text = dateEcheance(Ech)
    Endif
    Try Exo.Value = Clitab!cli_exo
    Cv.Text = Clitab!cli_rs_soc
    Comptab = Utils.db.Exec("SELECT * FROM " & Tabcompt & " where compte_cc = &1", Code.text)
    If Comptab.Available Then
      If Comptab!solde <> "" Then
        solde.text = Format$(Comptab!solde, "0.00")
      Else
        solde.Text = "0,00"
      Endif
    Endif
  Endif
  Try Clitab = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabContact") & " where code = &1", Code.Text)
  If Not Error Then
    If Clitab.Available Then
      Do
        Inc skey
        courriel.Add(Clitab!mail, skey)
      Loop Until Clitab.MoveNext()
    Endif
  Endif
  Button4_Click()
  Try colbl[colbl.row, 4].Text = Code.Text
  Try colbl[colbl.row, 5].Text = Nom.Text
  Try colbl[colbl.row, 6].Text = Pnm.Text
  If Cdivers Then
    Cv.SetFocus
  Else
    Button13.SetFocus
  Endif
  
End
'**********************************************************
'*                 Gestion onglet Saisie Articles         *
'**********************************************************

Public Sub SelectionClient()
  
  Dim MyForm As Triclients
  
  bsel = False
  ChkFocus = 2
  MyForm = New Triclients("FactureMat")
  MyForm.Showmodal()
  If Bsel = True Then
    Code.text = Codeclient
    Cli_Man()
  Else
    Code.SetFocus
  Endif
  
End

Public Sub Tva_change()
  
  Select Case Last.tag
    Case 1
      
  End Select
  
End

'* * * * * * * * * * * * * * * * * * * * * * * *
'*   Génération du columnview des écritures    *
'***********************************************
Public Sub ToggleButton7_Click()
  
  Dim TabEcr As String
  Dim ecrlet As Result
  
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  
  Music.Load(Start.Musique)
  Me.Center
  TabEcr = "Fiches_Mvt" 
  Coldetail2.Columns.count = 7
  Coldetail2.Columns[0].Width = 80
  Coldetail2.Columns[1].Width = 200
  Coldetail2.Columns[2].Width = 100
  Coldetail2.Columns[3].Width = 100
  Coldetail2.Columns[4].Width = 95
  Coldetail2.Columns[5].Width = 95
  Coldetail2.Columns[0].Text = "Date"
  Coldetail2.Columns[1].Text = "Nom"
  Coldetail2.Columns[2].Text = "Document"
  Coldetail2.Columns[3].Text = "Lot"
  Coldetail2.Columns[4].Alignment = 2
  Coldetail2.Columns[4].Text = "Débit"
  Coldetail2.Columns[5].Alignment = 2
  Coldetail2.Columns[5].Text = "Crédit"
  If Coldetail2.Visible = True Then
    Coldetail2.Clear
    Coldetail2.Visible = False
  Else
    Coldetail2.Clear
    Coldetail2.Visible = True
  Endif
  ecrlet = Utils.db.Exec("SELECT * FROM " & TabEcr & " WHERE compte = &1 and lettree = &2  and validee = &3 order by dte", code.text, 0, 1)
  If ecrlet.Available Then
    Repeat
      Coldetail2.Add(ecrlet!numdoc & ecrlet!lind, ecrlet!numdoc)
      Coldetail2.Item[0] = Utils.Cdate_Aff(ecrlet!dte)
      Coldetail2.Item[1] = ecrlet!intitule
      Coldetail2.Item[2] = ecrlet!numdoc
      Coldetail2.Item[3] = ecrlet!numlot
      Coldetail2.Item[4] = Format$(ecrlet!montantd, "0.00")
      Coldetail2.Item[5] = Format$(ecrlet!montantc, "0.00")
    Until ecrlet.MoveNext()
  Else
  Endif
  
End

Public Sub Rgmt_Click()
  
  If HBox5.Visible = False Then
    HBox5.visible = True
  Else
    HBox5.visible = False
  Endif
  
End

Public Sub Regmt_Change()
  
  If Regmt.text = "Virement" Or If Regmt.text = "Traite" Then
    Rglt.clear
    Rglt.ReadOnly = True
  Else
    Rglt.ReadOnly = False
    Rglt.Text = Tottc.text
  Endif
  
End

'*********************************    Gestion du matériel   ****************************************************

Public Sub Tabstrip1_click()
  
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  Numserie.SetFocus
  
End

'*******************************************
'*   On appelle la liste des matériels     *
'*******************************************
Public Sub ToggleButton10_Click()
  
  Dim MatResult As Result
  Dim TabMat As String
  
  Tabmat = "Fiches_Materiels" 
  Matlist.Clear
  If Matlist.Visible Then
    Matlist.Visible = False
  Else
    Matlist.Visible = True
    With Matlist
      .Columns.count = 5
      .Columns[0].Width = 120
      .Columns[1].Width = 380
      .Columns[2].Width = 160
      .Columns[3].Width = 160
      .Columns[4].Width = 10
      .Columns[2].Alignment = 4
      .Columns[0].Text = "Numéro série"
      .Columns[1].Text = "Intitulé"
      .Columns[2].Text = "Marque"
      .Columns[3].Text = "Type"
      .Columns[4].Text = "Div"
    End With
    MatResult = Utils.db.Exec("SELECT * FROM " & Tabmat & " where mat_cli = &1 order by CAST(mat_serie AS char)", code.text)
    If Not MatResult.Available Then
      MatResult = Utils.db.Exec("SELECT * FROM " & Tabmat & " where mat_matdiv <> &1 order by CAST(mat_serie AS char)", 0)
    Endif
    If MatResult.Available Then
      Do
        Matlist.Add(MatResult!mat_serie & MatResult!mat_code, MatResult!mat_serie & MatResult!mat_code)
        Matlist.Item[0] = MatResult!mat_serie
        Matlist.Item[1] = MatResult!mat_design
        Matlist.Item[2] = MatResult!mat_marque
        Matlist.Item[3] = MatResult!mat_type
        If MatResult!mat_matdiv = "0" Then
          Matlist.Item[4] = "N"
        Else
          Matlist.Item[4] = "O"
        Endif
      Loop Until MatResult.MoveNext()
    Else
      If son Then
        Music.Play
      Endif
      Try Message.Warning("Ce client ne possède aucun matériel ! ")
      Matlist.Clear
      Matlist.visible = False
    Endif
    If Matlist.Count Then
      Matlist.MoveFirst
      Matlist.SetFocus
      Matlist.Item.Selected = True
    Endif
  Endif
  
End

'*******************************************
'*  Saisie d'un materiel a la souris        *
'*******************************************
Public Sub Matlist_Click()
  
  Numserie.Text = Matlist.Current[0]
  Matlist.Clear
  Matlist.visible = False
  MatMan()
  
End

'*******************************************
'* Saisie d'un materiel manuellement        *
'*******************************************
Public Sub Matlist_KeyPress()
  
  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Numserie.Text = Matlist.Current[0]
    Matlist.Clear
    Matlist.visible = False
    MatMan()
  Endif
  
  If key.code = key.F1 Then
    Button7_Click()
    Stop Event
  Endif
  
  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Matlist.visible = False
    Matlist.clear
  Endif
  
End

'*************************************************
'* Saisie d'un code materiel manuellement         *
'*************************************************
Public Sub matman()
  
  Dim rmat As Result
  Dim TabMat As String
  Dim matdiv As Boolean = True
  
  Tabmat = "Fiches_Materiels" 
  With utils
    rmat = Utils.db.Exec("SELECT * FROM " & Tabmat & " where mat_serie = &1", Numserie.Text)
    If rmat.Available Then
      Numserie.Text = rmat!mat_serie
      CodeP.Text = rmat!mat_code
      Desg.text = rmat!mat_design
      Desg2.Text = rmat!mat_design2
      Marque.Text = rmat!mat_marque
      Typemat.text = rmat!mat_type
      Matdiv = rmat!mat_matdiv
      Prvt.text = rmat!mat_prvt
      If matdiv = True Then
        Numserie.ReadOnly = False
        Desg.ReadOnly = False
        Desg2.ReadOnly = False
        Marque.ReadOnly = False
        Typemat.ReadOnly = False
      Else
        Numserie.ReadOnly = True
        Desg.ReadOnly = True
        Desg2.ReadOnly = True
        Marque.ReadOnly = True
        Typemat.ReadOnly = True
      Endif
    Endif
  End With
  
End

Public Sub CleanChampsMat()
  
  Numserie.Clear
  CodeP.Clear
  Desg.Clear
  Desg2.Clear
  Marque.Clear
  Typemat.Clear
  LibelleMat.Clear
  
End

Public Sub Mat_keypress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        Desg.SetFocus
        Desg.Select
        
      Case 2
        Desg2.SetFocus
        Desg2.Select
        
      Case 3
        Marque.SetFocus
        Marque.Select
        
      Case 4
        typemat.setfocus
        Typemat.Select
        
      Case 5
        LibelleMat.SetFocus
        
        Stop Event
    End Select
  End If
  
End

Public Sub Mat_lostfocus()
  
  Select Case Last.tag
    Case 1
      matman()
      
  End Select
  
End

Public Sub Mat_GotFocus()
  
  If Last.ReadOnly = False Then Utils.SetEditColor(Me, Last)
  
End

'*********************************** On gère l'envoi du document par mail *******************************************

Public Sub Button31_Click()
  
  Dim sText As String
  Dim sText2 As String
  Dim sCourriel As String
  Dim Ty As String
  
  With Utils
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTmail") & "")
    If rResult.Available Then
      sText2 = Replace$(rResult!intitule, "*", sText)
    Else
      Stext2 = "Bonjour,\nVeuillez trouver ci-joint votre document.\nCordialement."
    Endif
    If Tp = "C" Then sText = "Commande"
    If Tp = "B" Then sText = "Bon"
    If Tp = "D" Then sText = "Devis"
    If Tp = "P" Then sText = "Proforma"
    If Tp = "F" Then sText = "Facture"
    If Bfac.value And Visudoc = False Then
      Ty = Nmfac
    Else
      Ty = num.Text
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabTmail") & "")
    If rResult.Available Then
      sText2 = Replace$(rResult!intitule, "*", sText)
      If Not IsNull(sVendeur.Text) Then
        sText2 = Replace$(sText2, "§", sVendeur.Text)
      Else
        sText2 = Replace$(sText2, "§", "")
      Endif
    Else
      Stext2 = "Bonjour,\n\nVeuillez trouver ci-joint votre " & sText & " No " & ty & " du " & Dtef.Text & ".\n\nCordialement."
    Endif
    Visudoc = True
    If Bfac.value And imp = "0" Then
      If start.son Then
        Music.Play
      Endif
      Message.Info("L'envoi d'un document de type Facture ne peut se faire\nque si l'impression a été effectuée !\nVeuillez imprimer votre facture avant de l'envoyer en pièce jointe.")
    Else
      If Not IsNull(Courriel.text) Then
        scourriel = Courriel.Text
        Impression("Mail")
        Me.mouse = Mouse.Wait
        Wait 0.5
        'Exec ["xdg-email", "--attach", sPiece, "--subject", sText, "--body", sText2, sCourriel]
        EnvMail.Envoi2(scourriel, stext, sText2, spiece)
        Wait 0.5
        Me.mouse = Mouse.Default
        Courriel.Text = sCourriel
        Button10_Click()
      Else
        Music.Play
        Message.Error("L'adresse mail du client n'a pas été renseignée! Envoi impossible.")
      Endif
    Endif
    
  End With
  
End

'**********************************************
'*     Affichage de la documentation Html     *
'**********************************************
Public Sub Button7_Click()
  
  Exec ["xdg-open", Application.Path &/ "Ecrans/Materiels.html"]
  
End
