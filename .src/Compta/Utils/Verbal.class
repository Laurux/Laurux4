' Gambas class file

' Gambas CLASS file
'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : Verbal.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 24/01/2007
'# Vérification du solde des balances
'################################################

Private TotSldHP As Float
Private debit As Float
Private credit As Float
Private dte As String
Private dte1 As String
Private dte2 As String
Private Txt As String
Private jour As String
Private Compt As String
Private son As Integer = Start.Son

'*************************
'* On initialise l'écran *
'*************************
Public Sub _New()
  
  If Settings["/Soc" & Start.Societe & "/Coul_fen"] Then Utils.Observers(Me)
  
  Music.Load(Start.Musique)
  Me.Center
  Dclient.Text = "0,00"
  Cclient.Text = "0,00"
  Sclient.Text = "0,00"
  Cfournisseur.Text = "0,00"
  Dfournisseur.Text = "0,00"
  Sfournisseur.Text = "0,00"
  Dgestion.Text = "0,00"
  Cgestion.Text = "0,00"
  Sgestion.Text = "0,00"
  Dbilan.Text = "0,00"
  Cbilan.Text = "0,00"
  Sbilan.Text = "0,00"
  Dgenerale.Text = "0,00"
  Cgenerale.Text = "0,00"
  Sgenerale.Text = "0,00"
  Dbclient.Text = "0,00"
  Cbclient.Text = "0,00"
  Sbclient.Text = "0,00"
  Dbfournisseur.Text = "0,00"
  Cbfournisseur.Text = "0,00"
  Sbfournisseur.Text = "0,00"
  compt = "0"
  jour = Format$(Now, "dd.mm.yyyy")
  Ex1()
  If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) > Right$(dteN1.Text, 4) & Mid$(dteN1.Text, 4, 2) & Left$(dteN1.Text, 2) Then
    Ex1()
    dteN0.Text = dteN1.Text
    dteN1.Text = jour
  Else
    exo()
  Endif
  dteN0.SetFocus
  dteN0.Select
  
End

'*****************************************
'*     On récupère nos dates par défaut  *
'*****************************************
Public Sub date1()
  
  Dim rResult As Result
  Dim Tab As String
  
  Tab = "Fiches_Parametres" 
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec1
    dteN0.Text = .Calc_mois(dte)
    dte = rResult!dteclec
    dteN1.Text = .Cdate_aff(dte)
  End With
  
End

'***********************
'* On gere nos touches *
'***********************
Public Sub Cmpt_KeyPress()
  
  If Key.code = Key.enter Or Key.code = Key.return Or Key.code = Key.Tab Then
    Select Case Last.tag
        
      Case 1
        dteN0_LF()
        dteN1.SetFocus
        dteN1.Select
        Stop Event
        
      Case 2
        dteN1_LF()
        dteN0.SetFocus
        dteN0.Select
        Stop Event
        
    End Select
  Endif
  
End
'***********************
'* On gere nos boutons *
'***********************

Public Sub Btn_Click()
  
  Select Case Last.tag
      
    Case 2
      Button2_Click()
      
    Case 3
      Dclient.Clear
      Cclient.Clear
      Sclient.Clear
      Cfournisseur.Clear
      Dfournisseur.Clear
      Sfournisseur.Clear
      Dgestion.Clear
      Cgestion.Clear
      Sgestion.Clear
      Dbilan.Clear
      Cbilan.Clear
      Sbilan.Clear
      Dgenerale.Clear
      Cgenerale.Clear
      Sgenerale.Clear
      Dbclient.Clear
      Cbclient.Clear
      Sbclient.Clear
      Dbfournisseur.Clear
      Cbfournisseur.Clear
      Sbfournisseur.Clear
      Me.Close
      
  End Select
  
End

'****************************************************
'*      Gestion du focus. Routine de Charlie Reinl  *
'****************************************************
Public Sub Cmpt_GotFocus()
  
  With Utils
    .SetEditColor(Me, Last)
  End With
  If Sgenerale.Text <> "0,00" Then
    Sgenerale.Background = &HF51B03&
  Else
    Sgenerale.Background = &HD4D0C8&
  Endif
  
End

'*****************************************
'* On travaille avec l'exercice en cours *
'*****************************************
Public Sub Ex1()
  
  Dim rResult As Result
  Dim Tab As String
  
  Tab = "Fiches_Parametres" 
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec ' On recupere la date de fin d'exercice
    dteN0.Text = .Calc_mois(dte)
    ''dteN0.Text = .Cdate_affdata(dte)
    jour = Format$(Now, "dd.mm.yyyy")
    If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) < Right$(dteN0.Text, 4) & Mid$(dteN0.Text, 4, 2) & Left$(dteN0.Text, 2) Then
      Exo()
    Else
      dteN1.Text = jour
      dte1 = dteN0.Text
      dte2 = dteN1.Text
    Endif
  End With
  
End

'***********************************************************
'*     On travaille avec l'excercice en cours de bilan     *
'***********************************************************
Public Sub Exo()
  
  Dim rResult As Result
  Dim Tab As String
  
  Tab = "Fiches_Parametres" 
  With utils
    rResult = Utils.db.Exec("SELECT * FROM " & Tab & "")
    dte = rResult!dteclec1
    dteN0.Text = .Calc_mois(dte)
    dte = rResult!dteclec
    dteN1.Text = .Cdate_aff(dte)
    dte1 = dteN0.Text
    dte2 = dteN1.Text
  End With
  
End

'***********************
'*  On gere la date 1  *
'***********************
Public Sub dteN0_LF()
  
  With utils
    dteN0.text = .Cdate_calc(dteN0.Text)
    dteN0.Text = .Cdate_aff(dteN0.Text)
    If dteN0.Text = "00.00.0:00" Then dteN0.Text = Format$(Now, "dd.mm.yyyy")
  End With
  If Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période en cours."
    Compdate()
  Else
    If Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) > Val(Right$(dte2, 4) + 1 & Mid$(dte2, 4, 2) & Left$(dte2, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à la fin de la période autorisée."
      Compdate()
    Endif
  Endif
  dteN1.setfocus
  dteN1.Select
Catch
  dteN0.setfocus
  dteN0.Select
  
End

'***********************
'*  On gere la date 2  *
'***********************
Public Sub dteN1_LF()
  
  With utils
    dteN1.text = .Cdate_calc(dteN1.Text)
    dteN1.Text = .Cdate_aff(dteN1.Text)
    If dteN1.Text = "00.00.0:00" Then dteN1.Text = Format$(Now, "dd.mm.yyyy")
  End With
  If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) < Val(Right$(dte1, 4) & Mid$(dte1, 4, 2) & Left$(dte1, 2)) Then
    Txt = "Attention ! La date saisie est inférieure au début de la période en cours."
    Compdate2()
  Else
    If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) > Val(Right$(dte2, 4) + 1 & Mid$(dte2, 4, 2) & Left$(dte2, 2)) Then
      Txt = "Attention ! La date saisie est supérieure à la fin de la période autorisée."
      Compdate2()
    Endif
  Endif
  
  If Val(Right$(dteN1.text, 4) & Mid$(dteN1.text, 4, 2) & Left$(dteN1.text, 2)) < Val(Right$(dteN0.text, 4) & Mid$(dteN0.text, 4, 2) & Left$(dteN0.text, 2)) Then
    If son Then
      Music.Play
    Endif
    If Message.Warning("Attention ! Votre selection n'est pas possible.", "Ok") = 1 Then
    Endif
  Endif
Catch
  dteN1.setfocus
  dteN1.Select
  
End

Public Sub Compdate()
  
  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) > Right$(dteN0.Text, 4) & Mid$(dteN0.Text, 4, 2) & Left$(dteN0.Text, 2) Then
      Ex1()
    Else
      exo()
    Endif
  Endif
  
End

Public Sub compdate2()
  
  If son Then
    Music.Play
  Endif
  If Message.Warning(Txt, "Ok") = 1 Then
    If Right$(jour, 4) & Mid$(jour, 4, 2) & Left$(jour, 2) < Right$(dteN1.Text, 4) & Mid$(dteN1.Text, 4, 2) & Left$(dteN1.Text, 2) Then
      Ex1()
    Else
      exo()
    Endif
  Endif
  
End

'******************
'*   On calcule   *
'******************
Public Sub Button2_Click()
  
  Dim i As Integer
  Dim rResult As Result
  Dim rrResult As Result
  Dim Tab As String
  Dim Tab2 As String
  Dim type As String
  Dim Col As String
  
  totsldhp = 0.00
  Dclient.Text = "0,00"
  Cclient.Text = "0,00"
  Sclient.Text = "0,00"
  Cfournisseur.Text = "0,00"
  Dfournisseur.Text = "0,00"
  Sfournisseur.Text = "0,00"
  Dgestion.Text = "0,00"
  Cgestion.Text = "0,00"
  Sgestion.Text = "0,00"
  Dbilan.Text = "0,00"
  Cbilan.Text = "0,00"
  Sbilan.Text = "0,00"
  Dgenerale.Text = "0,00"
  Cgenerale.Text = "0,00"
  Sgenerale.Text = "0,00"
  Dbclient.Text = "0,00"
  Cbclient.Text = "0,00"
  Sbclient.Text = "0,00"
  Dbfournisseur.Text = "0,00"
  Cbfournisseur.Text = "0,00"
  Sbfournisseur.Text = "0,00"
  Tab = "Fiches_Mvt" 
  Tab2 = "Fiches_Comptes" 
  With Utils
    Me.Mouse = Mouse.Wait
    rrResult = Utils.db.Exec("SELECT * FROM " & Tab2 & " order by cast(compte_cc AS char)")
    If rrResult.Available Then
      Repeat
        compt = rrResult!compte_cc
        type = rrResult!type_cc
        Col = rrResult!coll
        rResult = Utils.db.Exec("SELECT * FROM " & Tab & " WHERE compte = &1  and validee = &2 and dte >= &3 and dte <= &4", compt, 1, .Cdate_Dbase(dteN0.Text), .Cdate_Dbase(dteN1.Text))
        If rResult.count <> 0 Then
          i = 0
          While i < rResult.count
            debit = rResult!montantd
            credit = rResult!montantc
            If debit = Null Then debit = 0
            If credit = Null Then credit = 0
            
            If type = "C" Then
              Dbclient.Text = Format$(Val(.cpoint(Dbclient.Text)) + debit, "0.00")
              Cbclient.Text = Format$(Val(.cpoint(Cbclient.Text)) + credit, "0.00")
              Sbclient.Text = Format$(Val(.cpoint(Dbclient.Text)) - Val(.cpoint(Cbclient.Text)), "0.00")
            Endif
            
            If type = "F" Then
              Dbfournisseur.Text = Format$(Val(.cpoint(Dbfournisseur.Text)) + debit, "0.00")
              Cbfournisseur.Text = Format$(Val(.cpoint(Cbfournisseur.Text)) + credit, "0.00")
              Sbfournisseur.Text = Format$(Val(.cpoint(Dbfournisseur.Text)) - Val(.cpoint(Cbfournisseur.Text)), "0.00")
            Endif
            
            If type = "G" Then
              Dgestion.Text = Format$(Val(.cpoint(Dgestion.Text)) + debit, "0.00")
              Cgestion.Text = Format$(Val(.cpoint(Cgestion.Text)) + credit, "0.00")
              Sgestion.Text = Format$(Val(.cpoint(Dgestion.Text)) - Val(.cpoint(Cgestion.Text)), "0.00")
            Endif
            
            If type = "B" Then
              Dbilan.Text = Format$(Val(.cpoint(Dbilan.Text)) + debit, "0.00")
              Cbilan.Text = Format$(Val(.cpoint(Cbilan.Text)) + credit, "0.00")
              Sbilan.Text = Format$(Val(.cpoint(Dbilan.Text)) - Val(.cpoint(Cbilan.Text)), "0.00")
            Endif
            
            If type = "B" And Col = "1" And Left$(Compt, 2) = "41" Then
              Dclient.Text = Format$(Val(.cpoint(Dclient.Text)) + debit, "0.00")
              Cclient.Text = Format$(Val(.cpoint(Cclient.Text)) + credit, "0.00")
              Sclient.Text = Format$(Val(.cpoint(Dclient.Text)) - Val(.cpoint(Cclient.Text)), "0.00")
            Endif
            
            If type = "B" And Col = "1" And Left$(Compt, 2) = "40" Then
              Dfournisseur.Text = Format$(Val(.cpoint(Dfournisseur.Text)) + debit, "0.00")
              Cfournisseur.Text = Format$(Val(.cpoint(Cfournisseur.Text)) + credit, "0.00")
              Sfournisseur.Text = Format$(Val(.cpoint(Dfournisseur.Text)) - Val(.cpoint(Cfournisseur.Text)), "0.00")
            Endif
            
            Inc i
            rResult.MoveNext
          Wend
        Endif
      Until rrResult.MoveNext()
      Dgenerale.Text = Format$(Val(.cpoint(Dgestion.Text)) + Val(.cpoint(Dbilan.Text)), "0.00")
      Cgenerale.Text = Format$(Val(.cpoint(Cgestion.Text)) + Val(.cpoint(Cbilan.Text)), "0.00")
      Sgenerale.Text = Format$(Val(.cpoint(Dgenerale.Text)) - Val(.cpoint(Cgenerale.Text)), "0.00")
      If Sgenerale.Text <> "0,00" Then 
        Sgenerale.Background = &hFF1E1E&
        Syntheses.Message("Attention ! Votre balance n'est pas équilibrée.")
      Endif
    Else
    Endif
  End With
  Me.Mouse = Mouse.Default
  If son Then
    Music.Play
  Endif
  message.Info(" Traitement terminé", "OK")
  
End
